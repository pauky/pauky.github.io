<!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta name="description" content="Talk about the network models in k8s."><meta name="keywords" content="cloud-native"><meta name="author" content="杨润炜"><meta name="copyright" content="杨润炜"><title>K8S Network Model | Cwalker</title><link rel="shortcut icon" href="/melody-favicon.ico"><link rel="stylesheet" href="/css/index.css?version=1.9.0"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@latest/css/font-awesome.min.css?version=1.9.0"><meta name="format-detection" content="telephone=no"><meta http-equiv="x-dns-prefetch-control" content="on"><link rel="dns-prefetch" href="https://cdn.jsdelivr.net"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  copy: {
    success: 'Copy successfully',
    error: 'Copy error',
    noSupport: 'The browser does not support'
  },
  hexoVersion: '6.1.0'
} </script><meta name="generator" content="Hexo 6.1.0"></head><body><i class="fa fa-arrow-right" id="toggle-sidebar" aria-hidden="true"></i><div id="sidebar" data-display="true"><div class="toggle-sidebar-info text-center"><span data-toggle="Toggle article">Toggle site</span><hr></div><div class="sidebar-toc"><div class="sidebar-toc__title">Catalog</div><div class="sidebar-toc__progress"><span class="progress-notice">You've read</span><span class="progress-num">0</span><span class="progress-percentage">%</span><div class="sidebar-toc__progress-bar"></div></div><div class="sidebar-toc__content"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#Single-Host"><span class="toc-number">1.</span> <span class="toc-text">Single Host</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Multi-Hosts"><span class="toc-number">2.</span> <span class="toc-text">Multi Hosts</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#UDP"><span class="toc-number">2.1.</span> <span class="toc-text">UDP</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#VXLAN"><span class="toc-number">2.2.</span> <span class="toc-text">VXLAN</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Why-vxlan-use-UDP-but-not-tcp-or-ip"><span class="toc-number">2.2.1.</span> <span class="toc-text">Why vxlan use UDP but not tcp or ip?</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Why-we-need-virtual-Layer-2-network"><span class="toc-number">2.2.2.</span> <span class="toc-text">Why we need virtual Layer 2 network?</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#vxlan-eBPF"><span class="toc-number">2.3.</span> <span class="toc-text">vxlan+eBPF</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Host-GW"><span class="toc-number">3.</span> <span class="toc-text">Host-GW</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Single-LAN"><span class="toc-number">3.1.</span> <span class="toc-text">Single LAN</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Multi-LAN"><span class="toc-number">3.2.</span> <span class="toc-text">Multi LAN</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#IPIP"><span class="toc-number">3.2.1.</span> <span class="toc-text">IPIP</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#BGP"><span class="toc-number">3.2.2.</span> <span class="toc-text">BGP</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Reference"><span class="toc-number">4.</span> <span class="toc-text">Reference</span></a></li></ol></div></div><div class="author-info hide"><div class="author-info__avatar text-center"><img src="/img/avatar.png"></div><div class="author-info__name text-center">杨润炜</div><div class="author-info__description text-center"></div><hr><div class="author-info-articles"><a class="author-info-articles__archives article-meta" href="/archives"><span class="pull-left">Articles</span><span class="pull-right">129</span></a><a class="author-info-articles__tags article-meta" href="/tags"><span class="pull-left">Tags</span><span class="pull-right">29</span></a><a class="author-info-articles__categories article-meta" href="/categories"><span class="pull-left">Categories</span><span class="pull-right">2</span></a></div></div></div><div id="content-outer"><div class="plain" id="top-container"><div id="page-header"><span class="pull-left"> <a id="site-name" href="/">Cwalker</a></span><i class="fa fa-bars toggle-menu pull-right" aria-hidden="true"></i><span class="pull-right"></span></div></div><div class="layout" id="content-inner"><article id="post"><div class="plain" id="post-title">K8S Network Model</div><div id="post-meta"><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2022-03-27</time><span class="post-meta__separator">|</span><i class="fa fa-inbox" aria-hidden="true"></i><a class="post-meta__categories" href="/categories/tech/"> tech</a><span class="post-meta__separator">|</span><i class="fa fa-comment-o" aria-hidden="true"></i><a href="/a/129.html#disqus_thread"><span class="disqus-comment-count" data-disqus-identifier="a/129.html"></span></a></div><div class="article-container" id="post-content"><p>近期了解到一些k8s网络模型，包括单机／跨机虚拟网络，涉及UDP／Host-GW／VXLAN／eBPF等方案。</p>
<span id="more"></span>

<h2 id="Single-Host"><a href="#Single-Host" class="headerlink" title="Single Host"></a>Single Host</h2><p>咱先从最简单的单宿主机多容器模型说起。<br><img src="https://img.yangrunwei.com/article-img/20220327/1e7f8fd0-d5d2-42d1-8f09-8798cc8efbb6--single-host.jpg" alt="single-host" title="single-host"><br>这里的docker0是个虚拟的二层网络设备，打通宿主机上各容器间的二层网络。</p>
<h2 id="Multi-Hosts"><a href="#Multi-Hosts" class="headerlink" title="Multi Hosts"></a>Multi Hosts</h2><p>实现跨宿主机的容器间网络，一般是在宿主机的容器间模拟一层Overlay，具体可分为以下３种模式：</p>
<ul>
<li>UDP</li>
<li>VXLAN</li>
<li>Host-GW</li>
</ul>
<h3 id="UDP"><a href="#UDP" class="headerlink" title="UDP"></a>UDP</h3><p>以flannel框架为例：<br><img src="https://img.yangrunwei.com/article-img/20220327/a38fad9e-0fe5-4458-b6f9-3220bfc3884a--udp.jpg" alt="UDP" title="UDP"><br>UDP的方案构建起了一个３层的Overlay网络，且能够跨多个子网通信，算是比较完整的方案了，但因为存在性能问题，所以逐渐被废弃。<br>性能问题具体原因是网络包在应用层和内核态之间多次复制传输，导致了网络性能下降。<br><img src="https://img.yangrunwei.com/article-img/20220327/437103be-de48-4c34-b72c-b9a58d8698db--udp-p.jpg" alt="udp-p" title="udp-p"></p>
<h3 id="VXLAN"><a href="#VXLAN" class="headerlink" title="VXLAN"></a>VXLAN</h3><p>以flannel框架为例：<br><img src="https://img.yangrunwei.com/article-img/20220327/e0bd562a-4f7b-4ec9-8b92-e17e8dacbe3b--vxlan.jpg" alt="vxlan" title="vxlan"><br>利用vtep这个linux内核功能，构建一个二层的容器Overlay网络。<br>如上图所示，容器的二层网络数据被放在宿主机的UDP网络包中，能够跨宿主机甚至跨子网传输，其中flannel相关模块负责在编码和解码网络包。</p>
<p>vtep在内核中解析和编码容器数据并传给网卡，解决了UDP的性能问题。<br><img src="https://img.yangrunwei.com/article-img/20220327/023fdd9c-23a7-48d0-894d-f93b8362ebe9--vtep.jpg" alt="vtep" title="vtep"></p>
<h4 id="Why-vxlan-use-UDP-but-not-tcp-or-ip"><a href="#Why-vxlan-use-UDP-but-not-tcp-or-ip" class="headerlink" title="Why vxlan use UDP but not tcp or ip?"></a>Why vxlan use UDP but not tcp or ip?</h4><ul>
<li>UDP面向连接，不包含状态和其它重传等保证传输可靠的策略，延迟和传输性能更高；</li>
<li>状态和保证可靠策略需要在虚拟网络的相应层次要管理；</li>
<li>UDP端口提供了更灵活的负载均衡的潜能。</li>
</ul>
<h4 id="Why-we-need-virtual-Layer-2-network"><a href="#Why-we-need-virtual-Layer-2-network" class="headerlink" title="Why we need virtual Layer 2 network?"></a>Why we need virtual Layer 2 network?</h4><ul>
<li>虚拟机能够在多个子网间进行动态迁移，因为动态迁移要保持虚拟机的ip和TCP不变，所以需要让虚拟机的二层网络不变，这就需要虚拟二层网络。</li>
<li>能够实现资源的多租户分配，用VNI标识（在vxlan header中），如上例的flannel.1就是租户1。<br><img src="https://img.yangrunwei.com/article-img/20220327/b7ed0d7b-9511-4f88-a288-07117b9e062d--vlayer2.jpg" alt="virtual-layer-2" title="virtual-layer-2"></li>
</ul>
<h3 id="vxlan-eBPF"><a href="#vxlan-eBPF" class="headerlink" title="vxlan+eBPF"></a>vxlan+eBPF</h3><p>相当于vxlan的优化版本。</p>
<p>上面的vxlan存在的问题：iptable在大规模动态容器集群的规则管理和更新会成为性能瓶颈。<br>引入eBPF，它运行在linux内核，且能够被注入代码规则对网络字节数据进行过滤，用它来实现数据包的转发和过滤，性能和功能都能够满足要求。</p>
<p>以Cilium为例：<br><img src="https://img.yangrunwei.com/article-img/20220327/3a16cb8f-e9bb-4d3d-895f-9ae5eaa610e4--vxlan_ebpf.jpg" alt="vxlan_ebpf" title="vxlan_ebpf"></p>
<h2 id="Host-GW"><a href="#Host-GW" class="headerlink" title="Host-GW"></a>Host-GW</h2><p>通过宿主机作为网关，对虚拟网络的包进行转发的模式。<br>好处是减少网络包的封装导致性能下降；<br>坏处是宿主机的路由规则比较多，调试或管理有一定的成本，如果容器规模大了，路由较多也会成为性能瓶颈；</p>
<h3 id="Single-LAN"><a href="#Single-LAN" class="headerlink" title="Single LAN"></a>Single LAN</h3><p><img src="https://img.yangrunwei.com/article-img/20220327/d796d3f4-42ed-44e7-a51b-88eada54245e--single-vlan.jpg" alt="single-lan" title="single-lan"><br>在宿主机二层互通的基础上，构建虚拟三层网络。可以看到数据帧的二层地址是真实的，三层地址是虚拟机的。</p>
<h3 id="Multi-LAN"><a href="#Multi-LAN" class="headerlink" title="Multi LAN"></a>Multi LAN</h3><h4 id="IPIP"><a href="#IPIP" class="headerlink" title="IPIP"></a>IPIP</h4><p>为了跨子网通信，虚拟网络需要开启IPIP模式，将虚拟三层的包放在正常宿主机的跨子网IP包中，到了对端再解析出内部的虚拟网络IP包。<br>这种性能损耗跟vxlan差不多。<br><img src="https://img.yangrunwei.com/article-img/20220327/751cd16f-707a-41cf-a950-91c0d68cda13--ipip.jpg" alt="ipip" title="ipip"></p>
<h4 id="BGP"><a href="#BGP" class="headerlink" title="BGP"></a>BGP</h4><p>BGP协议根据虚拟网络的宿主机IP与虚拟机子网的对应关系，配置路由器的路由规则，打通虚拟机的三层网络。<br>但这种模式需要交换机的路由管理权限。<br><img src="https://img.yangrunwei.com/article-img/20220327/2419ca22-275d-4b1a-bf4f-df496452ba97--bgp.jpg" alt="bgp" title="bgp"></p>
<h2 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h2><ul>
<li>《深入剖析kubernetes》- kubernetes容器网络</li>
<li><a target="_blank" rel="noopener" href="https://www.quora.com/Why-does-VXLAN-use-UDP-instead-of-TCP-as-the-underlying-transport-protocol">why does vxlan use udp not tcp</a></li>
<li><a target="_blank" rel="noopener" href="https://www.zhihu.com/question/54841860">为何vxlan需要封装在UDP里而不是直接使用IP包封装</a></li>
<li><a target="_blank" rel="noopener" href="https://segmentfault.com/a/1190000039392795">什么是VXLAN？为什么需要VXLAN？</a></li>
<li><a target="_blank" rel="noopener" href="https://www.linkedin.com/pulse/kubernetes-multi-cluster-networking-cilium-cluster-mesh-chandra">Cilium cluster mesh network</a></li>
</ul>
</div></article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">Author: </span><span class="post-copyright-info"><a href="mailto:undefined">杨润炜</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">Link: </span><span class="post-copyright-info"><a href="https://yangrunwei.com/a/129.html">https://yangrunwei.com/a/129.html</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">Copyright Notice: </span><span class="post-copyright-info">All articles in this blog are licensed under <a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a> unless stating additionally.</span></div></div><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/cloud-native/">cloud-native</a></div><nav id="pagination"><div class="next-post pull-right"><a href="/a/128.html"><span>Docker foundation in linux</span><i class="fa fa-chevron-right"></i></a></div></nav><div id="disqus_thread"></div><script>var unused = null;
var disqus_config = function () {
  this.page.url = 'https://yangrunwei.com/a/129.html';
  this.page.identifier = 'a/129.html';
  this.page.title = 'K8S Network Model';
}
var d = document, s = d.createElement('script');
s.src = "https://" + 'cwalker-top' +".disqus.com/embed.js";
s.setAttribute('data-timestamp', '' + +new Date());
(d.head || d.body).appendChild(s);</script><script id="dsq-count-scr" src="https://cwalker-top.disqus.com/count.js" async></script></div></div><footer><div class="layout" id="footer"><div class="copyright">&copy;2015 - 2022 By 杨润炜</div><div class="framework-info"><span>Driven - </span><a target="_blank" rel="noopener" href="http://hexo.io"><span>Hexo</span></a><span class="footer-separator">|</span><span>Theme - </span><a target="_blank" rel="noopener" href="https://github.com/Molunerfinn/hexo-theme-melody"><span>Melody</span></a></div><div class="busuanzi"><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><span id="busuanzi_container_page_pv"><i class="fa fa-file"></i><span id="busuanzi_value_page_pv"></span><span></span></span></div></div></footer><i class="fa fa-arrow-up" id="go-up" aria-hidden="true"></i><script src="https://cdn.jsdelivr.net/npm/animejs@latest/anime.min.js"></script><script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-animate@latest/velocity.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-ui-pack@latest/velocity.ui.min.js"></script><script src="/js/utils.js?version=1.9.0"></script><script src="/js/fancybox.js?version=1.9.0"></script><script src="/js/sidebar.js?version=1.9.0"></script><script src="/js/copy.js?version=1.9.0"></script><script src="/js/fireworks.js?version=1.9.0"></script><script src="/js/transition.js?version=1.9.0"></script><script src="/js/scroll.js?version=1.9.0"></script><script src="/js/head.js?version=1.9.0"></script><script>if(/Android|webOS|iPhone|iPod|iPad|BlackBerry/i.test(navigator.userAgent)) {
  $('#nav').addClass('is-mobile')
  $('footer').addClass('is-mobile')
  $('#top-container').addClass('is-mobile')
}</script></body></html>