<!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta name="description" content="介绍著名nosql数据库mongodb的数组操作运算符——$(update), $addToSet, $pop, $pullAll, $pull, $pushAll, $push, $each, $slice, $sort 与 $position,，它们主要用于操作数组字段。"><meta name="keywords" content="mongodb"><meta name="author" content="杨润炜"><meta name="copyright" content="杨润炜"><title>mongodb 数组操作运算符 | Cwalker</title><link rel="shortcut icon" href="/melody-favicon.ico"><link rel="stylesheet" href="/css/index.css?version=1.9.0"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@latest/css/font-awesome.min.css?version=1.9.0"><meta name="format-detection" content="telephone=no"><meta http-equiv="x-dns-prefetch-control" content="on"><link rel="dns-prefetch" href="https://cdn.jsdelivr.net"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  copy: {
    success: 'Copy successfully',
    error: 'Copy error',
    noSupport: 'The browser does not support'
  },
  hexoVersion: '6.2.0'
} </script><meta name="generator" content="Hexo 6.2.0"></head><body><i class="fa fa-arrow-right" id="toggle-sidebar" aria-hidden="true"></i><div id="sidebar" data-display="true"><div class="toggle-sidebar-info text-center"><span data-toggle="Toggle article">Toggle site</span><hr></div><div class="sidebar-toc"><div class="sidebar-toc__title">Catalog</div><div class="sidebar-toc__progress"><span class="progress-notice">You've read</span><span class="progress-num">0</span><span class="progress-percentage">%</span><div class="sidebar-toc__progress-bar"></div></div><div class="sidebar-toc__content"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#update"><span class="toc-number">1.</span> <span class="toc-text">$(update)</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#1-%E6%9B%B4%E6%96%B0%E6%95%B0%E7%BB%84%E4%B8%AD%E7%9A%84%E5%85%83%E7%B4%A0"><span class="toc-number">1.0.0.1.</span> <span class="toc-text">1.更新数组中的元素</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#2-%E5%A4%9A%E6%9D%A1%E4%BB%B6%E6%9B%B4%E6%96%B0"><span class="toc-number">1.0.0.2.</span> <span class="toc-text">2.多条件更新</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#addToSet"><span class="toc-number">2.</span> <span class="toc-text">$addToSet</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#1-%E6%B7%BB%E5%8A%A0%E4%B8%80%E4%B8%AA%E5%85%83%E7%B4%A0"><span class="toc-number">2.0.0.1.</span> <span class="toc-text">1.添加一个元素</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#2-%E6%B7%BB%E5%8A%A0%E5%A4%9A%E4%B8%AA%E5%85%83%E7%B4%A0"><span class="toc-number">2.0.0.2.</span> <span class="toc-text">2.添加多个元素</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#pop"><span class="toc-number">3.</span> <span class="toc-text">$pop</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#1-%E5%88%A0%E9%99%A4%E7%AC%AC%E4%B8%80%E4%B8%AA%E5%85%83%E7%B4%A0"><span class="toc-number">3.0.0.1.</span> <span class="toc-text">1.删除第一个元素</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#2-%E5%88%A0%E9%99%A4%E6%9C%80%E5%90%8E%E4%B8%80%E4%B8%AA%E5%85%83%E7%B4%A0"><span class="toc-number">3.0.0.2.</span> <span class="toc-text">2.删除最后一个元素</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#pullAll"><span class="toc-number">4.</span> <span class="toc-text">$pullAll</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#pull"><span class="toc-number">5.</span> <span class="toc-text">$pull</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%80%9A%E8%BF%87%E6%8C%87%E5%AE%9A%E5%80%BC%E5%88%A0%E9%99%A4"><span class="toc-number">5.0.1.</span> <span class="toc-text">通过指定值删除</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E9%80%9A%E8%BF%87%E6%9F%A5%E8%AF%A2%E6%9D%A1%E4%BB%B6%E5%88%A0%E9%99%A4"><span class="toc-number">5.0.1.1.</span> <span class="toc-text">通过查询条件删除</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%88%A0%E9%99%A4%E6%95%B0%E7%BB%84%E9%87%8C%E7%9A%84%E6%89%80%E6%9C%89%E5%AD%90%E9%A1%B9"><span class="toc-number">5.0.1.2.</span> <span class="toc-text">删除数组里的所有子项</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#pushAll"><span class="toc-number">6.</span> <span class="toc-text">$pushAll</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#push"><span class="toc-number">7.</span> <span class="toc-text">$push</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#1-%E6%B7%BB%E5%8A%A0%E4%B8%80%E4%B8%AA%E5%85%83%E7%B4%A0-1"><span class="toc-number">7.0.0.1.</span> <span class="toc-text">1.添加一个元素</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#2-%E6%B7%BB%E5%8A%A0%E5%A4%9A%E4%B8%AA%E5%85%83%E7%B4%A0-1"><span class="toc-number">7.0.0.2.</span> <span class="toc-text">2.添加多个元素</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8%E5%A4%9A%E4%B8%AA%E8%BF%90%E7%AE%97%E7%AC%A6"><span class="toc-number">7.0.0.3.</span> <span class="toc-text">使用多个运算符</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#each"><span class="toc-number">8.</span> <span class="toc-text">$each</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#slice"><span class="toc-number">9.</span> <span class="toc-text">$slice</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#1-%E4%BB%8E%E6%95%B0%E7%BB%84%E6%9C%AB%E5%B0%BE%E5%BC%80%E5%A7%8B%E6%88%AA%E5%8F%96"><span class="toc-number">9.0.0.1.</span> <span class="toc-text">1.从数组末尾开始截取</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#2-%E4%BB%8E%E6%95%B0%E7%BB%84%E5%A4%B4%E9%83%A8%E5%BC%80%E5%A7%8B%E6%88%AA%E5%8F%96"><span class="toc-number">9.0.0.2.</span> <span class="toc-text">2.从数组头部开始截取</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%8F%AA%E4%BD%BF%E7%94%A8-slice%E6%9D%A5%E6%9B%B4%E6%96%B0%E6%95%B0%E7%BB%84"><span class="toc-number">9.0.0.3.</span> <span class="toc-text">只使用$slice来更新数组</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E4%B8%8E-push%E7%9A%84%E7%9B%B8%E5%85%B3%E8%BF%90%E7%AE%97%E7%AC%A6%E4%B8%80%E8%B5%B7%E4%BD%BF%E7%94%A8"><span class="toc-number">9.0.0.4.</span> <span class="toc-text">与$push的相关运算符一起使用</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#sort"><span class="toc-number">10.</span> <span class="toc-text">$sort</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#1-%E5%88%A9%E7%94%A8%E6%95%B0%E7%BB%84%E5%85%83%E7%B4%A0%E5%AF%B9%E6%95%B0%E7%BB%84%E8%BF%9B%E8%A1%8C%E6%8E%92%E5%BA%8F"><span class="toc-number">10.0.0.1.</span> <span class="toc-text">1.利用数组元素对数组进行排序</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#2-%E7%9B%B4%E6%8E%A5%E5%AF%B9%E6%95%B0%E7%BB%84%E8%BF%9B%E8%A1%8C%E6%8E%92%E5%BA%8F"><span class="toc-number">10.0.0.2.</span> <span class="toc-text">2.直接对数组进行排序</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#3-%E5%8F%AA%E6%8E%92%E5%BA%8F%EF%BC%8C%E4%B8%8D%E6%9B%B4%E6%96%B0%E6%95%B0%E7%BB%84"><span class="toc-number">10.0.0.3.</span> <span class="toc-text">3.只排序，不更新数组</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#4-%E4%B8%8E-push%E7%9A%84%E7%9B%B8%E5%85%B3%E8%BF%90%E7%AE%97%E7%AC%A6%E4%B8%80%E8%B5%B7%E4%BD%BF%E7%94%A8"><span class="toc-number">10.0.0.4.</span> <span class="toc-text">4.与$push的相关运算符一起使用</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#position"><span class="toc-number">11.</span> <span class="toc-text">$position</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#1-%E4%BB%8E%E6%95%B0%E7%BB%84%E7%9A%84%E8%B5%B7%E5%A7%8B%E4%BD%8D%E7%BD%AE%E5%BC%80%E5%A7%8B%E6%B7%BB%E5%8A%A0"><span class="toc-number">11.0.0.1.</span> <span class="toc-text">1.从数组的起始位置开始添加</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#2-%E6%8A%8A%E5%85%83%E7%B4%A0%E6%B7%BB%E5%8A%A0%E5%88%B0%E5%8E%9F%E6%9D%A5%E7%9A%84%E6%95%B0%E7%BB%84%E5%85%83%E7%B4%A0%E4%B9%8B%E9%97%B4"><span class="toc-number">11.0.0.2.</span> <span class="toc-text">2.把元素添加到原来的数组元素之间</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%80%BB%E7%BB%93"><span class="toc-number">12.</span> <span class="toc-text">总结</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8F%82%E8%80%83"><span class="toc-number">13.</span> <span class="toc-text">参考</span></a></li></ol></div></div><div class="author-info hide"><div class="author-info__avatar text-center"><img src="/img/avatar.png"></div><div class="author-info__name text-center">杨润炜</div><div class="author-info__description text-center"></div><hr><div class="author-info-articles"><a class="author-info-articles__archives article-meta" href="/archives"><span class="pull-left">Articles</span><span class="pull-right">136</span></a><a class="author-info-articles__tags article-meta" href="/tags"><span class="pull-left">Tags</span><span class="pull-right">30</span></a><a class="author-info-articles__categories article-meta" href="/categories"><span class="pull-left">Categories</span><span class="pull-right">2</span></a></div></div></div><div id="content-outer"><div class="plain" id="top-container"><div id="page-header"><span class="pull-left"> <a id="site-name" href="/">Cwalker</a></span><i class="fa fa-bars toggle-menu pull-right" aria-hidden="true"></i><span class="pull-right"></span></div></div><div class="layout" id="content-inner"><article id="post"><div class="plain" id="post-title">mongodb 数组操作运算符</div><div id="post-meta"><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2016-01-27</time><span class="post-meta__separator">|</span><i class="fa fa-inbox" aria-hidden="true"></i><a class="post-meta__categories" href="/categories/tech/"> tech</a><span class="post-meta__separator">|</span><i class="fa fa-comment-o" aria-hidden="true"></i><a href="/a/21.html#disqus_thread"><span class="disqus-comment-count" data-disqus-identifier="a/21.html"></span></a></div><div class="article-container" id="post-content"><p>mongodb对于使用node.js开发的人来说应该不陌生，她与node.js的结合，十分的和谐且高效。接下来介绍一下mongodb的数组运算符,它们分别是$(update), $addToSet, $pop, $pullAll, $pull, $pushAll, $push, $each, $slice, $sort 与 $position，让我们来看看它们是怎样来为我们操作mongodb的数组字段的。</p>
<h2 id="update"><a href="#update" class="headerlink" title="$(update)"></a>$(update)</h2><p>简述：可以用来更新数组字段里是某个属性<br>用法：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123; &quot;&lt;array&gt;.$&quot; : value &#125;</span><br></pre></td></tr></table></figure>
<p>示例：<br>students表的原始数据</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123; &quot;_id&quot; : 1, grade: 80, mean: 75, &quot;grades&quot; : [ 80, 85, 90 ]， std： 1 &#125;</span><br></pre></td></tr></table></figure>
<h5 id="1-更新数组中的元素"><a href="#1-更新数组中的元素" class="headerlink" title="1.更新数组中的元素"></a>1.更新数组中的元素</h5><p>具体代码</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">db.students.update(</span><br><span class="line">   &#123; _id: 1, grades: 80 &#125;,</span><br><span class="line">   &#123; $set: &#123; &quot;grades.$&quot; : 82 &#125; &#125;</span><br><span class="line">)</span><br></pre></td></tr></table></figure>
<p>结果</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123; &quot;_id&quot; : 1, grade: 80, mean: 75, &quot;grades&quot; : [ 82, 85, 90 ]， std： 6 &#125;</span><br></pre></td></tr></table></figure>

<h5 id="2-多条件更新"><a href="#2-多条件更新" class="headerlink" title="2.多条件更新"></a>2.多条件更新</h5><p>具体代码</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">db.students.update(</span><br><span class="line">   &#123;</span><br><span class="line">     _id: 4,</span><br><span class="line">     grades: &#123; $elemMatch: &#123; grade: &#123; $lte: 90 &#125;, mean: &#123; $gt: 70 &#125; &#125; &#125;</span><br><span class="line">   &#125;,</span><br><span class="line">   &#123; $set: &#123; &quot;grades.$.std&quot; : 6 &#125; &#125;</span><br><span class="line">)</span><br></pre></td></tr></table></figure>
<p>结果</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123; &quot;_id&quot; : 1, grade: 80, mean: 75, &quot;grades&quot; : [ 80, 85, 90 ]， std： 6 &#125;</span><br></pre></td></tr></table></figure>

<p>小结：可以将$(update)运算符类比为js数组操作里的splice方法，只是不通过索引，而是通过具体的元素值比较。<br>用到的相关运算符： <a target="_blank" rel="noopener" href="https://docs.mongodb.org/manual/reference/operator/update/set/">$set</a>，<a target="_blank" rel="noopener" href="https://docs.mongodb.org/manual/reference/operator/query/elemMatch/">$elemMatch</a></p>
<h2 id="addToSet"><a href="#addToSet" class="headerlink" title="$addToSet"></a>$addToSet</h2><p>简述：将元素添加进数组字段，且不重复。这也正是set这一数据结构的特性。<br>用法：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123; $addToSet: &#123; &lt;field1&gt;: &lt;value1&gt;, ... &#125; &#125;</span><br></pre></td></tr></table></figure>
<p>示例：<br>inventory表的原始数据</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123; _id: 1, item: &quot;polarizing_filter&quot;, tags: [ &quot;electronics&quot;, &quot;camera&quot; ] &#125;</span><br></pre></td></tr></table></figure>
<h5 id="1-添加一个元素"><a href="#1-添加一个元素" class="headerlink" title="1.添加一个元素"></a>1.添加一个元素</h5><p>具体代码</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">db.inventory.update(</span><br><span class="line">   &#123; _id: 1 &#125;,</span><br><span class="line">   &#123; $addToSet: &#123; tags: &quot;accessories&quot; &#125; &#125;</span><br><span class="line">)</span><br></pre></td></tr></table></figure>
<p>结果</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123; _id: 1, item: &quot;polarizing_filter&quot;, tags: [ &quot;electronics&quot;, &quot;camera&quot;, &quot;accessories&quot; ] &#125;</span><br></pre></td></tr></table></figure>

<h5 id="2-添加多个元素"><a href="#2-添加多个元素" class="headerlink" title="2.添加多个元素"></a>2.添加多个元素</h5><p>具体代码</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">db.inventory.update(</span><br><span class="line">   &#123; _id: 1 &#125;,</span><br><span class="line">   &#123; $addToSet: &#123; tags: &#123; $each: [ &quot;camera&quot;, &quot;electronics&quot;, &quot;accessories&quot;, &quot;supplies&quot; ] &#125; &#125; &#125;</span><br><span class="line"> )</span><br></pre></td></tr></table></figure>
<p>结果</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123; _id: 1, item: &quot;polarizing_filter&quot;, tags: [ &quot;electronics&quot;, &quot;camera&quot;, &quot;accessories&quot;, &quot;supplies&quot; ] &#125;</span><br></pre></td></tr></table></figure>

<p>小结：利用$addToSet操作数组，我们可以不用去检测重复，十分方便，结合$each，可以直接传入数组，类似于js数组的concat方法，区别在于结果是个元素唯一的数组。</p>
<h2 id="pop"><a href="#pop" class="headerlink" title="$pop"></a>$pop</h2><p>简述：删除数组字段的第一个或最后一个元素。<br>用法：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123; $pop: &#123; &lt;field&gt;: &lt;-1 | 1&gt;, ... &#125; &#125;</span><br></pre></td></tr></table></figure>
<p>示例：<br>students表的原始数据</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123; _id: 1, scores: [ 8, 9, 10 ] &#125;</span><br></pre></td></tr></table></figure>
<h5 id="1-删除第一个元素"><a href="#1-删除第一个元素" class="headerlink" title="1.删除第一个元素"></a>1.删除第一个元素</h5><p>具体代码</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.students.update( &#123; _id: 1 &#125;, &#123; $pop: &#123; scores: -1 &#125; &#125; )</span><br></pre></td></tr></table></figure>
<p>结果</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123; _id: 1, scores: [ 9, 10 ] &#125;</span><br></pre></td></tr></table></figure>

<h5 id="2-删除最后一个元素"><a href="#2-删除最后一个元素" class="headerlink" title="2.删除最后一个元素"></a>2.删除最后一个元素</h5><p>具体代码</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.students.update( &#123; _id: 1 &#125;, &#123; $pop: &#123; scores: 1 &#125; &#125; )</span><br></pre></td></tr></table></figure>
<p>结果</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123; _id: 1, scores: [ 8, 9 ] &#125;</span><br></pre></td></tr></table></figure>

<p>小结：传入-1参数时，相当于js数组操作的shift方法；传入1参数时，相当于js数组操作的pop方法。</p>
<h2 id="pullAll"><a href="#pullAll" class="headerlink" title="$pullAll"></a>$pullAll</h2><p>简述：删除匹配的列表值的所有数组字段元素。<br>用法：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123; $pullAll: &#123; &lt;field1&gt;: [ &lt;value1&gt;, &lt;value2&gt; ... ], ... &#125; &#125;</span><br></pre></td></tr></table></figure>
<p>示例：<br>survey表的原始数据</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123; _id: 1, scores: [ 0, 2, 5, 5, 1, 0 ] &#125;</span><br></pre></td></tr></table></figure>
<p>具体代码</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.survey.update( &#123; _id: 1 &#125;, &#123; $pullAll: &#123; scores: [ 0, 5 ] &#125; &#125; )</span><br></pre></td></tr></table></figure>
<p>结果</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123; &quot;_id&quot; : 1, &quot;scores&quot; : [ 2, 1 ] &#125;</span><br></pre></td></tr></table></figure>

<p>小结：与$pull不同的是，$pullAll只是通过匹配列表值来删除元素，也就是说可以传入数组参数，然后比较两个数组的交集来进行删除，而前者是通过指定一个查询条件。</p>
<h2 id="pull"><a href="#pull" class="headerlink" title="$pull"></a>$pull</h2><p>简述：通过指定一个查询条件来删除所有符合条件的数组字段元素<br>用法：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123; $pull: &#123; &lt;field1&gt;: &lt;value|condition&gt;, &lt;field2&gt;: &lt;value|condition&gt;, ... &#125; &#125;</span><br></pre></td></tr></table></figure>
<p>示例：</p>
<h4 id="通过指定值删除"><a href="#通过指定值删除" class="headerlink" title="通过指定值删除"></a>通过指定值删除</h4><p>stores表的原始数据</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">   _id: 1,</span><br><span class="line">   fruits: [ &quot;apples&quot;, &quot;pears&quot;, &quot;oranges&quot;, &quot;grapes&quot;, &quot;bananas&quot; ],</span><br><span class="line">   vegetables: [ &quot;carrots&quot;, &quot;celery&quot;, &quot;squash&quot;, &quot;carrots&quot; ]</span><br><span class="line">&#125;</span><br><span class="line">&#123;</span><br><span class="line">   _id: 2,</span><br><span class="line">   fruits: [ &quot;plums&quot;, &quot;kiwis&quot;, &quot;oranges&quot;, &quot;bananas&quot;, &quot;apples&quot; ],</span><br><span class="line">   vegetables: [ &quot;broccoli&quot;, &quot;zucchini&quot;, &quot;carrots&quot;, &quot;onions&quot; ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>具体代码</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">db.stores.update(</span><br><span class="line">    &#123; &#125;,</span><br><span class="line">    &#123; $pull: &#123; fruits: &#123; $in: [ &quot;apples&quot;, &quot;oranges&quot; ] &#125;, vegetables: &quot;carrots&quot; &#125; &#125;,</span><br><span class="line">    &#123; multi: true &#125;</span><br><span class="line">)</span><br></pre></td></tr></table></figure>
<p>结果</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  &quot;_id&quot; : 1,</span><br><span class="line">  &quot;fruits&quot; : [ &quot;pears&quot;, &quot;grapes&quot;, &quot;bananas&quot; ],</span><br><span class="line">  &quot;vegetables&quot; : [ &quot;celery&quot;, &quot;squash&quot; ]</span><br><span class="line">&#125;</span><br><span class="line">&#123;</span><br><span class="line">  &quot;_id&quot; : 2,</span><br><span class="line">  &quot;fruits&quot; : [ &quot;plums&quot;, &quot;kiwis&quot;, &quot;bananas&quot; ],</span><br><span class="line">  &quot;vegetables&quot; : [ &quot;broccoli&quot;, &quot;zucchini&quot;, &quot;onions&quot; ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="通过查询条件删除"><a href="#通过查询条件删除" class="headerlink" title="通过查询条件删除"></a>通过查询条件删除</h5><p>原始数据</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123; _id: 1, votes: [ 3, 5, 6, 7, 7, 8 ] &#125;</span><br></pre></td></tr></table></figure>
<p>具体代码</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.profiles.update( &#123; _id: 1 &#125;, &#123; $pull: &#123; votes: &#123; $gte: 6 &#125; &#125; &#125; )</span><br></pre></td></tr></table></figure>
<p>结果</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123; _id: 1, votes: [  3,  5 ] &#125;</span><br></pre></td></tr></table></figure>

<h5 id="删除数组里的所有子项"><a href="#删除数组里的所有子项" class="headerlink" title="删除数组里的所有子项"></a>删除数组里的所有子项</h5><p>survey表的原始数据</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">   _id: 1,</span><br><span class="line">   results: [</span><br><span class="line">      &#123; item: &quot;A&quot;, score: 5 &#125;,</span><br><span class="line">      &#123; item: &quot;B&quot;, score: 8, comment: &quot;Strongly agree&quot; &#125;</span><br><span class="line">   ]</span><br><span class="line">&#125;</span><br><span class="line">&#123;</span><br><span class="line">   _id: 2,</span><br><span class="line">   results: [</span><br><span class="line">      &#123; item: &quot;C&quot;, score: 8, comment: &quot;Strongly agree&quot; &#125;,</span><br><span class="line">      &#123; item: &quot;B&quot;, score: 4 &#125;</span><br><span class="line">   ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>具体代码</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">db.survey.update(</span><br><span class="line">  &#123; &#125;,</span><br><span class="line">  &#123; $pull: &#123; results: &#123; score: 8 , item: &quot;B&quot; &#125; &#125; &#125;,</span><br><span class="line">  &#123; multi: true &#125;</span><br><span class="line">)</span><br></pre></td></tr></table></figure>
<p>结果</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">   &quot;_id&quot; : 1,</span><br><span class="line">   &quot;results&quot; : [ &#123; &quot;item&quot; : &quot;A&quot;, &quot;score&quot; : 5 &#125; ]</span><br><span class="line">&#125;</span><br><span class="line">&#123;</span><br><span class="line">  &quot;_id&quot; : 2,</span><br><span class="line">  &quot;results&quot; : [</span><br><span class="line">      &#123; &quot;item&quot; : &quot;C&quot;, &quot;score&quot; : 8, &quot;comment&quot; : &quot;Strongly agree&quot; &#125;,</span><br><span class="line">      &#123; &quot;item&quot; : &quot;B&quot;, &quot;score&quot; : 4 &#125;</span><br><span class="line">   ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里需要注意的是在$pull操作中，会将查询条件应用到每个元素，所以不能使用$elemMatch,用了反而匹配不到正确的元素。<br>如：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">db.survey.update(</span><br><span class="line">  &#123; &#125;,</span><br><span class="line">  &#123; $pull: &#123; results: &#123; $elemMatch: &#123; score: 8 , item: &quot;B&quot; &#125; &#125; &#125; &#125;,</span><br><span class="line">  &#123; multi: true &#125;</span><br><span class="line">)</span><br></pre></td></tr></table></figure>
<p>这样去对原始数据的操作是不能达到预期结果的，结果数据将没有变化。</p>
<p>然而，当我们需要匹配的是数组里嵌套的数组元素，且需要多个条件，那就需要$elemMatch的帮忙了。<br>原始数据</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">   _id: 1,</span><br><span class="line">   results: [</span><br><span class="line">      &#123; item: &quot;A&quot;, score: 5, answers: [ &#123; q: 1, a: 4 &#125;, &#123; q: 2, a: 6 &#125; ] &#125;,</span><br><span class="line">      &#123; item: &quot;B&quot;, score: 8, answers: [ &#123; q: 1, a: 8 &#125;, &#123; q: 2, a: 9 &#125; ] &#125;</span><br><span class="line">   ]</span><br><span class="line">&#125;</span><br><span class="line">&#123;</span><br><span class="line">   _id: 2,</span><br><span class="line">   results: [</span><br><span class="line">      &#123; item: &quot;C&quot;, score: 8, answers: [ &#123; q: 1, a: 8 &#125;, &#123; q: 2, a: 7 &#125; ] &#125;,</span><br><span class="line">      &#123; item: &quot;B&quot;, score: 4, answers: [ &#123; q: 1, a: 0 &#125;, &#123; q: 2, a: 8 &#125; ] &#125;</span><br><span class="line">   ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>具体代码</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">db.survey.update(</span><br><span class="line">  &#123; &#125;,</span><br><span class="line">  &#123; $pull: &#123; results: &#123; answers: &#123; $elemMatch: &#123; q: 2, a: &#123; $gte: 8 &#125; &#125; &#125; &#125; &#125; &#125;,</span><br><span class="line">  &#123; multi: true &#125;</span><br><span class="line">)</span><br></pre></td></tr></table></figure>
<p>结果</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">   &quot;_id&quot; : 1,</span><br><span class="line">   &quot;results&quot; : [</span><br><span class="line">      &#123; &quot;item&quot; : &quot;A&quot;, &quot;score&quot; : 5, &quot;answers&quot; : [ &#123; &quot;q&quot; : 1, &quot;a&quot; : 4 &#125;, &#123; &quot;q&quot; : 2, &quot;a&quot; : 6 &#125; ] &#125;</span><br><span class="line">   ]</span><br><span class="line">&#125;</span><br><span class="line">&#123;</span><br><span class="line">   &quot;_id&quot; : 2,</span><br><span class="line">   &quot;results&quot; : [</span><br><span class="line">      &#123; &quot;item&quot; : &quot;C&quot;, &quot;score&quot; : 8, &quot;answers&quot; : [ &#123; &quot;q&quot; : 1, &quot;a&quot; : 8 &#125;, &#123; &quot;q&quot; : 2, &quot;a&quot; : 7 &#125; ] &#125;</span><br><span class="line">   ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>小结：$pull可以通过指定查询条件来删除所有匹配的元素，如果需要像$pullAll的那样能传入数组进行匹配，那需要$in运算符的帮助。$pull的查询条件会应用到每个数组下的“顶级”元素，所以一般不需要使用$elemMatch，但如果需要匹配到数组里的嵌套数组元素，那就需要$elemMatch运算符的帮助了。</p>
<h2 id="pushAll"><a href="#pushAll" class="headerlink" title="$pushAll"></a>$pushAll</h2><p>2.4版本后移除，可使用$push,$each替代。这里将不作介绍</p>
<h2 id="push"><a href="#push" class="headerlink" title="$push"></a>$push</h2><p>简述：添加数组元素。<br>用法：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123; $push: &#123; &lt;field1&gt;: &lt;value1&gt;, ... &#125; &#125;</span><br></pre></td></tr></table></figure>
<p>或</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123; $push: &#123; &lt;field1&gt;: &#123; &lt;modifier1&gt;: &lt;value1&gt;, ... &#125;, ... &#125; &#125;</span><br></pre></td></tr></table></figure>
<p>示例：</p>
<h5 id="1-添加一个元素-1"><a href="#1-添加一个元素-1" class="headerlink" title="1.添加一个元素"></a>1.添加一个元素</h5><p>students表的原始数据</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;_id: 1, scores: [60, 80, 89]&#125;</span><br></pre></td></tr></table></figure>
<p>具体代码</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">db.students.update(</span><br><span class="line">   &#123; _id: 1 &#125;,</span><br><span class="line">   &#123; $push: &#123; scores: 89 &#125; &#125;</span><br><span class="line">)</span><br></pre></td></tr></table></figure>
<p>结果</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;_id: 1, scores: [60, 80, 89, 89]&#125;</span><br></pre></td></tr></table></figure>
<h5 id="2-添加多个元素-1"><a href="#2-添加多个元素-1" class="headerlink" title="2.添加多个元素"></a>2.添加多个元素</h5><p>具体代码</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">db.students.update(</span><br><span class="line">   &#123; name: &quot;joe&quot; &#125;,</span><br><span class="line">   &#123; $push: &#123; scores: &#123; $each: [ 90, 92, 85 ] &#125; &#125; &#125;</span><br><span class="line">)</span><br></pre></td></tr></table></figure>
<p>结果</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;_id: 1, scores: [60, 80, 89, 90, 92, 85]&#125;</span><br></pre></td></tr></table></figure>

<h5 id="使用多个运算符"><a href="#使用多个运算符" class="headerlink" title="使用多个运算符"></a>使用多个运算符</h5><p>students表的原始数据</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">   &quot;_id&quot; : 5,</span><br><span class="line">   &quot;quizzes&quot; : [</span><br><span class="line">      &#123; &quot;wk&quot;: 1, &quot;score&quot; : 10 &#125;,</span><br><span class="line">      &#123; &quot;wk&quot;: 2, &quot;score&quot; : 8 &#125;,</span><br><span class="line">      &#123; &quot;wk&quot;: 3, &quot;score&quot; : 5 &#125;,</span><br><span class="line">      &#123; &quot;wk&quot;: 4, &quot;score&quot; : 6 &#125;</span><br><span class="line">   ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>具体代码</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">db.students.update(</span><br><span class="line">   &#123; _id: 5 &#125;,</span><br><span class="line">   &#123;</span><br><span class="line">     $push: &#123;</span><br><span class="line">       quizzes: &#123;</span><br><span class="line">          $each: [ &#123; wk: 5, score: 8 &#125;, &#123; wk: 6, score: 7 &#125;, &#123; wk: 7, score: 6 &#125; ],</span><br><span class="line">          $sort: &#123; score: -1 &#125;,</span><br><span class="line">          $slice: 3</span><br><span class="line">       &#125;</span><br><span class="line">     &#125;</span><br><span class="line">   &#125;</span><br><span class="line">)</span><br></pre></td></tr></table></figure>
<p>结果</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  &quot;_id&quot; : 5,</span><br><span class="line">  &quot;quizzes&quot; : [</span><br><span class="line">     &#123; &quot;wk&quot; : 1, &quot;score&quot; : 10 &#125;,</span><br><span class="line">     &#123; &quot;wk&quot; : 2, &quot;score&quot; : 8 &#125;,</span><br><span class="line">     &#123; &quot;wk&quot; : 5, &quot;score&quot; : 8 &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>小结：与$addToSet很类似，区别在于$push可能会使数组字段的元素重复，而$addToSet不会。与js的push效果一样。</p>
<h2 id="each"><a href="#each" class="headerlink" title="$each"></a>$each</h2><p>简述：与$push,$addToSet结合，实现向数组字段添加多个元素的效果，类似于js的concat<br>用法与示例请见上方$addToSet与$push。</p>
<h2 id="slice"><a href="#slice" class="headerlink" title="$slice"></a>$slice</h2><p>简述：限制指定数值的数组字段元素。<br>用法：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  $push: &#123;</span><br><span class="line">     &lt;field&gt;: &#123;</span><br><span class="line">       $each: [ &lt;value1&gt;, &lt;value2&gt;, ... ],</span><br><span class="line">       $slice: &lt;num&gt;</span><br><span class="line">     &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>示例</p>
<h5 id="1-从数组末尾开始截取"><a href="#1-从数组末尾开始截取" class="headerlink" title="1.从数组末尾开始截取"></a>1.从数组末尾开始截取</h5><p>原始数据</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123; &quot;_id&quot; : 1, &quot;scores&quot; : [ 40, 50, 60 ] &#125;</span><br></pre></td></tr></table></figure>
<p>具体代码</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">db.students.update(</span><br><span class="line">   &#123; _id: 1 &#125;,</span><br><span class="line">   &#123;</span><br><span class="line">     $push: &#123;</span><br><span class="line">       scores: &#123;</span><br><span class="line">         $each: [ 80, 78, 86 ],</span><br><span class="line">         $slice: -5</span><br><span class="line">       &#125;</span><br><span class="line">     &#125;</span><br><span class="line">   &#125;</span><br><span class="line">)</span><br></pre></td></tr></table></figure>
<p>结果</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123; &quot;_id&quot; : 1, &quot;scores&quot; : [  50,  60,  80,  78,  86 ] &#125;</span><br></pre></td></tr></table></figure>

<h5 id="2-从数组头部开始截取"><a href="#2-从数组头部开始截取" class="headerlink" title="2.从数组头部开始截取"></a>2.从数组头部开始截取</h5><p>原始数据</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123; &quot;_id&quot; : 2, &quot;scores&quot; : [ 89, 90 ] &#125;</span><br></pre></td></tr></table></figure>
<p>具体代码</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">db.students.update(</span><br><span class="line">   &#123; _id: 2 &#125;,</span><br><span class="line">   &#123;</span><br><span class="line">     $push: &#123;</span><br><span class="line">       scores: &#123;</span><br><span class="line">         $each: [ 100, 20 ],</span><br><span class="line">         $slice: 3</span><br><span class="line">       &#125;</span><br><span class="line">     &#125;</span><br><span class="line">   &#125;</span><br><span class="line">)</span><br></pre></td></tr></table></figure>
<p>结果</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123; &quot;_id&quot; : 2, &quot;scores&quot; : [  89,  90,  100 ] &#125;</span><br></pre></td></tr></table></figure>

<h5 id="只使用-slice来更新数组"><a href="#只使用-slice来更新数组" class="headerlink" title="只使用$slice来更新数组"></a>只使用$slice来更新数组</h5><p>原始数据</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123; &quot;_id&quot; : 3, &quot;scores&quot; : [  89,  70,  100,  20 ] &#125;</span><br></pre></td></tr></table></figure>
<p>具体代码</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">db.students.update(</span><br><span class="line">  &#123; _id: 3 &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    $push: &#123;</span><br><span class="line">      scores: &#123;</span><br><span class="line">         $each: [ ],</span><br><span class="line">         $slice: -3</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">)</span><br></pre></td></tr></table></figure>
<p>结果</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123; &quot;_id&quot; : 3, &quot;scores&quot; : [  70,  100,  20 ] &#125;</span><br></pre></td></tr></table></figure>

<h5 id="与-push的相关运算符一起使用"><a href="#与-push的相关运算符一起使用" class="headerlink" title="与$push的相关运算符一起使用"></a>与$push的相关运算符一起使用</h5><p>见$push运算符的讲解。</p>
<p>小结：$slice主要是与$push相结合，来从数组头部或末尾开始截取数组元素的。在后面版本（官方上称2.6开始）将不强制$slice与$each结合使用。</p>
<h2 id="sort"><a href="#sort" class="headerlink" title="$sort"></a>$sort</h2><p>简述：对数组字段的元素进行排序。<br>用法：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  $push: &#123;</span><br><span class="line">     &lt;field&gt;: &#123;</span><br><span class="line">       $each: [ &lt;value1&gt;, &lt;value2&gt;, ... ],</span><br><span class="line">       $sort: &lt;sort specification&gt;</span><br><span class="line">     &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>示例：</p>
<h5 id="1-利用数组元素对数组进行排序"><a href="#1-利用数组元素对数组进行排序" class="headerlink" title="1.利用数组元素对数组进行排序"></a>1.利用数组元素对数组进行排序</h5><p>原始数据</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  &quot;_id&quot;: 1,</span><br><span class="line">  &quot;quizzes&quot;: [</span><br><span class="line">    &#123; &quot;id&quot; : 1, &quot;score&quot; : 6 &#125;,</span><br><span class="line">    &#123; &quot;id&quot; : 2, &quot;score&quot; : 9 &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>具体代码</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">db.students.update(</span><br><span class="line">   &#123; _id: 1 &#125;,</span><br><span class="line">   &#123;</span><br><span class="line">     $push: &#123;</span><br><span class="line">       quizzes: &#123;</span><br><span class="line">         $each: [ &#123; id: 3, score: 8 &#125;, &#123; id: 4, score: 7 &#125;, &#123; id: 5, score: 6 &#125; ],</span><br><span class="line">         $sort: &#123; score: 1 &#125;</span><br><span class="line">       &#125;</span><br><span class="line">     &#125;</span><br><span class="line">   &#125;</span><br><span class="line">)</span><br></pre></td></tr></table></figure>
<p>结果</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  &quot;_id&quot; : 1,</span><br><span class="line">  &quot;quizzes&quot; : [</span><br><span class="line">     &#123; &quot;id&quot; : 1, &quot;score&quot; : 6 &#125;,</span><br><span class="line">     &#123; &quot;id&quot; : 5, &quot;score&quot; : 6 &#125;,</span><br><span class="line">     &#123; &quot;id&quot; : 4, &quot;score&quot; : 7 &#125;,</span><br><span class="line">     &#123; &quot;id&quot; : 3, &quot;score&quot; : 8 &#125;,</span><br><span class="line">     &#123; &quot;id&quot; : 2, &quot;score&quot; : 9 &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="2-直接对数组进行排序"><a href="#2-直接对数组进行排序" class="headerlink" title="2.直接对数组进行排序"></a>2.直接对数组进行排序</h5><p>原始数据</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123; &quot;_id&quot; : 2, &quot;tests&quot; : [  89,  70,  89,  50 ] &#125;</span><br></pre></td></tr></table></figure>
<p>具体代码</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">db.students.update(</span><br><span class="line">   &#123; _id: 2 &#125;,</span><br><span class="line">   &#123; $push: &#123; tests: &#123; $each: [ 40, 60 ], $sort: 1 &#125; &#125; &#125;</span><br><span class="line">)</span><br></pre></td></tr></table></figure>
<p>结果</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123; &quot;_id&quot; : 2, &quot;tests&quot; : [  40,  50,  60,  70,  89,  89 ] &#125;</span><br></pre></td></tr></table></figure>

<h5 id="3-只排序，不更新数组"><a href="#3-只排序，不更新数组" class="headerlink" title="3.只排序，不更新数组"></a>3.只排序，不更新数组</h5><p>原始数据</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123; &quot;_id&quot; : 3, &quot;tests&quot; : [  89,  70,  100,  20 ] &#125;</span><br></pre></td></tr></table></figure>
<p>具体代码</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">db.students.update(</span><br><span class="line">   &#123; _id: 3 &#125;,</span><br><span class="line">   &#123; $push: &#123; tests: &#123; $each: [ ], $sort: -1 &#125; &#125; &#125;</span><br><span class="line">)</span><br></pre></td></tr></table></figure>
<p>结果</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123; &quot;_id&quot; : 3, &quot;tests&quot; : [ 100,  89,  70,  20 ] &#125;</span><br></pre></td></tr></table></figure>

<h5 id="4-与-push的相关运算符一起使用"><a href="#4-与-push的相关运算符一起使用" class="headerlink" title="4.与$push的相关运算符一起使用"></a>4.与$push的相关运算符一起使用</h5><p>见$push运算符的讲解。</p>
<p>小结：$sort为1时，表示按数值的从小到大排序；为-1时，则反过来。在后面版本（官方上称2.6开始）将不强制$slice与$each结合使用，这点与$slice相同。</p>
<h2 id="position"><a href="#position" class="headerlink" title="$position"></a>$position</h2><p>简述：与$push结合使用，表示元素添加的开始位置。<br>用法：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  $push: &#123;</span><br><span class="line">    &lt;field&gt;: &#123;</span><br><span class="line">       $each: [ &lt;value1&gt;, &lt;value2&gt;, ... ],</span><br><span class="line">       $position: &lt;num&gt;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>示例：</p>
<h5 id="1-从数组的起始位置开始添加"><a href="#1-从数组的起始位置开始添加" class="headerlink" title="1.从数组的起始位置开始添加"></a>1.从数组的起始位置开始添加</h5><p>原始数据</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123; &quot;_id&quot; : 1, &quot;scores&quot; : [ 100 ] &#125;</span><br></pre></td></tr></table></figure>
<p>具体代码</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">db.students.update(</span><br><span class="line">   &#123; _id: 1 &#125;,</span><br><span class="line">   &#123;</span><br><span class="line">     $push: &#123;</span><br><span class="line">        scores: &#123;</span><br><span class="line">           $each: [ 50, 60, 70 ],</span><br><span class="line">           $position: 0</span><br><span class="line">        &#125;</span><br><span class="line">     &#125;</span><br><span class="line">   &#125;</span><br><span class="line">)</span><br></pre></td></tr></table></figure>
<p>结果</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123; &quot;_id&quot; : 1, &quot;scores&quot; : [  50,  60,  70,  100 ] &#125;</span><br></pre></td></tr></table></figure>
<h5 id="2-把元素添加到原来的数组元素之间"><a href="#2-把元素添加到原来的数组元素之间" class="headerlink" title="2.把元素添加到原来的数组元素之间"></a>2.把元素添加到原来的数组元素之间</h5><p>原始数据</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123; &quot;_id&quot; : 1, &quot;scores&quot; : [  50,  60,  70,  100 ] &#125;</span><br></pre></td></tr></table></figure>
<p>具体代码</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">db.students.update(</span><br><span class="line">   &#123; _id: 1 &#125;,</span><br><span class="line">   &#123;</span><br><span class="line">     $push: &#123;</span><br><span class="line">        scores: &#123;</span><br><span class="line">           $each: [ 20, 30 ],</span><br><span class="line">           $position: 2</span><br><span class="line">        &#125;</span><br><span class="line">     &#125;</span><br><span class="line">   &#125;</span><br><span class="line">)</span><br></pre></td></tr></table></figure>
<p>结果</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123; &quot;_id&quot; : 1, &quot;scores&quot; : [  50,  60,  20,  30,  70,  100 ] &#125;</span><br></pre></td></tr></table></figure>

<p>小结：本来$push是默认从数组的末尾开始添加的元素的，但$position可以指定元素添加的开始位置。</p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>在mongodb中利用这些数组操作的运算符，将大大提高操作的效率和方便性，让你感觉就是在利用动态语言操作数组一样方便快捷。</p>
<h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><p><a target="_blank" rel="noopener" href="http://docs.mongoing.com/manual/reference/operator/update-array.html">mongodb-v3.2操作手册</a><br><a target="_blank" rel="noopener" href="http://www.w3school.com.cn/jsref/jsref_obj_array.asp">js数组操作</a></p>
</div></article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">Author: </span><span class="post-copyright-info"><a href="mailto:undefined">杨润炜</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">Link: </span><span class="post-copyright-info"><a href="https://yangrunwei.com/a/21.html">https://yangrunwei.com/a/21.html</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">Copyright Notice: </span><span class="post-copyright-info">All articles in this blog are licensed under <a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a> unless stating additionally.</span></div></div><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/mongodb/">mongodb</a></div><nav id="pagination"><div class="prev-post pull-left"><a href="/a/23.html"><i class="fa fa-chevron-left">  </i><span>慈爱的大脚马皇后</span></a></div><div class="next-post pull-right"><a href="/a/22.html"><span>express返回 413 Payload Too Large</span><i class="fa fa-chevron-right"></i></a></div></nav><div id="disqus_thread"></div><script>var unused = null;
var disqus_config = function () {
  this.page.url = 'https://yangrunwei.com/a/21.html';
  this.page.identifier = 'a/21.html';
  this.page.title = 'mongodb 数组操作运算符';
}
var d = document, s = d.createElement('script');
s.src = "https://" + 'cwalker-top' +".disqus.com/embed.js";
s.setAttribute('data-timestamp', '' + +new Date());
(d.head || d.body).appendChild(s);</script><script id="dsq-count-scr" src="https://cwalker-top.disqus.com/count.js" async></script></div></div><footer><div class="layout" id="footer"><div class="copyright">&copy;2015 - 2022 By 杨润炜</div><div class="framework-info"><span>Driven - </span><a target="_blank" rel="noopener" href="http://hexo.io"><span>Hexo</span></a><span class="footer-separator">|</span><span>Theme - </span><a target="_blank" rel="noopener" href="https://github.com/Molunerfinn/hexo-theme-melody"><span>Melody</span></a></div><div class="busuanzi"><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><span id="busuanzi_container_page_pv"><i class="fa fa-file"></i><span id="busuanzi_value_page_pv"></span><span></span></span></div></div></footer><i class="fa fa-arrow-up" id="go-up" aria-hidden="true"></i><script src="https://cdn.jsdelivr.net/npm/animejs@latest/anime.min.js"></script><script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-animate@latest/velocity.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-ui-pack@latest/velocity.ui.min.js"></script><script src="/js/utils.js?version=1.9.0"></script><script src="/js/fancybox.js?version=1.9.0"></script><script src="/js/sidebar.js?version=1.9.0"></script><script src="/js/copy.js?version=1.9.0"></script><script src="/js/fireworks.js?version=1.9.0"></script><script src="/js/transition.js?version=1.9.0"></script><script src="/js/scroll.js?version=1.9.0"></script><script src="/js/head.js?version=1.9.0"></script><script>if(/Android|webOS|iPhone|iPod|iPad|BlackBerry/i.test(navigator.userAgent)) {
  $('#nav').addClass('is-mobile')
  $('footer').addClass('is-mobile')
  $('#top-container').addClass('is-mobile')
}</script></body></html>