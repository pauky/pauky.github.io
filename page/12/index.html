<!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta name="description" content=""><meta name="keywords" content=""><meta name="author" content="杨润炜"><meta name="copyright" content="杨润炜"><title>Cwalker</title><link rel="shortcut icon" href="/melody-favicon.ico"><link rel="stylesheet" href="/css/index.css?version=1.9.1"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@latest/css/font-awesome.min.css?version=1.9.1"><meta name="format-detection" content="telephone=no"><meta http-equiv="x-dns-prefetch-control" content="on"><link rel="dns-prefetch" href="https://cdn.jsdelivr.net"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  copy: {
    success: 'Copy successfully',
    error: 'Copy error',
    noSupport: 'The browser does not support'
  },
  hexoVersion: '6.3.0'
} </script><meta name="generator" content="Hexo 6.3.0"></head><body><i class="fa fa-arrow-right" id="toggle-sidebar" aria-hidden="true"></i><div id="sidebar" data-display="false"><div class="author-info"><div class="author-info__avatar text-center"><img src="/img/avatar.png"></div><div class="author-info__name text-center">杨润炜</div><div class="author-info__description text-center"></div><hr><div class="author-info-articles"><a class="author-info-articles__archives article-meta" href="/archives"><span class="pull-left">Articles</span><span class="pull-right">137</span></a><a class="author-info-articles__tags article-meta" href="/tags"><span class="pull-left">Tags</span><span class="pull-right">30</span></a><a class="author-info-articles__categories article-meta" href="/categories"><span class="pull-left">Categories</span><span class="pull-right">2</span></a></div></div></div><nav class="no-bg" id="nav"><div id="page-header"><span class="pull-left"> <a id="site-name" href="/">Cwalker</a></span><i class="fa fa-bars toggle-menu pull-right" aria-hidden="true"></i><span class="pull-right"></span></div><div id="site-info"><div id="site-title">Cwalker</div><div id="site-sub-title"></div></div></nav><div id="content-outer"><div class="layout" id="content-inner"><div class="recent-post-item article-container"><a class="article-title" href="/a/27.html">javascript逻辑运算符的运用</a><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2016-02-15</time><span class="article-meta"><span class="article-meta__separator">|</span><i class="fa fa-inbox article-meta__icon" aria-hidden="true"></i><a class="article-meta__categories" href="/categories/tech/">tech</a></span><span class="article-meta tags"><span class="article-meta__separator">|</span><i class="fa fa-tag article-meta__icon" aria-hidden="true"></i><a class="article-meta__tags" href="/tags/js/">js</a></span><div class="content"><p>Javascript的逻辑运算符包括&amp;&amp;(and)，||(or)，！(not)。</p>
<p>##与判断语句结合使用<br>一般我们用来跟if…else等判断语句结果使用。如</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">if (a &amp;&amp; b) &#123;</span><br><span class="line">	console.log(&#x27;123&#x27;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>##连接判断条件与结果<br>为了使代码更简洁，我们可以使用逻辑运算符，把判断条件放在其左方，结果放在右方。将上面代码简化为：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(a &amp;&amp; b) &amp;&amp; (console.log(&#x27;123&#x27;));</span><br></pre></td></tr></table></figure>
<p>或</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">a &amp;&amp; b &amp;&amp; (console.log(&#x27;123&#x27;));</span><br></pre></td></tr></table></figure>
<p>注意右方的结果语句需要加上括号，不然会报错。<br>这两个代码的执行结果都是一样的，说明逻辑运算符是从左向右逐个运算的。这点常常在实际中被开发者忽略，须谨记。</p>
<p>##运用在赋值运算中<br>有时候需要给一个变量在不同条件下赋予不同的值，这时也可以运用逻辑运算符来达到目的，且更简洁。<br>一般情况下的处理：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">var a = 1;</span><br><span class="line">if (new Date().getDay() === 1) &#123;</span><br><span class="line">	a = 100;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>运算逻辑运算符：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">var a = new Date().getDay() === 1 &amp;&amp; 100 || 1;</span><br></pre></td></tr></table></figure>
<p>可能有个别开发者会怀疑得到的a值可能是true或者false这些布尔值，但实际去是能够得到100或者1的。这是因为逻辑运算符产生的结果并不全是布尔值，而是最后能到达的那个值。<br>下面我们看看示例，就明白了。打开chrome控制台，输入以下运算，得到答案。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">// 2</span><br><span class="line">true &amp;&amp; 1 &amp;&amp; 2</span><br><span class="line"></span><br><span class="line">// 1</span><br><span class="line">1 || 3</span><br><span class="line"></span><br><span class="line">// 3</span><br><span class="line">false || 3</span><br><span class="line"></span><br><span class="line">// true</span><br><span class="line">true || 2</span><br><span class="line"></span><br><span class="line">// false</span><br><span class="line">false &amp;&amp; 6</span><br></pre></td></tr></table></figure>
</div><hr></div><div class="recent-post-item article-container"><a class="article-title" href="/a/25.html">如何创造奇迹？</a><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2016-02-01</time><span class="article-meta"><span class="article-meta__separator">|</span><i class="fa fa-inbox article-meta__icon" aria-hidden="true"></i><a class="article-meta__categories" href="/categories/life/">life</a></span><span class="article-meta tags"><span class="article-meta__separator">|</span><i class="fa fa-tag article-meta__icon" aria-hidden="true"></i><a class="article-meta__tags" href="/tags/read/">read</a></span><div class="content"><p>济南铁公，挂出大明太祖神牌，让朱棣攻城的大炮屁都不敢放一个，挽救了济南，更是当时的救世英雄。</p>
<h2 id="如何创造奇迹"><a href="#如何创造奇迹" class="headerlink" title="如何创造奇迹"></a>如何创造奇迹</h2><p>当时南军被朱棣军队打得四散溃败，济南城守军更是溃不成军，铁铉此时来守城，面对朱棣的兵强马壮，士气高昂之师，并没有所把握守住城池，打败北军，除非出现奇迹。然而铁铉的决心使得他义无反顾地来济南城，召集残兵败将来抵抗。一介书生，未有打仗经验的他，面对战争残酷的撕杀，是他的不惧身死的勇气支撑着他参与到这一场残酷的争斗中。更使他坚定报国决心的是他的朋友高巍和盛庸，遇到志同道合的人，会让自己更加认同自己走的路，然后与其携手一同走下去。就这样，朱棣军队居然让一个临时组建起来的守城军打跑了，让我不得不惊叹这一奇迹，它将一直被济南人民，被后世的人们传颂下去。<br>这也让我想起了为什么宠物小精灵里的小智总能战胜强大的对手，因为他有敢于向强大敌人挑战、勇往直前的勇气，有实现梦想的决心，有同甘共苦的伙伴，这样才让他每次都创造震撼人心的奇迹。<br>许许多多的故事里的奇迹产生都是按这样的规律来的，无论是虚构的还是现实存在过的奇迹。<br>记住，勇气、决心、朋友，在未来的路上收集它们，创造属于自己的奇迹吧，加油。</p>
</div><hr></div><div class="recent-post-item article-container"><a class="article-title" href="/a/24.html">mongodb结果集默认排序</a><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2016-01-30</time><span class="article-meta"><span class="article-meta__separator">|</span><i class="fa fa-inbox article-meta__icon" aria-hidden="true"></i><a class="article-meta__categories" href="/categories/tech/">tech</a></span><span class="article-meta tags"><span class="article-meta__separator">|</span><i class="fa fa-tag article-meta__icon" aria-hidden="true"></i><a class="article-meta__tags" href="/tags/mongodb/">mongodb</a></span><div class="content"><h2 id="问题描述"><a href="#问题描述" class="headerlink" title="问题描述"></a>问题描述</h2><p>使用mongodb时，我们常会传一个_id数组，然后查询表里_id字段等于该数组某个元素的记录，返回出结果集。如：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.inventory.find( &#123; _id: &#123; $in: [ 15, 5 ] &#125; &#125; )</span><br></pre></td></tr></table></figure>
<p>这个语句表示查询inventory文档里_id为15或5的记录。<br>这本来没有什么好说的。但问题出在了最后的结果集上。我们期望的结果集是：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&#123;_id: 15, data: ...&#125;</span><br><span class="line">&#123;_id: 5, data: ...&#125;</span><br></pre></td></tr></table></figure>
<p>然而现实却不尽人意，真正的结果是：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&#123;_id: 5, data: ...&#125;</span><br><span class="line">&#123;_id: 15, data: ...&#125;</span><br></pre></td></tr></table></figure>

<h2 id="问题分析与解决"><a href="#问题分析与解决" class="headerlink" title="问题分析与解决"></a>问题分析与解决</h2><p>在上述查询代码中，我们并没有指定sort条件，但mongodb返回的结果集却像是按_id排序过的。经过反复试验，在我们没指定sort条件时，mongodb确实会按照自然排序（_id的大小）对结果集进行排序。如果要达到自己预期的结果，我的做法是在返回结果集上，自己用程序再进行一次排序。跟踪<a target="_blank" rel="noopener" href="https://segmentfault.com/q/1010000000095495">segmentfault的这个问答</a>，可能之后会有更好的解决方案。</p>
</div><hr></div><div class="recent-post-item article-container"><a class="article-title" href="/a/23.html">慈爱的大脚马皇后</a><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2016-01-28</time><span class="article-meta"><span class="article-meta__separator">|</span><i class="fa fa-inbox article-meta__icon" aria-hidden="true"></i><a class="article-meta__categories" href="/categories/life/">life</a></span><span class="article-meta tags"><span class="article-meta__separator">|</span><i class="fa fa-tag article-meta__icon" aria-hidden="true"></i><a class="article-meta__tags" href="/tags/read/">read</a></span><div class="content"><p>快看完《明朝那些事儿》的第一部了，最让我感动的是人当属马皇后了。她是明朝开国皇帝朱元璋的第一任夫人，明朝第一贤后。</p>
<p>##患难现真情<br>马皇后跟朱元璋可谓是患难夫妻。朱元璋投军郭子兴时，她作为郭子兴的义女嫁于他，并在朱元璋被郭子兴关禁闭时，冒着危险给朱元璋送饭；即使当朱元璋几乎一无所有（从郭子兴营出走，只剩下部下24人），她还是不离不弃；打仗时，她还为军队做后勤保障，保管军队文书，与夫君共同抗敌。</p>
<p>##富而不奢，贵而不骄<br>即使成为了皇后，生活还是那么简朴；富贵时也清醒地认识到不能忘记民间疾苦，权力大了，还提出了“愿得贤人共理天下”的见解。相比朱元璋的这种权力欲望狂，已经强一个级别了，更另说蓝玉那种给三分颜色就做染坊的狂妄之徒了。</p>
<p>##始终用爱关怀他人<br>跟当时朱元璋的杀人如麻，简直是鲜明的对比。且不说她可能因为顾全大局而挽救了朱文正、李文忠、宋濂等人，就在她重病卧床急需医治时却不让太医为其医治，原因只是怕朱元璋认为太医无能医治不好马皇后而杀害无辜。这是一个始终用爱去关怀他人的高尚灵魂。</p>
<p>马皇后最后留给朱元璋的话是：“愿陛下求贤纳谏，有始有终，愿子孙个个贤能，百姓安居乐业，江山成年不朽”。有妻如此，夫得何求啊！可能直到她死时，朱元璋才知道这个人才是他的一切。</p>
<p>当年没房没车没前途的朱元璋能泡到马皇后这样的贤妻良母，并且患难不离弃、富贵不多求，说实话，心中只有满满的羡慕嫉妒恨。</p>
</div><hr></div><div class="recent-post-item article-container"><a class="article-title" href="/a/21.html">mongodb 数组操作运算符</a><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2016-01-27</time><span class="article-meta"><span class="article-meta__separator">|</span><i class="fa fa-inbox article-meta__icon" aria-hidden="true"></i><a class="article-meta__categories" href="/categories/tech/">tech</a></span><span class="article-meta tags"><span class="article-meta__separator">|</span><i class="fa fa-tag article-meta__icon" aria-hidden="true"></i><a class="article-meta__tags" href="/tags/mongodb/">mongodb</a></span><div class="content"><p>mongodb对于使用node.js开发的人来说应该不陌生，她与node.js的结合，十分的和谐且高效。接下来介绍一下mongodb的数组运算符,它们分别是$(update), $addToSet, $pop, $pullAll, $pull, $pushAll, $push, $each, $slice, $sort 与 $position，让我们来看看它们是怎样来为我们操作mongodb的数组字段的。</p>
<h2 id="update"><a href="#update" class="headerlink" title="$(update)"></a>$(update)</h2><p>简述：可以用来更新数组字段里是某个属性<br>用法：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123; &quot;&lt;array&gt;.$&quot; : value &#125;</span><br></pre></td></tr></table></figure>
<p>示例：<br>students表的原始数据</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123; &quot;_id&quot; : 1, grade: 80, mean: 75, &quot;grades&quot; : [ 80, 85, 90 ]， std： 1 &#125;</span><br></pre></td></tr></table></figure>
<h5 id="1-更新数组中的元素"><a href="#1-更新数组中的元素" class="headerlink" title="1.更新数组中的元素"></a>1.更新数组中的元素</h5><p>具体代码</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">db.students.update(</span><br><span class="line">   &#123; _id: 1, grades: 80 &#125;,</span><br><span class="line">   &#123; $set: &#123; &quot;grades.$&quot; : 82 &#125; &#125;</span><br><span class="line">)</span><br></pre></td></tr></table></figure>
<p>结果</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123; &quot;_id&quot; : 1, grade: 80, mean: 75, &quot;grades&quot; : [ 82, 85, 90 ]， std： 6 &#125;</span><br></pre></td></tr></table></figure>

<h5 id="2-多条件更新"><a href="#2-多条件更新" class="headerlink" title="2.多条件更新"></a>2.多条件更新</h5><p>具体代码</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">db.students.update(</span><br><span class="line">   &#123;</span><br><span class="line">     _id: 4,</span><br><span class="line">     grades: &#123; $elemMatch: &#123; grade: &#123; $lte: 90 &#125;, mean: &#123; $gt: 70 &#125; &#125; &#125;</span><br><span class="line">   &#125;,</span><br><span class="line">   &#123; $set: &#123; &quot;grades.$.std&quot; : 6 &#125; &#125;</span><br><span class="line">)</span><br></pre></td></tr></table></figure>
<p>结果</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123; &quot;_id&quot; : 1, grade: 80, mean: 75, &quot;grades&quot; : [ 80, 85, 90 ]， std： 6 &#125;</span><br></pre></td></tr></table></figure>

<p>小结：可以将$(update)运算符类比为js数组操作里的splice方法，只是不通过索引，而是通过具体的元素值比较。<br>用到的相关运算符： <a target="_blank" rel="noopener" href="https://docs.mongodb.org/manual/reference/operator/update/set/">$set</a>，<a target="_blank" rel="noopener" href="https://docs.mongodb.org/manual/reference/operator/query/elemMatch/">$elemMatch</a></p>
<h2 id="addToSet"><a href="#addToSet" class="headerlink" title="$addToSet"></a>$addToSet</h2><p>简述：将元素添加进数组字段，且不重复。这也正是set这一数据结构的特性。<br>用法：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123; $addToSet: &#123; &lt;field1&gt;: &lt;value1&gt;, ... &#125; &#125;</span><br></pre></td></tr></table></figure>
<p>示例：<br>inventory表的原始数据</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123; _id: 1, item: &quot;polarizing_filter&quot;, tags: [ &quot;electronics&quot;, &quot;camera&quot; ] &#125;</span><br></pre></td></tr></table></figure>
<h5 id="1-添加一个元素"><a href="#1-添加一个元素" class="headerlink" title="1.添加一个元素"></a>1.添加一个元素</h5><p>具体代码</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">db.inventory.update(</span><br><span class="line">   &#123; _id: 1 &#125;,</span><br><span class="line">   &#123; $addToSet: &#123; tags: &quot;accessories&quot; &#125; &#125;</span><br><span class="line">)</span><br></pre></td></tr></table></figure>
<p>结果</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123; _id: 1, item: &quot;polarizing_filter&quot;, tags: [ &quot;electronics&quot;, &quot;camera&quot;, &quot;accessories&quot; ] &#125;</span><br></pre></td></tr></table></figure>

<h5 id="2-添加多个元素"><a href="#2-添加多个元素" class="headerlink" title="2.添加多个元素"></a>2.添加多个元素</h5><p>具体代码</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">db.inventory.update(</span><br><span class="line">   &#123; _id: 1 &#125;,</span><br><span class="line">   &#123; $addToSet: &#123; tags: &#123; $each: [ &quot;camera&quot;, &quot;electronics&quot;, &quot;accessories&quot;, &quot;supplies&quot; ] &#125; &#125; &#125;</span><br><span class="line"> )</span><br></pre></td></tr></table></figure>
<p>结果</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123; _id: 1, item: &quot;polarizing_filter&quot;, tags: [ &quot;electronics&quot;, &quot;camera&quot;, &quot;accessories&quot;, &quot;supplies&quot; ] &#125;</span><br></pre></td></tr></table></figure>

<p>小结：利用$addToSet操作数组，我们可以不用去检测重复，十分方便，结合$each，可以直接传入数组，类似于js数组的concat方法，区别在于结果是个元素唯一的数组。</p>
<h2 id="pop"><a href="#pop" class="headerlink" title="$pop"></a>$pop</h2><p>简述：删除数组字段的第一个或最后一个元素。<br>用法：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123; $pop: &#123; &lt;field&gt;: &lt;-1 | 1&gt;, ... &#125; &#125;</span><br></pre></td></tr></table></figure>
<p>示例：<br>students表的原始数据</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123; _id: 1, scores: [ 8, 9, 10 ] &#125;</span><br></pre></td></tr></table></figure>
<h5 id="1-删除第一个元素"><a href="#1-删除第一个元素" class="headerlink" title="1.删除第一个元素"></a>1.删除第一个元素</h5><p>具体代码</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.students.update( &#123; _id: 1 &#125;, &#123; $pop: &#123; scores: -1 &#125; &#125; )</span><br></pre></td></tr></table></figure>
<p>结果</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123; _id: 1, scores: [ 9, 10 ] &#125;</span><br></pre></td></tr></table></figure>

<h5 id="2-删除最后一个元素"><a href="#2-删除最后一个元素" class="headerlink" title="2.删除最后一个元素"></a>2.删除最后一个元素</h5><p>具体代码</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.students.update( &#123; _id: 1 &#125;, &#123; $pop: &#123; scores: 1 &#125; &#125; )</span><br></pre></td></tr></table></figure>
<p>结果</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123; _id: 1, scores: [ 8, 9 ] &#125;</span><br></pre></td></tr></table></figure>

<p>小结：传入-1参数时，相当于js数组操作的shift方法；传入1参数时，相当于js数组操作的pop方法。</p>
<h2 id="pullAll"><a href="#pullAll" class="headerlink" title="$pullAll"></a>$pullAll</h2><p>简述：删除匹配的列表值的所有数组字段元素。<br>用法：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123; $pullAll: &#123; &lt;field1&gt;: [ &lt;value1&gt;, &lt;value2&gt; ... ], ... &#125; &#125;</span><br></pre></td></tr></table></figure>
<p>示例：<br>survey表的原始数据</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123; _id: 1, scores: [ 0, 2, 5, 5, 1, 0 ] &#125;</span><br></pre></td></tr></table></figure>
<p>具体代码</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.survey.update( &#123; _id: 1 &#125;, &#123; $pullAll: &#123; scores: [ 0, 5 ] &#125; &#125; )</span><br></pre></td></tr></table></figure>
<p>结果</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123; &quot;_id&quot; : 1, &quot;scores&quot; : [ 2, 1 ] &#125;</span><br></pre></td></tr></table></figure>

<p>小结：与$pull不同的是，$pullAll只是通过匹配列表值来删除元素，也就是说可以传入数组参数，然后比较两个数组的交集来进行删除，而前者是通过指定一个查询条件。</p>
<h2 id="pull"><a href="#pull" class="headerlink" title="$pull"></a>$pull</h2><p>简述：通过指定一个查询条件来删除所有符合条件的数组字段元素<br>用法：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123; $pull: &#123; &lt;field1&gt;: &lt;value|condition&gt;, &lt;field2&gt;: &lt;value|condition&gt;, ... &#125; &#125;</span><br></pre></td></tr></table></figure>
<p>示例：</p>
<h4 id="通过指定值删除"><a href="#通过指定值删除" class="headerlink" title="通过指定值删除"></a>通过指定值删除</h4><p>stores表的原始数据</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">   _id: 1,</span><br><span class="line">   fruits: [ &quot;apples&quot;, &quot;pears&quot;, &quot;oranges&quot;, &quot;grapes&quot;, &quot;bananas&quot; ],</span><br><span class="line">   vegetables: [ &quot;carrots&quot;, &quot;celery&quot;, &quot;squash&quot;, &quot;carrots&quot; ]</span><br><span class="line">&#125;</span><br><span class="line">&#123;</span><br><span class="line">   _id: 2,</span><br><span class="line">   fruits: [ &quot;plums&quot;, &quot;kiwis&quot;, &quot;oranges&quot;, &quot;bananas&quot;, &quot;apples&quot; ],</span><br><span class="line">   vegetables: [ &quot;broccoli&quot;, &quot;zucchini&quot;, &quot;carrots&quot;, &quot;onions&quot; ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>具体代码</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">db.stores.update(</span><br><span class="line">    &#123; &#125;,</span><br><span class="line">    &#123; $pull: &#123; fruits: &#123; $in: [ &quot;apples&quot;, &quot;oranges&quot; ] &#125;, vegetables: &quot;carrots&quot; &#125; &#125;,</span><br><span class="line">    &#123; multi: true &#125;</span><br><span class="line">)</span><br></pre></td></tr></table></figure>
<p>结果</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  &quot;_id&quot; : 1,</span><br><span class="line">  &quot;fruits&quot; : [ &quot;pears&quot;, &quot;grapes&quot;, &quot;bananas&quot; ],</span><br><span class="line">  &quot;vegetables&quot; : [ &quot;celery&quot;, &quot;squash&quot; ]</span><br><span class="line">&#125;</span><br><span class="line">&#123;</span><br><span class="line">  &quot;_id&quot; : 2,</span><br><span class="line">  &quot;fruits&quot; : [ &quot;plums&quot;, &quot;kiwis&quot;, &quot;bananas&quot; ],</span><br><span class="line">  &quot;vegetables&quot; : [ &quot;broccoli&quot;, &quot;zucchini&quot;, &quot;onions&quot; ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="通过查询条件删除"><a href="#通过查询条件删除" class="headerlink" title="通过查询条件删除"></a>通过查询条件删除</h5><p>原始数据</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123; _id: 1, votes: [ 3, 5, 6, 7, 7, 8 ] &#125;</span><br></pre></td></tr></table></figure>
<p>具体代码</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.profiles.update( &#123; _id: 1 &#125;, &#123; $pull: &#123; votes: &#123; $gte: 6 &#125; &#125; &#125; )</span><br></pre></td></tr></table></figure>
<p>结果</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123; _id: 1, votes: [  3,  5 ] &#125;</span><br></pre></td></tr></table></figure>

<h5 id="删除数组里的所有子项"><a href="#删除数组里的所有子项" class="headerlink" title="删除数组里的所有子项"></a>删除数组里的所有子项</h5><p>survey表的原始数据</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">   _id: 1,</span><br><span class="line">   results: [</span><br><span class="line">      &#123; item: &quot;A&quot;, score: 5 &#125;,</span><br><span class="line">      &#123; item: &quot;B&quot;, score: 8, comment: &quot;Strongly agree&quot; &#125;</span><br><span class="line">   ]</span><br><span class="line">&#125;</span><br><span class="line">&#123;</span><br><span class="line">   _id: 2,</span><br><span class="line">   results: [</span><br><span class="line">      &#123; item: &quot;C&quot;, score: 8, comment: &quot;Strongly agree&quot; &#125;,</span><br><span class="line">      &#123; item: &quot;B&quot;, score: 4 &#125;</span><br><span class="line">   ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>具体代码</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">db.survey.update(</span><br><span class="line">  &#123; &#125;,</span><br><span class="line">  &#123; $pull: &#123; results: &#123; score: 8 , item: &quot;B&quot; &#125; &#125; &#125;,</span><br><span class="line">  &#123; multi: true &#125;</span><br><span class="line">)</span><br></pre></td></tr></table></figure>
<p>结果</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">   &quot;_id&quot; : 1,</span><br><span class="line">   &quot;results&quot; : [ &#123; &quot;item&quot; : &quot;A&quot;, &quot;score&quot; : 5 &#125; ]</span><br><span class="line">&#125;</span><br><span class="line">&#123;</span><br><span class="line">  &quot;_id&quot; : 2,</span><br><span class="line">  &quot;results&quot; : [</span><br><span class="line">      &#123; &quot;item&quot; : &quot;C&quot;, &quot;score&quot; : 8, &quot;comment&quot; : &quot;Strongly agree&quot; &#125;,</span><br><span class="line">      &#123; &quot;item&quot; : &quot;B&quot;, &quot;score&quot; : 4 &#125;</span><br><span class="line">   ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里需要注意的是在$pull操作中，会将查询条件应用到每个元素，所以不能使用$elemMatch,用了反而匹配不到正确的元素。<br>如：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">db.survey.update(</span><br><span class="line">  &#123; &#125;,</span><br><span class="line">  &#123; $pull: &#123; results: &#123; $elemMatch: &#123; score: 8 , item: &quot;B&quot; &#125; &#125; &#125; &#125;,</span><br><span class="line">  &#123; multi: true &#125;</span><br><span class="line">)</span><br></pre></td></tr></table></figure>
<p>这样去对原始数据的操作是不能达到预期结果的，结果数据将没有变化。</p>
<p>然而，当我们需要匹配的是数组里嵌套的数组元素，且需要多个条件，那就需要$elemMatch的帮忙了。<br>原始数据</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">   _id: 1,</span><br><span class="line">   results: [</span><br><span class="line">      &#123; item: &quot;A&quot;, score: 5, answers: [ &#123; q: 1, a: 4 &#125;, &#123; q: 2, a: 6 &#125; ] &#125;,</span><br><span class="line">      &#123; item: &quot;B&quot;, score: 8, answers: [ &#123; q: 1, a: 8 &#125;, &#123; q: 2, a: 9 &#125; ] &#125;</span><br><span class="line">   ]</span><br><span class="line">&#125;</span><br><span class="line">&#123;</span><br><span class="line">   _id: 2,</span><br><span class="line">   results: [</span><br><span class="line">      &#123; item: &quot;C&quot;, score: 8, answers: [ &#123; q: 1, a: 8 &#125;, &#123; q: 2, a: 7 &#125; ] &#125;,</span><br><span class="line">      &#123; item: &quot;B&quot;, score: 4, answers: [ &#123; q: 1, a: 0 &#125;, &#123; q: 2, a: 8 &#125; ] &#125;</span><br><span class="line">   ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>具体代码</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">db.survey.update(</span><br><span class="line">  &#123; &#125;,</span><br><span class="line">  &#123; $pull: &#123; results: &#123; answers: &#123; $elemMatch: &#123; q: 2, a: &#123; $gte: 8 &#125; &#125; &#125; &#125; &#125; &#125;,</span><br><span class="line">  &#123; multi: true &#125;</span><br><span class="line">)</span><br></pre></td></tr></table></figure>
<p>结果</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">   &quot;_id&quot; : 1,</span><br><span class="line">   &quot;results&quot; : [</span><br><span class="line">      &#123; &quot;item&quot; : &quot;A&quot;, &quot;score&quot; : 5, &quot;answers&quot; : [ &#123; &quot;q&quot; : 1, &quot;a&quot; : 4 &#125;, &#123; &quot;q&quot; : 2, &quot;a&quot; : 6 &#125; ] &#125;</span><br><span class="line">   ]</span><br><span class="line">&#125;</span><br><span class="line">&#123;</span><br><span class="line">   &quot;_id&quot; : 2,</span><br><span class="line">   &quot;results&quot; : [</span><br><span class="line">      &#123; &quot;item&quot; : &quot;C&quot;, &quot;score&quot; : 8, &quot;answers&quot; : [ &#123; &quot;q&quot; : 1, &quot;a&quot; : 8 &#125;, &#123; &quot;q&quot; : 2, &quot;a&quot; : 7 &#125; ] &#125;</span><br><span class="line">   ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>小结：$pull可以通过指定查询条件来删除所有匹配的元素，如果需要像$pullAll的那样能传入数组进行匹配，那需要$in运算符的帮助。$pull的查询条件会应用到每个数组下的“顶级”元素，所以一般不需要使用$elemMatch，但如果需要匹配到数组里的嵌套数组元素，那就需要$elemMatch运算符的帮助了。</p>
<h2 id="pushAll"><a href="#pushAll" class="headerlink" title="$pushAll"></a>$pushAll</h2><p>2.4版本后移除，可使用$push,$each替代。这里将不作介绍</p>
<h2 id="push"><a href="#push" class="headerlink" title="$push"></a>$push</h2><p>简述：添加数组元素。<br>用法：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123; $push: &#123; &lt;field1&gt;: &lt;value1&gt;, ... &#125; &#125;</span><br></pre></td></tr></table></figure>
<p>或</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123; $push: &#123; &lt;field1&gt;: &#123; &lt;modifier1&gt;: &lt;value1&gt;, ... &#125;, ... &#125; &#125;</span><br></pre></td></tr></table></figure>
<p>示例：</p>
<h5 id="1-添加一个元素-1"><a href="#1-添加一个元素-1" class="headerlink" title="1.添加一个元素"></a>1.添加一个元素</h5><p>students表的原始数据</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;_id: 1, scores: [60, 80, 89]&#125;</span><br></pre></td></tr></table></figure>
<p>具体代码</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">db.students.update(</span><br><span class="line">   &#123; _id: 1 &#125;,</span><br><span class="line">   &#123; $push: &#123; scores: 89 &#125; &#125;</span><br><span class="line">)</span><br></pre></td></tr></table></figure>
<p>结果</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;_id: 1, scores: [60, 80, 89, 89]&#125;</span><br></pre></td></tr></table></figure>
<h5 id="2-添加多个元素-1"><a href="#2-添加多个元素-1" class="headerlink" title="2.添加多个元素"></a>2.添加多个元素</h5><p>具体代码</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">db.students.update(</span><br><span class="line">   &#123; name: &quot;joe&quot; &#125;,</span><br><span class="line">   &#123; $push: &#123; scores: &#123; $each: [ 90, 92, 85 ] &#125; &#125; &#125;</span><br><span class="line">)</span><br></pre></td></tr></table></figure>
<p>结果</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;_id: 1, scores: [60, 80, 89, 90, 92, 85]&#125;</span><br></pre></td></tr></table></figure>

<h5 id="使用多个运算符"><a href="#使用多个运算符" class="headerlink" title="使用多个运算符"></a>使用多个运算符</h5><p>students表的原始数据</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">   &quot;_id&quot; : 5,</span><br><span class="line">   &quot;quizzes&quot; : [</span><br><span class="line">      &#123; &quot;wk&quot;: 1, &quot;score&quot; : 10 &#125;,</span><br><span class="line">      &#123; &quot;wk&quot;: 2, &quot;score&quot; : 8 &#125;,</span><br><span class="line">      &#123; &quot;wk&quot;: 3, &quot;score&quot; : 5 &#125;,</span><br><span class="line">      &#123; &quot;wk&quot;: 4, &quot;score&quot; : 6 &#125;</span><br><span class="line">   ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>具体代码</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">db.students.update(</span><br><span class="line">   &#123; _id: 5 &#125;,</span><br><span class="line">   &#123;</span><br><span class="line">     $push: &#123;</span><br><span class="line">       quizzes: &#123;</span><br><span class="line">          $each: [ &#123; wk: 5, score: 8 &#125;, &#123; wk: 6, score: 7 &#125;, &#123; wk: 7, score: 6 &#125; ],</span><br><span class="line">          $sort: &#123; score: -1 &#125;,</span><br><span class="line">          $slice: 3</span><br><span class="line">       &#125;</span><br><span class="line">     &#125;</span><br><span class="line">   &#125;</span><br><span class="line">)</span><br></pre></td></tr></table></figure>
<p>结果</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  &quot;_id&quot; : 5,</span><br><span class="line">  &quot;quizzes&quot; : [</span><br><span class="line">     &#123; &quot;wk&quot; : 1, &quot;score&quot; : 10 &#125;,</span><br><span class="line">     &#123; &quot;wk&quot; : 2, &quot;score&quot; : 8 &#125;,</span><br><span class="line">     &#123; &quot;wk&quot; : 5, &quot;score&quot; : 8 &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>小结：与$addToSet很类似，区别在于$push可能会使数组字段的元素重复，而$addToSet不会。与js的push效果一样。</p>
<h2 id="each"><a href="#each" class="headerlink" title="$each"></a>$each</h2><p>简述：与$push,$addToSet结合，实现向数组字段添加多个元素的效果，类似于js的concat<br>用法与示例请见上方$addToSet与$push。</p>
<h2 id="slice"><a href="#slice" class="headerlink" title="$slice"></a>$slice</h2><p>简述：限制指定数值的数组字段元素。<br>用法：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  $push: &#123;</span><br><span class="line">     &lt;field&gt;: &#123;</span><br><span class="line">       $each: [ &lt;value1&gt;, &lt;value2&gt;, ... ],</span><br><span class="line">       $slice: &lt;num&gt;</span><br><span class="line">     &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>示例</p>
<h5 id="1-从数组末尾开始截取"><a href="#1-从数组末尾开始截取" class="headerlink" title="1.从数组末尾开始截取"></a>1.从数组末尾开始截取</h5><p>原始数据</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123; &quot;_id&quot; : 1, &quot;scores&quot; : [ 40, 50, 60 ] &#125;</span><br></pre></td></tr></table></figure>
<p>具体代码</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">db.students.update(</span><br><span class="line">   &#123; _id: 1 &#125;,</span><br><span class="line">   &#123;</span><br><span class="line">     $push: &#123;</span><br><span class="line">       scores: &#123;</span><br><span class="line">         $each: [ 80, 78, 86 ],</span><br><span class="line">         $slice: -5</span><br><span class="line">       &#125;</span><br><span class="line">     &#125;</span><br><span class="line">   &#125;</span><br><span class="line">)</span><br></pre></td></tr></table></figure>
<p>结果</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123; &quot;_id&quot; : 1, &quot;scores&quot; : [  50,  60,  80,  78,  86 ] &#125;</span><br></pre></td></tr></table></figure>

<h5 id="2-从数组头部开始截取"><a href="#2-从数组头部开始截取" class="headerlink" title="2.从数组头部开始截取"></a>2.从数组头部开始截取</h5><p>原始数据</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123; &quot;_id&quot; : 2, &quot;scores&quot; : [ 89, 90 ] &#125;</span><br></pre></td></tr></table></figure>
<p>具体代码</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">db.students.update(</span><br><span class="line">   &#123; _id: 2 &#125;,</span><br><span class="line">   &#123;</span><br><span class="line">     $push: &#123;</span><br><span class="line">       scores: &#123;</span><br><span class="line">         $each: [ 100, 20 ],</span><br><span class="line">         $slice: 3</span><br><span class="line">       &#125;</span><br><span class="line">     &#125;</span><br><span class="line">   &#125;</span><br><span class="line">)</span><br></pre></td></tr></table></figure>
<p>结果</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123; &quot;_id&quot; : 2, &quot;scores&quot; : [  89,  90,  100 ] &#125;</span><br></pre></td></tr></table></figure>

<h5 id="只使用-slice来更新数组"><a href="#只使用-slice来更新数组" class="headerlink" title="只使用$slice来更新数组"></a>只使用$slice来更新数组</h5><p>原始数据</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123; &quot;_id&quot; : 3, &quot;scores&quot; : [  89,  70,  100,  20 ] &#125;</span><br></pre></td></tr></table></figure>
<p>具体代码</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">db.students.update(</span><br><span class="line">  &#123; _id: 3 &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    $push: &#123;</span><br><span class="line">      scores: &#123;</span><br><span class="line">         $each: [ ],</span><br><span class="line">         $slice: -3</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">)</span><br></pre></td></tr></table></figure>
<p>结果</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123; &quot;_id&quot; : 3, &quot;scores&quot; : [  70,  100,  20 ] &#125;</span><br></pre></td></tr></table></figure>

<h5 id="与-push的相关运算符一起使用"><a href="#与-push的相关运算符一起使用" class="headerlink" title="与$push的相关运算符一起使用"></a>与$push的相关运算符一起使用</h5><p>见$push运算符的讲解。</p>
<p>小结：$slice主要是与$push相结合，来从数组头部或末尾开始截取数组元素的。在后面版本（官方上称2.6开始）将不强制$slice与$each结合使用。</p>
<h2 id="sort"><a href="#sort" class="headerlink" title="$sort"></a>$sort</h2><p>简述：对数组字段的元素进行排序。<br>用法：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  $push: &#123;</span><br><span class="line">     &lt;field&gt;: &#123;</span><br><span class="line">       $each: [ &lt;value1&gt;, &lt;value2&gt;, ... ],</span><br><span class="line">       $sort: &lt;sort specification&gt;</span><br><span class="line">     &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>示例：</p>
<h5 id="1-利用数组元素对数组进行排序"><a href="#1-利用数组元素对数组进行排序" class="headerlink" title="1.利用数组元素对数组进行排序"></a>1.利用数组元素对数组进行排序</h5><p>原始数据</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  &quot;_id&quot;: 1,</span><br><span class="line">  &quot;quizzes&quot;: [</span><br><span class="line">    &#123; &quot;id&quot; : 1, &quot;score&quot; : 6 &#125;,</span><br><span class="line">    &#123; &quot;id&quot; : 2, &quot;score&quot; : 9 &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>具体代码</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">db.students.update(</span><br><span class="line">   &#123; _id: 1 &#125;,</span><br><span class="line">   &#123;</span><br><span class="line">     $push: &#123;</span><br><span class="line">       quizzes: &#123;</span><br><span class="line">         $each: [ &#123; id: 3, score: 8 &#125;, &#123; id: 4, score: 7 &#125;, &#123; id: 5, score: 6 &#125; ],</span><br><span class="line">         $sort: &#123; score: 1 &#125;</span><br><span class="line">       &#125;</span><br><span class="line">     &#125;</span><br><span class="line">   &#125;</span><br><span class="line">)</span><br></pre></td></tr></table></figure>
<p>结果</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  &quot;_id&quot; : 1,</span><br><span class="line">  &quot;quizzes&quot; : [</span><br><span class="line">     &#123; &quot;id&quot; : 1, &quot;score&quot; : 6 &#125;,</span><br><span class="line">     &#123; &quot;id&quot; : 5, &quot;score&quot; : 6 &#125;,</span><br><span class="line">     &#123; &quot;id&quot; : 4, &quot;score&quot; : 7 &#125;,</span><br><span class="line">     &#123; &quot;id&quot; : 3, &quot;score&quot; : 8 &#125;,</span><br><span class="line">     &#123; &quot;id&quot; : 2, &quot;score&quot; : 9 &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="2-直接对数组进行排序"><a href="#2-直接对数组进行排序" class="headerlink" title="2.直接对数组进行排序"></a>2.直接对数组进行排序</h5><p>原始数据</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123; &quot;_id&quot; : 2, &quot;tests&quot; : [  89,  70,  89,  50 ] &#125;</span><br></pre></td></tr></table></figure>
<p>具体代码</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">db.students.update(</span><br><span class="line">   &#123; _id: 2 &#125;,</span><br><span class="line">   &#123; $push: &#123; tests: &#123; $each: [ 40, 60 ], $sort: 1 &#125; &#125; &#125;</span><br><span class="line">)</span><br></pre></td></tr></table></figure>
<p>结果</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123; &quot;_id&quot; : 2, &quot;tests&quot; : [  40,  50,  60,  70,  89,  89 ] &#125;</span><br></pre></td></tr></table></figure>

<h5 id="3-只排序，不更新数组"><a href="#3-只排序，不更新数组" class="headerlink" title="3.只排序，不更新数组"></a>3.只排序，不更新数组</h5><p>原始数据</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123; &quot;_id&quot; : 3, &quot;tests&quot; : [  89,  70,  100,  20 ] &#125;</span><br></pre></td></tr></table></figure>
<p>具体代码</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">db.students.update(</span><br><span class="line">   &#123; _id: 3 &#125;,</span><br><span class="line">   &#123; $push: &#123; tests: &#123; $each: [ ], $sort: -1 &#125; &#125; &#125;</span><br><span class="line">)</span><br></pre></td></tr></table></figure>
<p>结果</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123; &quot;_id&quot; : 3, &quot;tests&quot; : [ 100,  89,  70,  20 ] &#125;</span><br></pre></td></tr></table></figure>

<h5 id="4-与-push的相关运算符一起使用"><a href="#4-与-push的相关运算符一起使用" class="headerlink" title="4.与$push的相关运算符一起使用"></a>4.与$push的相关运算符一起使用</h5><p>见$push运算符的讲解。</p>
<p>小结：$sort为1时，表示按数值的从小到大排序；为-1时，则反过来。在后面版本（官方上称2.6开始）将不强制$slice与$each结合使用，这点与$slice相同。</p>
<h2 id="position"><a href="#position" class="headerlink" title="$position"></a>$position</h2><p>简述：与$push结合使用，表示元素添加的开始位置。<br>用法：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  $push: &#123;</span><br><span class="line">    &lt;field&gt;: &#123;</span><br><span class="line">       $each: [ &lt;value1&gt;, &lt;value2&gt;, ... ],</span><br><span class="line">       $position: &lt;num&gt;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>示例：</p>
<h5 id="1-从数组的起始位置开始添加"><a href="#1-从数组的起始位置开始添加" class="headerlink" title="1.从数组的起始位置开始添加"></a>1.从数组的起始位置开始添加</h5><p>原始数据</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123; &quot;_id&quot; : 1, &quot;scores&quot; : [ 100 ] &#125;</span><br></pre></td></tr></table></figure>
<p>具体代码</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">db.students.update(</span><br><span class="line">   &#123; _id: 1 &#125;,</span><br><span class="line">   &#123;</span><br><span class="line">     $push: &#123;</span><br><span class="line">        scores: &#123;</span><br><span class="line">           $each: [ 50, 60, 70 ],</span><br><span class="line">           $position: 0</span><br><span class="line">        &#125;</span><br><span class="line">     &#125;</span><br><span class="line">   &#125;</span><br><span class="line">)</span><br></pre></td></tr></table></figure>
<p>结果</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123; &quot;_id&quot; : 1, &quot;scores&quot; : [  50,  60,  70,  100 ] &#125;</span><br></pre></td></tr></table></figure>
<h5 id="2-把元素添加到原来的数组元素之间"><a href="#2-把元素添加到原来的数组元素之间" class="headerlink" title="2.把元素添加到原来的数组元素之间"></a>2.把元素添加到原来的数组元素之间</h5><p>原始数据</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123; &quot;_id&quot; : 1, &quot;scores&quot; : [  50,  60,  70,  100 ] &#125;</span><br></pre></td></tr></table></figure>
<p>具体代码</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">db.students.update(</span><br><span class="line">   &#123; _id: 1 &#125;,</span><br><span class="line">   &#123;</span><br><span class="line">     $push: &#123;</span><br><span class="line">        scores: &#123;</span><br><span class="line">           $each: [ 20, 30 ],</span><br><span class="line">           $position: 2</span><br><span class="line">        &#125;</span><br><span class="line">     &#125;</span><br><span class="line">   &#125;</span><br><span class="line">)</span><br></pre></td></tr></table></figure>
<p>结果</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123; &quot;_id&quot; : 1, &quot;scores&quot; : [  50,  60,  20,  30,  70,  100 ] &#125;</span><br></pre></td></tr></table></figure>

<p>小结：本来$push是默认从数组的末尾开始添加的元素的，但$position可以指定元素添加的开始位置。</p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>在mongodb中利用这些数组操作的运算符，将大大提高操作的效率和方便性，让你感觉就是在利用动态语言操作数组一样方便快捷。</p>
<h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><p><a target="_blank" rel="noopener" href="http://docs.mongoing.com/manual/reference/operator/update-array.html">mongodb-v3.2操作手册</a><br><a target="_blank" rel="noopener" href="http://www.w3school.com.cn/jsref/jsref_obj_array.asp">js数组操作</a></p>
</div><hr></div><div class="recent-post-item article-container"><a class="article-title" href="/a/22.html">express返回 413 Payload Too Large</a><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2016-01-27</time><span class="article-meta"><span class="article-meta__separator">|</span><i class="fa fa-inbox article-meta__icon" aria-hidden="true"></i><a class="article-meta__categories" href="/categories/tech/">tech</a></span><span class="article-meta tags"><span class="article-meta__separator">|</span><i class="fa fa-tag article-meta__icon" aria-hidden="true"></i><a class="article-meta__tags" href="/tags/node-js/">node.js</a><span class="article-meta__link">-</span><i class="fa fa-tag article-meta__icon" aria-hidden="true"></i><a class="article-meta__tags" href="/tags/nginx/">nginx</a></span><div class="content"><h2 id="偶遇413"><a href="#偶遇413" class="headerlink" title="偶遇413"></a>偶遇413</h2><p>在某次提交数据时，后台返回了413错误，如图所示：<br><img src="https://yrw-blog.oss-cn-shenzhen.aliyuncs.com/article-img/20160127/72e8108d-d3c2-4751-8cac-64c5cea3e37e--22-1.png" alt="413-http-error" title="413-http-error"></p>
<h2 id="问题分析"><a href="#问题分析" class="headerlink" title="问题分析"></a>问题分析</h2><p>一开始还以为是nignx，因为百度“ 413 Payload Too Large”时，大部分返回的是关于nginx。所以我也着手修改了nginx的配置：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">client_max_body_size 50M;</span><br></pre></td></tr></table></figure>
<p>限制提交的body大小最大可达50M。然而并没有什么卵用。后台还是照样返回413。<br>再回过头来仔细看了一下后台返回的错误描述（chrome控制台的preview）内容，如图所示：<br><img src="https://yrw-blog.oss-cn-shenzhen.aliyuncs.com/article-img/20160127/eb1f5e55-0562-4ec4-a1ef-6f926267e027--22-2.png" alt="preview内容" title="preview内容"><br>这个说明是后台程序抛出的错误，因为这里显示捕获错误的位置在node.js的模块中。<br>换了个思路，找到了<a target="_blank" rel="noopener" href="http://stackoverflow.com/questions/19917401/node-js-express-request-entity-too-large">stackoverflow上的有关问答</a><br>原来body-parser这个模块会对提交json默认限制在1mb。</p>
<h2 id="解决方法"><a href="#解决方法" class="headerlink" title="解决方法"></a>解决方法</h2><p>在express启动文件中加入以下代码：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">app.<span class="title function_">use</span>(express.<span class="title function_">json</span>(&#123;<span class="attr">limit</span>: <span class="string">&#x27;50mb&#x27;</span>&#125;));</span><br></pre></td></tr></table></figure>
<p>重启即可。</p>
</div><hr></div><div class="recent-post-item article-container"><a class="article-title" href="/a/20.html">顺者昌，逆者亡</a><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2016-01-26</time><span class="article-meta"><span class="article-meta__separator">|</span><i class="fa fa-inbox article-meta__icon" aria-hidden="true"></i><a class="article-meta__categories" href="/categories/life/">life</a></span><span class="article-meta tags"><span class="article-meta__separator">|</span><i class="fa fa-tag article-meta__icon" aria-hidden="true"></i><a class="article-meta__tags" href="/tags/read/">read</a></span><div class="content"><p>如果在我最爱看的书的类型中排个榜，那历史书肯定是名列前茅。<br>最近在阅读当年明月的《明朝的那些事儿》，讲述的是明朝的历史。书中包含了作者对历史规律的总结，正符合我看历史书的初衷——了解历史发展的规律，所以我觉得这是非常棒的历史读物。<br>现在第一本还没看完，这里纯属有感而发，记录下自己对朱元璋废除宰相的一些看法。</p>
<h3 id="朱元璋废宰相"><a href="#朱元璋废宰相" class="headerlink" title="朱元璋废宰相"></a>朱元璋废宰相</h3><p>朱元璋费尽心思，干掉了当朝宰相胡惟庸，也以胡之罪大恶极而废除了延续千年的宰相制度。本来他以为这样可以更加加强中央集权，事实确实如此，权力全部掌握在了皇帝一人手里，但没想到的是，权力越大，责任越大，国家的所有大大小小的事情全都压在了朱无璋一人肩上。</p>
<h3 id="标新立异前，请保持冷静"><a href="#标新立异前，请保持冷静" class="headerlink" title="标新立异前，请保持冷静"></a>标新立异前，请保持冷静</h3><p>之前的皇帝又不是草包，当然不会把自己的天下白白与他人分享，之所以需要宰相这个角色，需要宰相制度这个规则，当然是根据国家和皇帝的实际情况来决定的。朱元璋想凭一已之力，对抗整个历史洪流，必然将是以失败收场。历史也证明了这一点，明朝后来还建立了其它的部门来帮忙处理政务，权力更甚于之前的宰相。唉，早知如此，何必当初呢？<br>同样当我们程序员做项目时，如果能有机会站在巨人肩膀上的话，尽可能别自己“标新立异“地来一套，我有时就被自己坑得很惨，因为经验不足呀。<br>生活中也不乏有“标新立异”的。之前有朋友说自己多么不屑于玩朋友圈，但当许许多多地朋友在这个圈子里活动时，你不参与进来，那你将错失许多资源。如果你喜欢不守交通规则，逆行、闯红灯、醉驾，那离危险也不远了，出事是迟早的了。<br>同样在对待互联网的态度上也应该是顺应她的发展趋势，保持开放的姿态迎接她，在思想上求同存异，而不是搞自己的一套，将所有的信息拒在门外，这样只会坑了圈内的人啊啊！（相信大家都知道我说的是哪一出）</p>
<h3 id="结束语"><a href="#结束语" class="headerlink" title="结束语"></a>结束语</h3><p>生活中虽然充满了条条框框，但大部分可能都是像铁轨一些保证生活的列车能顺利行走。所以，如果遇到了令自己不爽的规则时，请冷静客观地对待。</p>
</div><hr></div><div class="recent-post-item article-container"><a class="article-title" href="/a/19.html">express-session主动对存入的Buffer数据序列化</a><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2016-01-21</time><span class="article-meta"><span class="article-meta__separator">|</span><i class="fa fa-inbox article-meta__icon" aria-hidden="true"></i><a class="article-meta__categories" href="/categories/tech/">tech</a></span><span class="article-meta tags"><span class="article-meta__separator">|</span><i class="fa fa-tag article-meta__icon" aria-hidden="true"></i><a class="article-meta__tags" href="/tags/node-js/">node.js</a><span class="article-meta__link">-</span><i class="fa fa-tag article-meta__icon" aria-hidden="true"></i><a class="article-meta__tags" href="/tags/js/">js</a></span><div class="content"><p>express-session作为node.js一个重要的npm模块，极大地方便开发者管理项目的session。<br>实际中，我们往往会把一些数据存放进session，例如存放登录用户的信息，以此为识别用户的状态；或者共享一些操作数据等等。</p>
<h3 id="问题的出现"><a href="#问题的出现" class="headerlink" title="问题的出现"></a>问题的出现</h3><p>一次实践中，我把图片数据（Buffer类型）存储在session，为了可以共享到另一个接口上。然后在另一个接口调用出session里的数据时，却奇怪地发现数据变了样，格式是这样的：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;<span class="attr">type</span>: <span class="string">&#x27;buffer&#x27;</span>, <span class="attr">data</span>: []&#125;</span><br></pre></td></tr></table></figure>

<h3 id="解决问题"><a href="#解决问题" class="headerlink" title="解决问题"></a>解决问题</h3><p>经过一备google后才发现，express-session会将存入的Buffer序列化，然而当我们使用JSON.parse来解析时，却也无法解析出正确的结果，说明express-session主动对Buffer干的不是简单的JSON.stringify，所以我们便在Buffer数据存入session前先JSON.stringify，使用时再JSON.parse，这样便成功地解决了这个问题。<br>具体的代码方式如下：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 将Buffer数据存储在session</span></span><br><span class="line">app.<span class="title function_">get</span>(<span class="string">&#x27;/saveBufferData&#x27;</span>, <span class="keyword">function</span> (<span class="params">kk, req, res</span>) &#123;</span><br><span class="line">	...</span><br><span class="line">	req.<span class="property">session</span>[kk] = <span class="title class_">JSON</span>.<span class="title function_">stringify</span>(bufferData);</span><br><span class="line">	...</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 将Buffer数据取出</span></span><br><span class="line">app.<span class="title function_">get</span>(<span class="string">&#x27;/getBufferData&#x27;</span>, <span class="keyword">function</span> (<span class="params">kk, req, res</span>) &#123;</span><br><span class="line">	...</span><br><span class="line">	<span class="keyword">var</span> bufferData = <span class="title class_">JSON</span>.<span class="title function_">parse</span>(req.<span class="property">session</span>[kk], <span class="keyword">function</span>(<span class="params">key, value</span>) &#123;</span><br><span class="line">	<span class="keyword">return</span> value &amp;&amp; value.<span class="property">type</span> === <span class="string">&#x27;Buffer&#x27;</span></span><br><span class="line">		? <span class="keyword">new</span> <span class="title class_">Buffer</span>(value.<span class="property">data</span>)</span><br><span class="line">		: value;</span><br><span class="line">	&#125;);</span><br><span class="line">	...</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<h3 id="问题思考"><a href="#问题思考" class="headerlink" title="问题思考"></a>问题思考</h3><p>到底express-session对存入的Buffer做了什么呢？也只有阅读它的源码才能找到答案了！有兴趣的小伙伴不妨试试。</p>
</div><hr></div><div class="recent-post-item article-container"><a class="article-title" href="/a/18.html">《浪潮之巅》读后感</a><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2016-01-18</time><span class="article-meta"><span class="article-meta__separator">|</span><i class="fa fa-inbox article-meta__icon" aria-hidden="true"></i><a class="article-meta__categories" href="/categories/life/">life</a></span><span class="article-meta tags"><span class="article-meta__separator">|</span><i class="fa fa-tag article-meta__icon" aria-hidden="true"></i><a class="article-meta__tags" href="/tags/read/">read</a></span><div class="content"><p>陆续花了两个多月，品读完吴军博士的《浪潮之巅》（上下册），颇有感悟。途中零散地做了一些笔记，特来此总结一番。</p>
<p>以下是一些零散的笔记（只是本人的感悟，并不是《浪潮之巅》的观点）：</p>
<h3 id="论商业竞争"><a href="#论商业竞争" class="headerlink" title="论商业竞争"></a>论商业竞争</h3><p>商业的竞争发展促进技术的创新，对比中国技术创新有限，很大程度上由于没有激烈的竞争，很大行业存在垄断。</p>
<h3 id="三个商业规律"><a href="#三个商业规律" class="headerlink" title="三个商业规律"></a>三个商业规律</h3><p>三个商业规律推动IT技术的极速进步。其中较为印象深刻的规律是：软件的更新升级，导致现有硬件性能不足，用户需要更换硬件设备，进而推动硬件厂商的发展。</p>
<h3 id="甲骨文公司"><a href="#甲骨文公司" class="headerlink" title="甲骨文公司"></a>甲骨文公司</h3><p>甲骨文公司的发展历程告诉我们，成功的关键不在于做对了多少件事而在于少犯多少错误。</p>
<h3 id="互联网史"><a href="#互联网史" class="headerlink" title="互联网史"></a>互联网史</h3><p>了解互联网行业的历史，特别是一些大公司的发展历程，能让你意识到科技发展的动力与来源。以史为鉴可知，更能让你有可能把握住科技发展潮流，站在下一个浪潮之巅。</p>
<h3 id="制定规则比技术更重要"><a href="#制定规则比技术更重要" class="headerlink" title="制定规则比技术更重要"></a>制定规则比技术更重要</h3><p>规则比技术更有利于一家公司占领市场，因为一旦行业规则形成，就会有很多依靠此规则的从业者，当这些从业者在行业上占据一定规模，即使有其它公司或行业试图改变规则，就会遇到这些从业人员的“阻力”。所以制定规则的公司才变得不可撼动。</p>
<h3 id="信息行业的垄断"><a href="#信息行业的垄断" class="headerlink" title="信息行业的垄断"></a>信息行业的垄断</h3><p>信息行业比传统行业更容易出现垄断，因为前者除了研发外，其它成本低，容易扩大规模。比如用了windows就必需使用其上的软件，而开发一个操作系统，除了研发费用，生产的成本很低。</p>
<h3 id="风险投资与投资银行"><a href="#风险投资与投资银行" class="headerlink" title="风险投资与投资银行"></a>风险投资与投资银行</h3><p>风投对于科技领域及经济的发展往往是促进的作用。然与风投相关的投资银行，如华尔街，则往往掌握着上市公司的命运，且往往担任刽子手的角色。它们对于科技领域甚至全球经济起到举足轻重的影响。看到这，我想到的是，有钱人挣钱越来越多越来越快，下层的人则越来越剥削和控制</p>
<h3 id="金融危机"><a href="#金融危机" class="headerlink" title="金融危机"></a>金融危机</h3><p>金融危机一直在人们心目是摧毁经济、阻碍人类社会发展的恶魔。但它实际上是在剔除一些机构臃肿、发展不良的企业，让新生的事物发展起来，为人类社会这棵大树修枝剪叶。</p>
<h3 id="互联网2-0"><a href="#互联网2-0" class="headerlink" title="互联网2.0"></a>互联网2.0</h3><p>互联网2.0的产品是一个让用户可以提供内容，且以这些内容为服务文体，并且用户可在此开发应用程序的平台。</p>
<h3 id="云计算"><a href="#云计算" class="headerlink" title="云计算"></a>云计算</h3><p>让人们可以随时随地的访问和处理数据，并且可以向他人共享这些数据，云端的硬件、计算资源也可以共享给需要的用户。</p>
<h3 id="不同的企业"><a href="#不同的企业" class="headerlink" title="不同的企业"></a>不同的企业</h3><p>一流的企业制定规则，二流企业推品牌，三流企业卖产品，下流企业做苦力。</p>
<h3 id="论教育之重要性"><a href="#论教育之重要性" class="headerlink" title="论教育之重要性"></a>论教育之重要性</h3><p>世界上为什么只有一个硅谷，因为世界上就只有那么一个斯坦福大学。</p>
<h3 id="企业基因"><a href="#企业基因" class="headerlink" title="企业基因"></a>企业基因</h3><p>书中一直强调企业基因决定论，但我一直无法快乐地接受这样的定论，虽然可以从企业的过去及现在的状态去推测它之后的发展，但不能下定论，企业基因是不能成为决定性的东西的。企业发展只有与时俱进。</p>
<p>感谢吴军博士带来了如武侠小说般精彩的《浪潮之巅》，把商业的竞争讲得如此通俗易懂。</p>
</div><hr></div><div class="recent-post-item article-container"><a class="article-title" href="/a/17.html">过滤XML退格控制字符（\b或BS）</a><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2016-01-12</time><span class="article-meta"><span class="article-meta__separator">|</span><i class="fa fa-inbox article-meta__icon" aria-hidden="true"></i><a class="article-meta__categories" href="/categories/tech/">tech</a></span><span class="article-meta tags"><span class="article-meta__separator">|</span><i class="fa fa-tag article-meta__icon" aria-hidden="true"></i><a class="article-meta__tags" href="/tags/js/">js</a></span><div class="content"><h3 id="问题描述"><a href="#问题描述" class="headerlink" title="问题描述"></a>问题描述</h3><p>今天搞网站的rss源时遇到一个问题，xml解析报错，信息如下：<br><img src="https://yrw-blog.oss-cn-shenzhen.aliyuncs.com/article-img/20160112/a48ba99b-100f-4b80-9c71-6743b7d96445--17-1.png" alt="xml-error" title="xml-error"><br>“Input is not proper UTF-8, indicate encoding!”是在说xml中有字符无法用utf8规则解析。</p>
<p>查看页面源代码，全选复制粘贴到sublime后发现了如下”BS”的特殊字符，如图：<br><img src="https://yrw-blog.oss-cn-shenzhen.aliyuncs.com/article-img/20160112/9fa8937f-7a26-4969-b849-baf96f7006f0--]$T%60WA9FHTGYWIN46T16G%7DG.png" alt="BS" title="BS"></p>
<p>粘贴到chrome控制台来处理一下，得到如下结果：<br><img src="https://yrw-blog.oss-cn-shenzhen.aliyuncs.com/article-img/20160113/f6b163b1-7433-4fb0-bd33-977c0d6c9e77--17-3.png" alt="console" title="console"></p>
<p>这就说明这个特殊字符是不可显示的，但可以知道它的16进制是：08。</p>
<p>ASCII码控制字符对照表，如图：<br><img src="https://yrw-blog.oss-cn-shenzhen.aliyuncs.com/article-img/20160113/45da9d8d-6ca9-45cf-89ec-8a38342a66d5--17-4.png" alt="ASCII" title="ASCII"></p>
<p>在阮一峰的这篇<a target="_blank" rel="noopener" href="http://www.ruanyifeng.com/blog/2007/10/ascii_unicode_and_utf-8.html">文章</a>中了解到utf8、ASCII、unicode的一些区别。</p>
<p>原先还怀疑是unicode中没有对ASCII的控制字符作声明，所以才使得utf8无法对此作解析。但无论是在维基百科上的<a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/Unicode%E5%AD%97%E7%AC%A6%E5%88%97%E8%A1%A8">unicode字符列表</a>和<a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/UTF-8">utf8</a>上都看到有对十六进制范围为0000到007f的编码声明，还是js可以对这一控制字符进行十六进制的转换，这些都表明utf8是可以对所以ASCII作解析的（实际上它只用一个字节就对所有128个ASCII字符作编码）。</p>
<p>所以我换了个思路来思考这个问题，会不会是xml不让输入这些控制字符呢？<br>google了下，果然发现了<a target="_blank" rel="noopener" href="http://www.cnblogs.com/niniwzw/archive/2009/09/24/1573514.html">这篇文章</a>，而且恰好能说明这个问题。<br>实际是，所有ascii控制字符在xml都不给解析，然而之前那个报错信息把我的思路引到了另一个问题上去了。</p>
<h3 id="解决问题"><a href="#解决问题" class="headerlink" title="解决问题"></a>解决问题</h3><p>因为这个特殊字符在正常情况下无法显示，所以无法用常规的方法替换掉。但我们可以利用它的十六进制来做文章。先将可能含有特定字符的文本用encodeURIComponent转换成十六进制表示，然后repalce掉%08字符，再decodeURIComponent。具体代码是：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">filterBS</span>(<span class="params">str</span>) &#123;</span><br><span class="line">	<span class="keyword">if</span> (!str) &#123;</span><br><span class="line">		<span class="keyword">return</span> str;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> <span class="built_in">decodeURIComponent</span>(<span class="built_in">encodeURIComponent</span>(str).<span class="title function_">replace</span>(<span class="regexp">/%08/g</span>, <span class="string">&#x27;&#x27;</span>));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里只是替换掉了退格这个控制字符，具体可以控制上述acsii表中的十六进制数进行替换。</p>
<h3 id="思考回顾"><a href="#思考回顾" class="headerlink" title="思考回顾"></a>思考回顾</h3><p>做完之后一直在想，如果某个字符的十六进制是%08xx或%08xxxx或%08xxxxxx，那上述解决方法将会使这个字符错误地显示甚至是乱码。但在实际反复试验中，并没有出现这种情况。是试验的字符量太少了么？<br>实际上，在上述问题描述中，我们已经发现了utf8对ASCII的编码只需要一个字节，即0x00到0x7F，而且utf8中如果第一个字节以二进制0开始的话，则说明这个字符只需要一个字节，所以不会出现上述的可能情况。</p>
<p>至于为啥内容里会有这种控制字符，这就不得而知了。可能是公司编辑们复制粘贴其它平台或者其它编辑器的内容导致的。</p>
</div><hr></div><nav id="pagination"><div class="pagination"><a class="extend prev" rel="prev" href="/page/11/"><i class="fa fa-chevron-left"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/11/">11</a><span class="page-number current">12</span><a class="page-number" href="/page/13/">13</a><a class="page-number" href="/page/14/">14</a><a class="extend next" rel="next" href="/page/13/"><i class="fa fa-chevron-right"></i></a></div></nav></div></div><footer><div class="layout" id="footer"><div class="copyright">&copy;2015 - 2023 By 杨润炜</div><div class="framework-info"><span>Driven - </span><a target="_blank" rel="noopener" href="http://hexo.io"><span>Hexo</span></a><span class="footer-separator">|</span><span>Theme - </span><a target="_blank" rel="noopener" href="https://github.com/Molunerfinn/hexo-theme-melody"><span>Melody</span></a></div><div class="busuanzi"><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><span id="busuanzi_container_site_uv"><i class="fa fa-user"></i><span id="busuanzi_value_site_uv"></span><span></span></span><span class="footer-separator">|</span><span id="busuanzi_container_site_pv"><i class="fa fa-eye"></i><span id="busuanzi_value_site_pv"></span><span></span></span></div></div></footer><i class="fa fa-arrow-up" id="go-up" aria-hidden="true"></i><script src="https://cdn.jsdelivr.net/npm/animejs@latest/anime.min.js"></script><script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-animate@latest/velocity.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-ui-pack@latest/velocity.ui.min.js"></script><script src="/js/utils.js?version=1.9.1"></script><script src="/js/fancybox.js?version=1.9.1"></script><script src="/js/sidebar.js?version=1.9.1"></script><script src="/js/copy.js?version=1.9.1"></script><script src="/js/fireworks.js?version=1.9.1"></script><script src="/js/transition.js?version=1.9.1"></script><script src="/js/scroll.js?version=1.9.1"></script><script src="/js/head.js?version=1.9.1"></script><script>if(/Android|webOS|iPhone|iPod|iPad|BlackBerry/i.test(navigator.userAgent)) {
  $('#nav').addClass('is-mobile')
  $('footer').addClass('is-mobile')
  $('#top-container').addClass('is-mobile')
}</script></body></html>