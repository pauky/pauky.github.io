<!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta name="description" content=""><meta name="keywords" content=""><meta name="author" content="杨润炜"><meta name="copyright" content="杨润炜"><title>Cwalker</title><link rel="shortcut icon" href="/melody-favicon.ico"><link rel="stylesheet" href="/css/index.css?version=1.9.0"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@latest/css/font-awesome.min.css?version=1.9.0"><meta name="format-detection" content="telephone=no"><meta http-equiv="x-dns-prefetch-control" content="on"><link rel="dns-prefetch" href="https://cdn.jsdelivr.net"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  copy: {
    success: 'Copy successfully',
    error: 'Copy error',
    noSupport: 'The browser does not support'
  },
  hexoVersion: '6.2.0'
} </script><meta name="generator" content="Hexo 6.2.0"></head><body><i class="fa fa-arrow-right" id="toggle-sidebar" aria-hidden="true"></i><div id="sidebar" data-display="false"><div class="author-info"><div class="author-info__avatar text-center"><img src="/img/avatar.png"></div><div class="author-info__name text-center">杨润炜</div><div class="author-info__description text-center"></div><hr><div class="author-info-articles"><a class="author-info-articles__archives article-meta" href="/archives"><span class="pull-left">Articles</span><span class="pull-right">133</span></a><a class="author-info-articles__tags article-meta" href="/tags"><span class="pull-left">Tags</span><span class="pull-right">29</span></a><a class="author-info-articles__categories article-meta" href="/categories"><span class="pull-left">Categories</span><span class="pull-right">2</span></a></div></div></div><nav class="no-bg" id="nav"><div id="page-header"><span class="pull-left"> <a id="site-name" href="/">Cwalker</a></span><i class="fa fa-bars toggle-menu pull-right" aria-hidden="true"></i><span class="pull-right"></span></div><div id="site-info"><div id="site-title">Cwalker</div><div id="site-sub-title"></div></div></nav><div id="content-outer"><div class="layout" id="content-inner"><div class="recent-post-item article-container"><a class="article-title" href="/a/35.html">nginx + Let's Encrypt + acme-tiny = https证书</a><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2016-02-26</time><span class="article-meta"><span class="article-meta__separator">|</span><i class="fa fa-inbox article-meta__icon" aria-hidden="true"></i><a class="article-meta__categories" href="/categories/tech/">tech</a></span><span class="article-meta tags"><span class="article-meta__separator">|</span><i class="fa fa-tag article-meta__icon" aria-hidden="true"></i><a class="article-meta__tags" href="/tags/qianlizhixing/">qianlizhixing</a><span class="article-meta__link">-</span><i class="fa fa-tag article-meta__icon" aria-hidden="true"></i><a class="article-meta__tags" href="/tags/nginx/">nginx</a></span><div class="content"><p><a target="_blank" rel="noopener" href="https://letsencrypt.org/">Let’s Encrypt</a> 项目旨在让每个网站都能使用 HTTPS 加密，该项目获得了 Mozilla、思科、Akamai、IdenTrust 和 EFF 等组织的支持， 由 Linux 基金会托管。<br><a target="_blank" rel="noopener" href="https://github.com/diafygi/acme-tiny">acme-tiny</a>可以方便我们创建及定期更新证书的小工具。</p>
<h2 id="准备工作"><a href="#准备工作" class="headerlink" title="准备工作"></a>准备工作</h2><h3 id="nginx支持ssl"><a href="#nginx支持ssl" class="headerlink" title="nginx支持ssl"></a>nginx支持ssl</h3><p>nginx必须有http_ssl_module，可通过nginx -V来查看。如果当初编译nginx时没有加入这个模块，则需要重新编译。可参考<a target="_blank" rel="noopener" href="https://www.yangrunwei.com/a/34.html">重新编译nginx</a>。</p>
<h2 id="生成网站证书"><a href="#生成网站证书" class="headerlink" title="生成网站证书"></a>生成网站证书</h2><p>下面内容主要参考<a target="_blank" rel="noopener" href="https://imququ.com/post/letsencrypt-certificate.html">Jerry Qu的小站文章</a>。本站的https也是主要参考它来做的。</p>
<h5 id="创建帐号"><a href="#创建帐号" class="headerlink" title="创建帐号"></a>创建帐号</h5><p>首先创建一个目录，例如 ssl，用来存放各种临时文件和最后的证书文件。进入这个目录，创建一个 RSA 私钥用于 Let’s Encrypt 识别你的身份：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">openssl genrsa 4096 &gt; account.key</span><br></pre></td></tr></table></figure>
<h5 id="配置验证服务"><a href="#配置验证服务" class="headerlink" title="配置验证服务"></a>配置验证服务</h5><p>我们知道，CA 在签发 DV（Domain Validation）证书时，需要验证域名所有权。传统 CA 的验证方式一般是往 <a href="mailto:&#97;&#x64;&#109;&#105;&#110;&#64;&#x79;&#x6f;&#x75;&#114;&#115;&#x69;&#116;&#101;&#x2e;&#x63;&#x6f;&#x6d;">&#97;&#x64;&#109;&#105;&#110;&#64;&#x79;&#x6f;&#x75;&#114;&#115;&#x69;&#116;&#101;&#x2e;&#x63;&#x6f;&#x6d;</a> 发验证邮件，而 Let’s Encrypt 是在你的服务器上生成一个随机验证文件，再通过创建 CSR 时指定的域名访问，如果可以访问则表明你对这个域名有控制权。<br>首先创建用于存放验证文件的目录，例如：<br>mkdir ~&#x2F;www&#x2F;challenges&#x2F;<br>在nginx上为上面指定的域名配置 HTTP 服务，以static.yangrunwei.com为例：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">server &#123;</span><br><span class="line">	listen 80;</span><br><span class="line">    server_name static.yangrunwei.com;</span><br><span class="line"></span><br><span class="line">    location ^~ /.well-known/acme-challenge/ &#123;</span><br><span class="line">        alias /home/xxx/www/challenges/;</span><br><span class="line">        try_files $uri =404;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    location / &#123;</span><br><span class="line">        rewrite ^/(.*)$ https://static.yangrunwei.com/$1 permanent;</span><br><span class="line">    &#125;</span><br><span class="line">	</span><br><span class="line">	...the rest of your config</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>以上配置优先查找 ~&#x2F;www&#x2F;challenges&#x2F; 目录下的文件，如果找不到就重定向到 HTTPS 地址。这个验证服务以后更新证书还要用到，需要一直保留。<br>重启nginx使配置生效（如果不知道怎样重启，可参考<a target="_blank" rel="noopener" href="https://www.yangrunwei.com/a/33.html">本文</a>）。</p>
<h5 id="创建-CSR-文件"><a href="#创建-CSR-文件" class="headerlink" title="创建 CSR 文件"></a>创建 CSR 文件</h5><p>接着就可以生成 CSR（Certificate Signing Request，证书签名请求）文件了。<br>首先，在之前的目录下再创建一个域名私钥（一定不要使用上面的账户私钥）：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">openssl genrsa 4096 &gt; domain.key</span><br></pre></td></tr></table></figure>
<p>如果要签发 ECC 证书，请使用以下任一命令生成 domain.key（我做的时候是没有生成ECC证书的）：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">#secp256r1</span><br><span class="line">openssl ecparam -genkey -name secp256r1 | openssl ec -out domain.key</span><br><span class="line"></span><br><span class="line">#secp384r1</span><br><span class="line">openssl ecparam -genkey -name secp384r1 | openssl ec -out domain.key</span><br></pre></td></tr></table></figure>

<p>然后就可以生成 CSR 文件了。推荐至少把域名带 www 和不带 www 的两种情况都加进去，其它子域可以根据需要添加（目前一张证书最多可以包含 100 个域名）：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">openssl req -new -sha256 -key domain.key -subj &quot;/&quot; -reqexts SAN -config &lt;(cat /etc/ssl/openssl.cnf &lt;(printf &quot;[SAN]\nsubjectAltName=DNS:yangrunwei.com,DNS:www.yangrunwei.com,DNS:static.yangrunwei.com,DNS:img.yangrunwei.com&quot;)) &gt; domain.csr</span><br></pre></td></tr></table></figure>
<p>执行这一步时，如果提示找不到 &#x2F;etc&#x2F;ssl&#x2F;openssl.cnf 文件，应该是没有安装 openssl 库。</p>
<p>执行的效果图如下：<br><img src="https://img.yangrunwei.com/article-img/20160227/3200eac7-8873-4d22-9dc1-f6da6220acec--35-1.png" alt="配置验证服务效果图" title="效果图"></p>
<h5 id="获取网站证书"><a href="#获取网站证书" class="headerlink" title="获取网站证书"></a>获取网站证书</h5><p>下载 acme-tiny 脚本保存到之前的 ssl 目录：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wget https://raw.githubusercontent.com/diafygi/acme-tiny/master/acme_tiny.py</span><br></pre></td></tr></table></figure>
<p>指定账户私钥、CSR 以及验证目录，执行脚本：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python acme_tiny.py --account-key ./account.key --csr ./domain.csr --acme-dir ~/www/challenges/ &gt; ./signed.crt</span><br></pre></td></tr></table></figure>
<p>如果一切正常，当前目录下就会生成一个 signed.crt，这就是申请好的证书文件。<br>如果出现如下问题，则表示需要更换DNS，最好是国外的。</p>
<blockquote>
<p>ValueError: Wrote file to &#x2F;home&#x2F;xxx&#x2F;www&#x2F;challenges&#x2F;oJbvpIhkwkBGBAQUklWJXyC8VbWAdQqlgpwUJkgC1Vg, but couldn’t download <a target="_blank" rel="noopener" href="http://www.yoursite.com/.well-known/acme-challenge/oJbvpIhkwkBGBAQUklWJXyC8VbWAdQqlgpwUJkgC1Vg">http://www.yoursite.com/.well-known/acme-challenge/oJbvpIhkwkBGBAQUklWJXyC8VbWAdQqlgpwUJkgC1Vg</a></p>
</blockquote>
<p>本站用的是阿里云的服务器及其DNS解析，没有出现上述问题。</p>
<p>搞定网站证书后，还要下载 Let’s Encrypt 的中间证书。配置 HTTPS 证书时既不要漏掉中间证书，也不要包含根证书。在 Nginx 配置中，需要把中间证书和网站证书合在一起：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">wget -O - https://letsencrypt.org/certs/lets-encrypt-x1-cross-signed.pem &gt; intermediate.pem</span><br><span class="line">cat signed.crt intermediate.pem &gt; chained.pem</span><br></pre></td></tr></table></figure>
<p>最终，修改 Nginx 中有关证书的配置并重启服务即可。最终配置，以static.yangrunwei.com为例，如下</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">server &#123;</span><br><span class="line">    listen 443;</span><br><span class="line">    server_name static.yangrunwei.com;</span><br><span class="line">	</span><br><span class="line">    ssl on;</span><br><span class="line">    ssl_certificate /home/xxx/www/ssl/chained.pem;</span><br><span class="line">    ssl_certificate_key /home/xxx/www/ssl/domain.key;</span><br><span class="line">	</span><br><span class="line">	...the rest of your config</span><br><span class="line">&#125;</span><br><span class="line">server &#123;</span><br><span class="line">	listen 80;</span><br><span class="line">    server_name static.yangrunwei.com;</span><br><span class="line"></span><br><span class="line">    location ^~ /.well-known/acme-challenge/ &#123;</span><br><span class="line">        alias /home/xxx/www/challenges/;</span><br><span class="line">        try_files $uri =404;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    location / &#123;</span><br><span class="line">        rewrite ^/(.*)$ https://static.yangrunwei.com/$1 permanent;</span><br><span class="line">    &#125;</span><br><span class="line">	</span><br><span class="line">	...the rest of your config</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="配置阿里云OSS存储https"><a href="#配置阿里云OSS存储https" class="headerlink" title="配置阿里云OSS存储https"></a>配置阿里云OSS存储https</h2><p>因为本站图片资源放在阿里云的OSS存储上，所以img.yangrunwei.com CNAME到了阿里云的内容服务器上。由于阿里云OSS存储暂时不支持上传https证书，所以我只能通过nginx反向代理来做img.yangrunwei.com的https证书了。</p>
<h5 id="配置域名解析"><a href="#配置域名解析" class="headerlink" title="配置域名解析"></a>配置域名解析</h5><p>首先得配置img.yangrunwei.com A记录到自己的nginx服务器上。可以在DNS解析上修改，并且这个解析很快就可以生效（一般几分钟）。</p>
<h5 id="配置nginx反向代理"><a href="#配置nginx反向代理" class="headerlink" title="配置nginx反向代理"></a>配置nginx反向代理</h5><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">server &#123;</span><br><span class="line">    listen 443;</span><br><span class="line">    server_name img.yangrunwei.com;</span><br><span class="line"></span><br><span class="line">    ssl on;</span><br><span class="line">    ssl_certificate /home/xxx/www/ssl/chained.pem;</span><br><span class="line">    ssl_certificate_key /home/xxx/www/ssl/domain.key;</span><br><span class="line"></span><br><span class="line">    location ~ ^/ &#123;</span><br><span class="line">        proxy_set_header  Referer 防盗链域名;</span><br><span class="line">        proxy_pass OSS外网或内网域名;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">server &#123;</span><br><span class="line">    listen 80;</span><br><span class="line">    server_name img.yangrunwei.com;</span><br><span class="line"></span><br><span class="line">    location ^~ /.well-known/acme-challenge/ &#123;</span><br><span class="line">        alias /home/xxx/www/challenges/;</span><br><span class="line">        try_files $uri =404;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>注：如果你在OSS存储上设置了防盗链，必须在代理时加上referer，不然请求会403；代理的域名可选择OSS外网或内网域名，如果选择内网，则必须nginx服务器与OSS存储的服务在同一区域；这样做有一个很大的缺陷，就会nginx服务器压力会增大，因为原来的图片请求都要通过它来转发，而且无法做图片CDN（如果你有CDN，可以在CDN上传证书来解决）。</p>
<h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><p><a target="_blank" rel="noopener" href="https://imququ.com/post/letsencrypt-certificate.html">Let’s Encrypt，免费好用的 HTTPS 证书</a><br><a target="_blank" rel="noopener" href="https://github.com/diafygi/acme-tiny">acme-tiny</a><br><a target="_blank" rel="noopener" href="https://help.aliyun.com/knowledge_detail/6936834.html?pos=1">oss通过反向代理配置自己域名的https</a></p>
</div><hr></div><div class="recent-post-item article-container"><a class="article-title" href="/a/29.html">nginx block agent or ip</a><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2016-02-23</time><span class="article-meta"><span class="article-meta__separator">|</span><i class="fa fa-inbox article-meta__icon" aria-hidden="true"></i><a class="article-meta__categories" href="/categories/tech/">tech</a></span><span class="article-meta tags"><span class="article-meta__separator">|</span><i class="fa fa-tag article-meta__icon" aria-hidden="true"></i><a class="article-meta__tags" href="/tags/nginx/">nginx</a></span><div class="content"><p>我们网站上线后，往往会有不少爬虫及应用来抓取内容，有些是出于收录的好意，比如百度、谷歌，但也有的是恶意的爬虫，它们有时会影响网站性能，妨碍正常的用户访问。这时我们可以使用nginx的block配置来达到阻塞某些访问的目的。</p>
<h2 id="Block-Agent"><a href="#Block-Agent" class="headerlink" title="Block Agent"></a>Block Agent</h2><p>新建blockagent.conf，内容如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">#block http agent</span><br><span class="line"></span><br><span class="line">if ($http_user_agent ~* (HTMLParser|Scrapy))&#123;</span><br><span class="line">   return 403;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在你的nginx路由配置里引入些blockagent.conf</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">include blockagent.conf;</span><br></pre></td></tr></table></figure>

<p>重启nginx，生效配置</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo nginx -s reload</span><br></pre></td></tr></table></figure>

<p>之后如果nginx发现访问的agent是TMLParser或Scrapy的话，就会返回403状态，使我们后面的应用不响应此请求，从而不影响正常的用户访问。</p>
<h2 id="Block-Ip"><a href="#Block-Ip" class="headerlink" title="Block Ip"></a>Block Ip</h2><p>新建blockip.conf，内容如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">#block ips</span><br><span class="line"></span><br><span class="line">deny 183.3.152.18;</span><br><span class="line">deny 111.5.74.12;</span><br></pre></td></tr></table></figure>

<p>在你的nginx路由配置里引入些blockip.conf</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">include blockip.conf;</span><br></pre></td></tr></table></figure>

<p>重启nginx，生效配置</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo nginx -s reload</span><br></pre></td></tr></table></figure>

<p>之后如果nginx发现访问的ip是183.3.152.18或111.5.74.12的话，就会返回403状态，使我们后面的应用不响应此请求，从而不影响正常的用户访问。</p>
</div><hr></div><div class="recent-post-item article-container"><a class="article-title" href="/a/31.html">nginx实现页面缓存</a><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2016-02-23</time><span class="article-meta"><span class="article-meta__separator">|</span><i class="fa fa-inbox article-meta__icon" aria-hidden="true"></i><a class="article-meta__categories" href="/categories/tech/">tech</a></span><span class="article-meta tags"><span class="article-meta__separator">|</span><i class="fa fa-tag article-meta__icon" aria-hidden="true"></i><a class="article-meta__tags" href="/tags/nginx/">nginx</a></span><div class="content"><p>网站的首页往往是该网站访问量最大的页面，如果首页的业务比较复杂，后台对些页面需要使用较多的系统资源，包括CPU和内存，这就要求我们能够采用一些手段来减轻服务器的资源压力了。</p>
<h2 id="nginx实现页面缓存"><a href="#nginx实现页面缓存" class="headerlink" title="nginx实现页面缓存"></a>nginx实现页面缓存</h2><p>nginx下的conf目录里修改nginx.conf文件如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">http &#123;</span><br><span class="line">...</span><br><span class="line">proxy_cache_path  /tmp/cache  keys_zone=tmpcache:200m;</span><br><span class="line">...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在应用的路由配置文件里修改如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">server &#123;</span><br><span class="line">	...</span><br><span class="line">	location = / &#123;</span><br><span class="line">        limit_req zone=allips burst=4;</span><br><span class="line">        proxy_set_header  Host $host;</span><br><span class="line">        proxy_set_header X-Real-IP $remote_addr;</span><br><span class="line">        proxy_headers_hash_max_size 1024;</span><br><span class="line">        proxy_headers_hash_bucket_size 128;</span><br><span class="line">        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;</span><br><span class="line">        proxy_set_header Accept-Encoding &quot;&quot;;</span><br><span class="line">        proxy_cache tmpcache;</span><br><span class="line">        proxy_cache_key $host$uri$is_args$args;</span><br><span class="line">        proxy_cache_valid 200 304 1m;  #首页返回200或304时，缓存1分钟</span><br><span class="line">        add_header cached $upstream_cache_status;</span><br><span class="line">        proxy_pass http://127.0.0.1:3100;</span><br><span class="line">		proxy_http_version 1.1;</span><br><span class="line">        proxy_set_header Connection &quot;&quot;;</span><br><span class="line">    &#125;</span><br><span class="line">	...</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>打开<a target="_blank" rel="noopener" href="http://www.yangrunwei.com/">行之足首页</a>，在控制台查看结果，如图：<br><img src="https://img.yangrunwei.com/article-img/20160223/f4c7fe6b-9665-451f-8e97-59b73f6495e9--31-1.png" alt="缓存结果" title="缓存结果"></p>
<p>HIT 表示命中缓存<br>EXPIRED 表示缓存过期<br>MISS 表示没有找到缓存</p>
</div><hr></div><div class="recent-post-item article-container"><a class="article-title" href="/a/30.html">nginx 预防单点故障</a><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2016-02-23</time><span class="article-meta"><span class="article-meta__separator">|</span><i class="fa fa-inbox article-meta__icon" aria-hidden="true"></i><a class="article-meta__categories" href="/categories/tech/">tech</a></span><span class="article-meta tags"><span class="article-meta__separator">|</span><i class="fa fa-tag article-meta__icon" aria-hidden="true"></i><a class="article-meta__tags" href="/tags/nginx/">nginx</a></span><div class="content"><p>通常情况我们需要密切关注网站服务的可持续访问，并且会采取一些宕机提醒及预防措施。下面我们通过配置nginx来实现预防网站服务单点故障的方法。</p>
<h2 id="预防单点故障"><a href="#预防单点故障" class="headerlink" title="预防单点故障"></a>预防单点故障</h2><p>我们的web服务通常运行在一台主服务器，由它来为用户的日常访问提供服务。如果这台web服务器宕机了，那么我们的所有业务服务将停止，这将对我们的利益带来很大的损失。如果在宕机时，有一个程序能把用户的访问转发到另外一台应急服务器上，那我们的服务将持续下去，而且在我们维护主服务器时能够不间断地提供服务。nginx就可以做到。下面我们来看看如何配置。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">upstream serverUpstream&#123;</span><br><span class="line">    server 10.252.131.148:3100;</span><br><span class="line">    server 10.173.163.241:3100 backup;</span><br><span class="line">    keepalive 8;</span><br><span class="line">&#125;</span><br><span class="line">server &#123;</span><br><span class="line">	...</span><br><span class="line">	location ~ ^/ &#123;</span><br><span class="line">        limit_req zone=allips burst=4;</span><br><span class="line">        proxy_set_header  Host $host;</span><br><span class="line">        proxy_set_header X-Real-IP $remote_addr;</span><br><span class="line">        proxy_headers_hash_max_size 1024;</span><br><span class="line">        proxy_headers_hash_bucket_size 128;</span><br><span class="line">        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;</span><br><span class="line">        proxy_set_header Accept-Encoding &quot;&quot;;</span><br><span class="line">        proxy_pass http://serverUpstream;</span><br><span class="line">        proxy_http_version 1.1;</span><br><span class="line">        proxy_set_header Connection &quot;&quot;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>serverUpstream中包含了两个ip地址，第一个是主服务器的地址，第二个是应急服务器的地址，并带上backup标记，表示主服务器无法工作时，就用backup服务器。</p>
<p>这样，nginx就帮我们做好单点故障的预防咯。还有需要注意的就是主服务器和应急服务器的代码同步，发布新版本时需要发布到这两个机器上去。再者，如果我们在服务器宕机时做个提醒，然后工程师们进行及时维修，nginx同时解决单点故障，这样项目就不会因为宕机而受到太大的影响。</p>
</div><hr></div><div class="recent-post-item article-container"><a class="article-title" href="/a/28.html">nginx location 优先级</a><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2016-02-18</time><span class="article-meta"><span class="article-meta__separator">|</span><i class="fa fa-inbox article-meta__icon" aria-hidden="true"></i><a class="article-meta__categories" href="/categories/tech/">tech</a></span><span class="article-meta tags"><span class="article-meta__separator">|</span><i class="fa fa-tag article-meta__icon" aria-hidden="true"></i><a class="article-meta__tags" href="/tags/nginx/">nginx</a></span><div class="content"><p>##location匹配命令概述</p>
<blockquote>
<p>A location can either be defined by a prefix string, or by a regular expression.</p>
</blockquote>
<p>location匹配命令包括前缀和正则表达式两种。具体有如下几种匹配命令：</p>
<h4 id=""><a href="#" class="headerlink" title="~"></a>~</h4><p>波浪线表示执行一个正则匹配，区分大小写</p>
<h4 id="-1"><a href="#-1" class="headerlink" title="~*"></a>~*</h4><p>表示执行一个正则匹配，不区分大小写</p>
<h4 id="-2"><a href="#-2" class="headerlink" title="^~"></a>^~</h4><p>匹配路径的前缀，如果找到，停止搜索。<br>表示普通字符匹配，如果该选项匹配，只匹配该选项，不匹配别的选项，一般用来匹配目录</p>
<h4 id="x3D"><a href="#x3D" class="headerlink" title="&#x3D;"></a>&#x3D;</h4><p>进行普通字符精确匹配</p>
<h4 id="-3"><a href="#-3" class="headerlink" title="@"></a>@</h4><p>“@” 定义一个命名的 location，使用在内部定向时，例如 error_page, try_files</p>
<p>##location优先级<br>&#x3D;(精确匹配) &gt; ^~(特殊路径前缀匹配) &gt; ~*(正则匹配) &#x3D; ~(正则匹配) &gt; 普通路径前缀匹配</p>
<p>####示例1<br>&#x3D;(精确匹配) &gt; ^~(特殊路径前缀匹配)</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">loaction ^~ /admin &#123;</span><br><span class="line">	[ configuration A ]</span><br><span class="line">&#125;</span><br><span class="line">loaction = /admin &#123;</span><br><span class="line">	[ configuration B ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>结果：&#x2F;admin匹配进 [ configuration B ]</p>
<p>####示例2<br>^~(路径的前缀匹配) &gt; ~*(正则匹配) &#x3D; ~(正则匹配)</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">loaction ~* ^/admin &#123;</span><br><span class="line">	[ configuration A ]</span><br><span class="line">&#125;</span><br><span class="line">loaction ~ ^/admin &#123;</span><br><span class="line">	[ configuration B ]</span><br><span class="line">&#125;</span><br><span class="line">loaction ^~ /admin &#123;</span><br><span class="line">	[ configuration C ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>结果：&#x2F;admin匹配进 [ configuration C ]</p>
<p>####示例3<br>按特殊路径前缀匹配匹配时，前缀越具体（越长）则优先匹配。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">loaction ^~ /admin &#123;</span><br><span class="line">	[ configuration A ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>结果：&#x2F;admin&#x2F;a匹配进 [ configuration A ]</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">loaction ^~ /admin &#123;</span><br><span class="line">	[ configuration A ]</span><br><span class="line">&#125;</span><br><span class="line">loaction ^~ /admin/a &#123;</span><br><span class="line">	[ configuration B ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>结果：&#x2F;admin&#x2F;a匹配进 [ configuration B ]</p>
<p>####示例4<br>正则匹配是按照配置时定义的顺序来匹配的，先匹配到的就停止。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">loaction ~* ^/admin &#123;</span><br><span class="line">	[ configuration A ]</span><br><span class="line">&#125;</span><br><span class="line">loaction ~ ^/admin &#123;</span><br><span class="line">	[ configuration B ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>结果：&#x2F;admin匹配进 [ configuration A ]</p>
<p>####示例5<br>按普通路径前缀匹配时，也是前缀越具体（越长）则优先匹配</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">loaction /admin &#123;</span><br><span class="line">	[ configuration A ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>结果：&#x2F;admin&#x2F;a匹配进 [ configuration A ]</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">loaction /admin &#123;</span><br><span class="line">	[ configuration A ]</span><br><span class="line">&#125;</span><br><span class="line">loaction /admin/a &#123;</span><br><span class="line">	[ configuration B ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>结果：&#x2F;admin&#x2F;a匹配进 [ configuration B ]</p>
<p>####官方文档示例</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">location = / &#123;</span><br><span class="line">    [ configuration A ]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">location / &#123;</span><br><span class="line">    [ configuration B ]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">location /documents/ &#123;</span><br><span class="line">    [ configuration C ]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">location ^~ /images/ &#123;</span><br><span class="line">    [ configuration D ]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">location ~* \.(gif|jpg|jpeg)$ &#123;</span><br><span class="line">    [ configuration E ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>结果1： &#x2F;匹配进[ configuration A ]<br>结果2： &#x2F;index.html匹配进[ configuration B ]<br>结果3： &#x2F;documents&#x2F;document.html匹配进[ configuration C ]<br>结果4： &#x2F;images&#x2F;1.gif匹配进[ configuration D ]<br>结果5： &#x2F;documents&#x2F;1.jpg匹配进[ configuration E ]</p>
<p>#####分析<br>结果1说明&#x3D;（精确匹配优先级最高）；<br>结果2及结果3说明前缀匹配时，前缀越具体（越长）则优先匹配；<br>结果4及结果5说明^~(路径的前缀匹配)优先级高于 ~*(正则匹配)。</p>
<h4 id="规则总结"><a href="#规则总结" class="headerlink" title="规则总结"></a>规则总结</h4><ol>
<li>&#x3D;(精确匹配) &gt; ^~(特殊路径前缀匹配) &gt; ~*(正则匹配) &#x3D; ~(正则匹配) &gt; 普通路径前缀匹配</li>
<li>正则匹配按配置顺序匹配</li>
<li>前缀匹配越具体（越长）则优先匹配</li>
</ol>
<p>##参考<br><a target="_blank" rel="noopener" href="http://nginx.org/en/docs/http/ngx_http_core_module.html#location">nginx-location文档</a></p>
</div><hr></div><div class="recent-post-item article-container"><a class="article-title" href="/a/26.html">mongodb控制台修改数据</a><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2016-02-15</time><span class="article-meta"><span class="article-meta__separator">|</span><i class="fa fa-inbox article-meta__icon" aria-hidden="true"></i><a class="article-meta__categories" href="/categories/tech/">tech</a></span><span class="article-meta tags"><span class="article-meta__separator">|</span><i class="fa fa-tag article-meta__icon" aria-hidden="true"></i><a class="article-meta__tags" href="/tags/mongodb/">mongodb</a></span><div class="content"><p>在某些特殊情况下，我们需要手动对mongodb的数据进行修改。这时我们可以写个程序跑一下，也可以在mongodb提供的命令行接口来实现这个需求。</p>
<p>##update方法</p>
<blockquote>
<p>db.table.update(query, obj, upsert, multi)</p>
</blockquote>
<p>####解释<br>table:要更新的数据表；<br>query：查询条件，类似于update语句内where后面的内容;<br>obj：update的对象和一些更新的操作符(如$、$inc等)，也可以理解为关系型数据库update语句内set后面的内容;<br>upsert：如果不存在update的纪录，是否插入obj这个新的document。true为插入，默认是false，不插入;<br>multi：默认是false,只更新找到的第一条纪录，如果为true,按条件查出来的多条纪录全部更新。</p>
<p>####示例</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.user.update(&#123;name:&quot;pauky&quot;&#125;,&#123;$set:&#123;age:15&#125;&#125;,false,false)</span><br></pre></td></tr></table></figure>
</div><hr></div><div class="recent-post-item article-container"><a class="article-title" href="/a/27.html">javascript逻辑运算符的运用</a><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2016-02-15</time><span class="article-meta"><span class="article-meta__separator">|</span><i class="fa fa-inbox article-meta__icon" aria-hidden="true"></i><a class="article-meta__categories" href="/categories/tech/">tech</a></span><span class="article-meta tags"><span class="article-meta__separator">|</span><i class="fa fa-tag article-meta__icon" aria-hidden="true"></i><a class="article-meta__tags" href="/tags/js/">js</a></span><div class="content"><p>Javascript的逻辑运算符包括&amp;&amp;(and)，||(or)，！(not)。</p>
<p>##与判断语句结合使用<br>一般我们用来跟if…else等判断语句结果使用。如</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">if (a &amp;&amp; b) &#123;</span><br><span class="line">	console.log(&#x27;123&#x27;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>##连接判断条件与结果<br>为了使代码更简洁，我们可以使用逻辑运算符，把判断条件放在其左方，结果放在右方。将上面代码简化为：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(a &amp;&amp; b) &amp;&amp; (console.log(&#x27;123&#x27;));</span><br></pre></td></tr></table></figure>
<p>或</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">a &amp;&amp; b &amp;&amp; (console.log(&#x27;123&#x27;));</span><br></pre></td></tr></table></figure>
<p>注意右方的结果语句需要加上括号，不然会报错。<br>这两个代码的执行结果都是一样的，说明逻辑运算符是从左向右逐个运算的。这点常常在实际中被开发者忽略，须谨记。</p>
<p>##运用在赋值运算中<br>有时候需要给一个变量在不同条件下赋予不同的值，这时也可以运用逻辑运算符来达到目的，且更简洁。<br>一般情况下的处理：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">var a = 1;</span><br><span class="line">if (new Date().getDay() === 1) &#123;</span><br><span class="line">	a = 100;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>运算逻辑运算符：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">var a = new Date().getDay() === 1 &amp;&amp; 100 || 1;</span><br></pre></td></tr></table></figure>
<p>可能有个别开发者会怀疑得到的a值可能是true或者false这些布尔值，但实际去是能够得到100或者1的。这是因为逻辑运算符产生的结果并不全是布尔值，而是最后能到达的那个值。<br>下面我们看看示例，就明白了。打开chrome控制台，输入以下运算，得到答案。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">// 2</span><br><span class="line">true &amp;&amp; 1 &amp;&amp; 2</span><br><span class="line"></span><br><span class="line">// 1</span><br><span class="line">1 || 3</span><br><span class="line"></span><br><span class="line">// 3</span><br><span class="line">false || 3</span><br><span class="line"></span><br><span class="line">// true</span><br><span class="line">true || 2</span><br><span class="line"></span><br><span class="line">// false</span><br><span class="line">false &amp;&amp; 6</span><br></pre></td></tr></table></figure>
</div><hr></div><div class="recent-post-item article-container"><a class="article-title" href="/a/25.html">如何创造奇迹？</a><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2016-02-01</time><span class="article-meta"><span class="article-meta__separator">|</span><i class="fa fa-inbox article-meta__icon" aria-hidden="true"></i><a class="article-meta__categories" href="/categories/life/">life</a></span><span class="article-meta tags"><span class="article-meta__separator">|</span><i class="fa fa-tag article-meta__icon" aria-hidden="true"></i><a class="article-meta__tags" href="/tags/read/">read</a></span><div class="content"><p>济南铁公，挂出大明太祖神牌，让朱棣攻城的大炮屁都不敢放一个，挽救了济南，更是当时的救世英雄。</p>
<h2 id="如何创造奇迹"><a href="#如何创造奇迹" class="headerlink" title="如何创造奇迹"></a>如何创造奇迹</h2><p>当时南军被朱棣军队打得四散溃败，济南城守军更是溃不成军，铁铉此时来守城，面对朱棣的兵强马壮，士气高昂之师，并没有所把握守住城池，打败北军，除非出现奇迹。然而铁铉的决心使得他义无反顾地来济南城，召集残兵败将来抵抗。一介书生，未有打仗经验的他，面对战争残酷的撕杀，是他的不惧身死的勇气支撑着他参与到这一场残酷的争斗中。更使他坚定报国决心的是他的朋友高巍和盛庸，遇到志同道合的人，会让自己更加认同自己走的路，然后与其携手一同走下去。就这样，朱棣军队居然让一个临时组建起来的守城军打跑了，让我不得不惊叹这一奇迹，它将一直被济南人民，被后世的人们传颂下去。<br>这也让我想起了为什么宠物小精灵里的小智总能战胜强大的对手，因为他有敢于向强大敌人挑战、勇往直前的勇气，有实现梦想的决心，有同甘共苦的伙伴，这样才让他每次都创造震撼人心的奇迹。<br>许许多多的故事里的奇迹产生都是按这样的规律来的，无论是虚构的还是现实存在过的奇迹。<br>记住，勇气、决心、朋友，在未来的路上收集它们，创造属于自己的奇迹吧，加油。</p>
</div><hr></div><div class="recent-post-item article-container"><a class="article-title" href="/a/24.html">mongodb结果集默认排序</a><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2016-01-30</time><span class="article-meta"><span class="article-meta__separator">|</span><i class="fa fa-inbox article-meta__icon" aria-hidden="true"></i><a class="article-meta__categories" href="/categories/tech/">tech</a></span><span class="article-meta tags"><span class="article-meta__separator">|</span><i class="fa fa-tag article-meta__icon" aria-hidden="true"></i><a class="article-meta__tags" href="/tags/mongodb/">mongodb</a></span><div class="content"><h2 id="问题描述"><a href="#问题描述" class="headerlink" title="问题描述"></a>问题描述</h2><p>使用mongodb时，我们常会传一个_id数组，然后查询表里_id字段等于该数组某个元素的记录，返回出结果集。如：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.inventory.find( &#123; _id: &#123; $in: [ 15, 5 ] &#125; &#125; )</span><br></pre></td></tr></table></figure>
<p>这个语句表示查询inventory文档里_id为15或5的记录。<br>这本来没有什么好说的。但问题出在了最后的结果集上。我们期望的结果集是：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&#123;_id: 15, data: ...&#125;</span><br><span class="line">&#123;_id: 5, data: ...&#125;</span><br></pre></td></tr></table></figure>
<p>然而现实却不尽人意，真正的结果是：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&#123;_id: 5, data: ...&#125;</span><br><span class="line">&#123;_id: 15, data: ...&#125;</span><br></pre></td></tr></table></figure>

<h2 id="问题分析与解决"><a href="#问题分析与解决" class="headerlink" title="问题分析与解决"></a>问题分析与解决</h2><p>在上述查询代码中，我们并没有指定sort条件，但mongodb返回的结果集却像是按_id排序过的。经过反复试验，在我们没指定sort条件时，mongodb确实会按照自然排序（_id的大小）对结果集进行排序。如果要达到自己预期的结果，我的做法是在返回结果集上，自己用程序再进行一次排序。跟踪<a target="_blank" rel="noopener" href="https://segmentfault.com/q/1010000000095495">segmentfault的这个问答</a>，可能之后会有更好的解决方案。</p>
</div><hr></div><div class="recent-post-item article-container"><a class="article-title" href="/a/23.html">慈爱的大脚马皇后</a><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2016-01-28</time><span class="article-meta"><span class="article-meta__separator">|</span><i class="fa fa-inbox article-meta__icon" aria-hidden="true"></i><a class="article-meta__categories" href="/categories/life/">life</a></span><span class="article-meta tags"><span class="article-meta__separator">|</span><i class="fa fa-tag article-meta__icon" aria-hidden="true"></i><a class="article-meta__tags" href="/tags/read/">read</a></span><div class="content"><p>快看完《明朝那些事儿》的第一部了，最让我感动的是人当属马皇后了。她是明朝开国皇帝朱元璋的第一任夫人，明朝第一贤后。</p>
<p>##患难现真情<br>马皇后跟朱元璋可谓是患难夫妻。朱元璋投军郭子兴时，她作为郭子兴的义女嫁于他，并在朱元璋被郭子兴关禁闭时，冒着危险给朱元璋送饭；即使当朱元璋几乎一无所有（从郭子兴营出走，只剩下部下24人），她还是不离不弃；打仗时，她还为军队做后勤保障，保管军队文书，与夫君共同抗敌。</p>
<p>##富而不奢，贵而不骄<br>即使成为了皇后，生活还是那么简朴；富贵时也清醒地认识到不能忘记民间疾苦，权力大了，还提出了“愿得贤人共理天下”的见解。相比朱元璋的这种权力欲望狂，已经强一个级别了，更另说蓝玉那种给三分颜色就做染坊的狂妄之徒了。</p>
<p>##始终用爱关怀他人<br>跟当时朱元璋的杀人如麻，简直是鲜明的对比。且不说她可能因为顾全大局而挽救了朱文正、李文忠、宋濂等人，就在她重病卧床急需医治时却不让太医为其医治，原因只是怕朱元璋认为太医无能医治不好马皇后而杀害无辜。这是一个始终用爱去关怀他人的高尚灵魂。</p>
<p>马皇后最后留给朱元璋的话是：“愿陛下求贤纳谏，有始有终，愿子孙个个贤能，百姓安居乐业，江山成年不朽”。有妻如此，夫得何求啊！可能直到她死时，朱元璋才知道这个人才是他的一切。</p>
<p>当年没房没车没前途的朱元璋能泡到马皇后这样的贤妻良母，并且患难不离弃、富贵不多求，说实话，心中只有满满的羡慕嫉妒恨。</p>
</div><hr></div><nav id="pagination"><div class="pagination"><a class="extend prev" rel="prev" href="/page/10/"><i class="fa fa-chevron-left"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/10/">10</a><span class="page-number current">11</span><a class="page-number" href="/page/12/">12</a><span class="space">&hellip;</span><a class="page-number" href="/page/14/">14</a><a class="extend next" rel="next" href="/page/12/"><i class="fa fa-chevron-right"></i></a></div></nav></div></div><footer><div class="layout" id="footer"><div class="copyright">&copy;2015 - 2022 By 杨润炜</div><div class="framework-info"><span>Driven - </span><a target="_blank" rel="noopener" href="http://hexo.io"><span>Hexo</span></a><span class="footer-separator">|</span><span>Theme - </span><a target="_blank" rel="noopener" href="https://github.com/Molunerfinn/hexo-theme-melody"><span>Melody</span></a></div><div class="busuanzi"><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><span id="busuanzi_container_site_uv"><i class="fa fa-user"></i><span id="busuanzi_value_site_uv"></span><span></span></span><span class="footer-separator">|</span><span id="busuanzi_container_site_pv"><i class="fa fa-eye"></i><span id="busuanzi_value_site_pv"></span><span></span></span></div></div></footer><i class="fa fa-arrow-up" id="go-up" aria-hidden="true"></i><script src="https://cdn.jsdelivr.net/npm/animejs@latest/anime.min.js"></script><script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-animate@latest/velocity.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-ui-pack@latest/velocity.ui.min.js"></script><script src="/js/utils.js?version=1.9.0"></script><script src="/js/fancybox.js?version=1.9.0"></script><script src="/js/sidebar.js?version=1.9.0"></script><script src="/js/copy.js?version=1.9.0"></script><script src="/js/fireworks.js?version=1.9.0"></script><script src="/js/transition.js?version=1.9.0"></script><script src="/js/scroll.js?version=1.9.0"></script><script src="/js/head.js?version=1.9.0"></script><script>if(/Android|webOS|iPhone|iPod|iPad|BlackBerry/i.test(navigator.userAgent)) {
  $('#nav').addClass('is-mobile')
  $('footer').addClass('is-mobile')
  $('#top-container').addClass('is-mobile')
}</script></body></html>