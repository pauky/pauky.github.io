<!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta name="description" content=""><meta name="keywords" content=""><meta name="author" content="杨润炜"><meta name="copyright" content="杨润炜"><title>Cwalker</title><link rel="shortcut icon" href="/melody-favicon.ico"><link rel="stylesheet" href="/css/index.css?version=1.9.0"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@latest/css/font-awesome.min.css?version=1.9.0"><meta name="format-detection" content="telephone=no"><meta http-equiv="x-dns-prefetch-control" content="on"><link rel="dns-prefetch" href="https://cdn.jsdelivr.net"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  copy: {
    success: 'Copy successfully',
    error: 'Copy error',
    noSupport: 'The browser does not support'
  },
  hexoVersion: '6.2.0'
} </script><meta name="generator" content="Hexo 6.2.0"></head><body><i class="fa fa-arrow-right" id="toggle-sidebar" aria-hidden="true"></i><div id="sidebar" data-display="false"><div class="author-info"><div class="author-info__avatar text-center"><img src="/img/avatar.png"></div><div class="author-info__name text-center">杨润炜</div><div class="author-info__description text-center"></div><hr><div class="author-info-articles"><a class="author-info-articles__archives article-meta" href="/archives"><span class="pull-left">Articles</span><span class="pull-right">131</span></a><a class="author-info-articles__tags article-meta" href="/tags"><span class="pull-left">Tags</span><span class="pull-right">29</span></a><a class="author-info-articles__categories article-meta" href="/categories"><span class="pull-left">Categories</span><span class="pull-right">2</span></a></div></div></div><nav class="no-bg" id="nav"><div id="page-header"><span class="pull-left"> <a id="site-name" href="/">Cwalker</a></span><i class="fa fa-bars toggle-menu pull-right" aria-hidden="true"></i><span class="pull-right"></span></div><div id="site-info"><div id="site-title">Cwalker</div><div id="site-sub-title"></div></div></nav><div id="content-outer"><div class="layout" id="content-inner"><div class="recent-post-item article-container"><a class="article-title" href="/a/31.html">nginx实现页面缓存</a><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2016-02-23</time><span class="article-meta"><span class="article-meta__separator">|</span><i class="fa fa-inbox article-meta__icon" aria-hidden="true"></i><a class="article-meta__categories" href="/categories/tech/">tech</a></span><span class="article-meta tags"><span class="article-meta__separator">|</span><i class="fa fa-tag article-meta__icon" aria-hidden="true"></i><a class="article-meta__tags" href="/tags/nginx/">nginx</a></span><div class="content"><p>网站的首页往往是该网站访问量最大的页面，如果首页的业务比较复杂，后台对些页面需要使用较多的系统资源，包括CPU和内存，这就要求我们能够采用一些手段来减轻服务器的资源压力了。</p>
<h2 id="nginx实现页面缓存"><a href="#nginx实现页面缓存" class="headerlink" title="nginx实现页面缓存"></a>nginx实现页面缓存</h2><p>nginx下的conf目录里修改nginx.conf文件如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">http &#123;</span><br><span class="line">...</span><br><span class="line">proxy_cache_path  /tmp/cache  keys_zone=tmpcache:200m;</span><br><span class="line">...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在应用的路由配置文件里修改如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">server &#123;</span><br><span class="line">	...</span><br><span class="line">	location = / &#123;</span><br><span class="line">        limit_req zone=allips burst=4;</span><br><span class="line">        proxy_set_header  Host $host;</span><br><span class="line">        proxy_set_header X-Real-IP $remote_addr;</span><br><span class="line">        proxy_headers_hash_max_size 1024;</span><br><span class="line">        proxy_headers_hash_bucket_size 128;</span><br><span class="line">        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;</span><br><span class="line">        proxy_set_header Accept-Encoding &quot;&quot;;</span><br><span class="line">        proxy_cache tmpcache;</span><br><span class="line">        proxy_cache_key $host$uri$is_args$args;</span><br><span class="line">        proxy_cache_valid 200 304 1m;  #首页返回200或304时，缓存1分钟</span><br><span class="line">        add_header cached $upstream_cache_status;</span><br><span class="line">        proxy_pass http://127.0.0.1:3100;</span><br><span class="line">		proxy_http_version 1.1;</span><br><span class="line">        proxy_set_header Connection &quot;&quot;;</span><br><span class="line">    &#125;</span><br><span class="line">	...</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>打开<a target="_blank" rel="noopener" href="http://www.yangrunwei.com/">行之足首页</a>，在控制台查看结果，如图：<br><img src="https://img.yangrunwei.com/article-img/20160223/f4c7fe6b-9665-451f-8e97-59b73f6495e9--31-1.png" alt="缓存结果" title="缓存结果"></p>
<p>HIT 表示命中缓存<br>EXPIRED 表示缓存过期<br>MISS 表示没有找到缓存</p>
</div><hr></div><div class="recent-post-item article-container"><a class="article-title" href="/a/30.html">nginx 预防单点故障</a><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2016-02-23</time><span class="article-meta"><span class="article-meta__separator">|</span><i class="fa fa-inbox article-meta__icon" aria-hidden="true"></i><a class="article-meta__categories" href="/categories/tech/">tech</a></span><span class="article-meta tags"><span class="article-meta__separator">|</span><i class="fa fa-tag article-meta__icon" aria-hidden="true"></i><a class="article-meta__tags" href="/tags/nginx/">nginx</a></span><div class="content"><p>通常情况我们需要密切关注网站服务的可持续访问，并且会采取一些宕机提醒及预防措施。下面我们通过配置nginx来实现预防网站服务单点故障的方法。</p>
<h2 id="预防单点故障"><a href="#预防单点故障" class="headerlink" title="预防单点故障"></a>预防单点故障</h2><p>我们的web服务通常运行在一台主服务器，由它来为用户的日常访问提供服务。如果这台web服务器宕机了，那么我们的所有业务服务将停止，这将对我们的利益带来很大的损失。如果在宕机时，有一个程序能把用户的访问转发到另外一台应急服务器上，那我们的服务将持续下去，而且在我们维护主服务器时能够不间断地提供服务。nginx就可以做到。下面我们来看看如何配置。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">upstream serverUpstream&#123;</span><br><span class="line">    server 10.252.131.148:3100;</span><br><span class="line">    server 10.173.163.241:3100 backup;</span><br><span class="line">    keepalive 8;</span><br><span class="line">&#125;</span><br><span class="line">server &#123;</span><br><span class="line">	...</span><br><span class="line">	location ~ ^/ &#123;</span><br><span class="line">        limit_req zone=allips burst=4;</span><br><span class="line">        proxy_set_header  Host $host;</span><br><span class="line">        proxy_set_header X-Real-IP $remote_addr;</span><br><span class="line">        proxy_headers_hash_max_size 1024;</span><br><span class="line">        proxy_headers_hash_bucket_size 128;</span><br><span class="line">        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;</span><br><span class="line">        proxy_set_header Accept-Encoding &quot;&quot;;</span><br><span class="line">        proxy_pass http://serverUpstream;</span><br><span class="line">        proxy_http_version 1.1;</span><br><span class="line">        proxy_set_header Connection &quot;&quot;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>serverUpstream中包含了两个ip地址，第一个是主服务器的地址，第二个是应急服务器的地址，并带上backup标记，表示主服务器无法工作时，就用backup服务器。</p>
<p>这样，nginx就帮我们做好单点故障的预防咯。还有需要注意的就是主服务器和应急服务器的代码同步，发布新版本时需要发布到这两个机器上去。再者，如果我们在服务器宕机时做个提醒，然后工程师们进行及时维修，nginx同时解决单点故障，这样项目就不会因为宕机而受到太大的影响。</p>
</div><hr></div><div class="recent-post-item article-container"><a class="article-title" href="/a/28.html">nginx location 优先级</a><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2016-02-18</time><span class="article-meta"><span class="article-meta__separator">|</span><i class="fa fa-inbox article-meta__icon" aria-hidden="true"></i><a class="article-meta__categories" href="/categories/tech/">tech</a></span><span class="article-meta tags"><span class="article-meta__separator">|</span><i class="fa fa-tag article-meta__icon" aria-hidden="true"></i><a class="article-meta__tags" href="/tags/nginx/">nginx</a></span><div class="content"><p>##location匹配命令概述</p>
<blockquote>
<p>A location can either be defined by a prefix string, or by a regular expression.</p>
</blockquote>
<p>location匹配命令包括前缀和正则表达式两种。具体有如下几种匹配命令：</p>
<h4 id=""><a href="#" class="headerlink" title="~"></a>~</h4><p>波浪线表示执行一个正则匹配，区分大小写</p>
<h4 id="-1"><a href="#-1" class="headerlink" title="~*"></a>~*</h4><p>表示执行一个正则匹配，不区分大小写</p>
<h4 id="-2"><a href="#-2" class="headerlink" title="^~"></a>^~</h4><p>匹配路径的前缀，如果找到，停止搜索。<br>表示普通字符匹配，如果该选项匹配，只匹配该选项，不匹配别的选项，一般用来匹配目录</p>
<h4 id="x3D"><a href="#x3D" class="headerlink" title="&#x3D;"></a>&#x3D;</h4><p>进行普通字符精确匹配</p>
<h4 id="-3"><a href="#-3" class="headerlink" title="@"></a>@</h4><p>“@” 定义一个命名的 location，使用在内部定向时，例如 error_page, try_files</p>
<p>##location优先级<br>&#x3D;(精确匹配) &gt; ^~(特殊路径前缀匹配) &gt; ~*(正则匹配) &#x3D; ~(正则匹配) &gt; 普通路径前缀匹配</p>
<p>####示例1<br>&#x3D;(精确匹配) &gt; ^~(特殊路径前缀匹配)</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">loaction ^~ /admin &#123;</span><br><span class="line">	[ configuration A ]</span><br><span class="line">&#125;</span><br><span class="line">loaction = /admin &#123;</span><br><span class="line">	[ configuration B ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>结果：&#x2F;admin匹配进 [ configuration B ]</p>
<p>####示例2<br>^~(路径的前缀匹配) &gt; ~*(正则匹配) &#x3D; ~(正则匹配)</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">loaction ~* ^/admin &#123;</span><br><span class="line">	[ configuration A ]</span><br><span class="line">&#125;</span><br><span class="line">loaction ~ ^/admin &#123;</span><br><span class="line">	[ configuration B ]</span><br><span class="line">&#125;</span><br><span class="line">loaction ^~ /admin &#123;</span><br><span class="line">	[ configuration C ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>结果：&#x2F;admin匹配进 [ configuration C ]</p>
<p>####示例3<br>按特殊路径前缀匹配匹配时，前缀越具体（越长）则优先匹配。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">loaction ^~ /admin &#123;</span><br><span class="line">	[ configuration A ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>结果：&#x2F;admin&#x2F;a匹配进 [ configuration A ]</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">loaction ^~ /admin &#123;</span><br><span class="line">	[ configuration A ]</span><br><span class="line">&#125;</span><br><span class="line">loaction ^~ /admin/a &#123;</span><br><span class="line">	[ configuration B ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>结果：&#x2F;admin&#x2F;a匹配进 [ configuration B ]</p>
<p>####示例4<br>正则匹配是按照配置时定义的顺序来匹配的，先匹配到的就停止。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">loaction ~* ^/admin &#123;</span><br><span class="line">	[ configuration A ]</span><br><span class="line">&#125;</span><br><span class="line">loaction ~ ^/admin &#123;</span><br><span class="line">	[ configuration B ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>结果：&#x2F;admin匹配进 [ configuration A ]</p>
<p>####示例5<br>按普通路径前缀匹配时，也是前缀越具体（越长）则优先匹配</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">loaction /admin &#123;</span><br><span class="line">	[ configuration A ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>结果：&#x2F;admin&#x2F;a匹配进 [ configuration A ]</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">loaction /admin &#123;</span><br><span class="line">	[ configuration A ]</span><br><span class="line">&#125;</span><br><span class="line">loaction /admin/a &#123;</span><br><span class="line">	[ configuration B ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>结果：&#x2F;admin&#x2F;a匹配进 [ configuration B ]</p>
<p>####官方文档示例</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">location = / &#123;</span><br><span class="line">    [ configuration A ]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">location / &#123;</span><br><span class="line">    [ configuration B ]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">location /documents/ &#123;</span><br><span class="line">    [ configuration C ]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">location ^~ /images/ &#123;</span><br><span class="line">    [ configuration D ]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">location ~* \.(gif|jpg|jpeg)$ &#123;</span><br><span class="line">    [ configuration E ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>结果1： &#x2F;匹配进[ configuration A ]<br>结果2： &#x2F;index.html匹配进[ configuration B ]<br>结果3： &#x2F;documents&#x2F;document.html匹配进[ configuration C ]<br>结果4： &#x2F;images&#x2F;1.gif匹配进[ configuration D ]<br>结果5： &#x2F;documents&#x2F;1.jpg匹配进[ configuration E ]</p>
<p>#####分析<br>结果1说明&#x3D;（精确匹配优先级最高）；<br>结果2及结果3说明前缀匹配时，前缀越具体（越长）则优先匹配；<br>结果4及结果5说明^~(路径的前缀匹配)优先级高于 ~*(正则匹配)。</p>
<h4 id="规则总结"><a href="#规则总结" class="headerlink" title="规则总结"></a>规则总结</h4><ol>
<li>&#x3D;(精确匹配) &gt; ^~(特殊路径前缀匹配) &gt; ~*(正则匹配) &#x3D; ~(正则匹配) &gt; 普通路径前缀匹配</li>
<li>正则匹配按配置顺序匹配</li>
<li>前缀匹配越具体（越长）则优先匹配</li>
</ol>
<p>##参考<br><a target="_blank" rel="noopener" href="http://nginx.org/en/docs/http/ngx_http_core_module.html#location">nginx-location文档</a></p>
</div><hr></div><div class="recent-post-item article-container"><a class="article-title" href="/a/26.html">mongodb控制台修改数据</a><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2016-02-15</time><span class="article-meta"><span class="article-meta__separator">|</span><i class="fa fa-inbox article-meta__icon" aria-hidden="true"></i><a class="article-meta__categories" href="/categories/tech/">tech</a></span><span class="article-meta tags"><span class="article-meta__separator">|</span><i class="fa fa-tag article-meta__icon" aria-hidden="true"></i><a class="article-meta__tags" href="/tags/mongodb/">mongodb</a></span><div class="content"><p>在某些特殊情况下，我们需要手动对mongodb的数据进行修改。这时我们可以写个程序跑一下，也可以在mongodb提供的命令行接口来实现这个需求。</p>
<p>##update方法</p>
<blockquote>
<p>db.table.update(query, obj, upsert, multi)</p>
</blockquote>
<p>####解释<br>table:要更新的数据表；<br>query：查询条件，类似于update语句内where后面的内容;<br>obj：update的对象和一些更新的操作符(如$、$inc等)，也可以理解为关系型数据库update语句内set后面的内容;<br>upsert：如果不存在update的纪录，是否插入obj这个新的document。true为插入，默认是false，不插入;<br>multi：默认是false,只更新找到的第一条纪录，如果为true,按条件查出来的多条纪录全部更新。</p>
<p>####示例</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.user.update(&#123;name:&quot;pauky&quot;&#125;,&#123;$set:&#123;age:15&#125;&#125;,false,false)</span><br></pre></td></tr></table></figure>
</div><hr></div><div class="recent-post-item article-container"><a class="article-title" href="/a/27.html">javascript逻辑运算符的运用</a><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2016-02-15</time><span class="article-meta"><span class="article-meta__separator">|</span><i class="fa fa-inbox article-meta__icon" aria-hidden="true"></i><a class="article-meta__categories" href="/categories/tech/">tech</a></span><span class="article-meta tags"><span class="article-meta__separator">|</span><i class="fa fa-tag article-meta__icon" aria-hidden="true"></i><a class="article-meta__tags" href="/tags/js/">js</a></span><div class="content"><p>Javascript的逻辑运算符包括&amp;&amp;(and)，||(or)，！(not)。</p>
<p>##与判断语句结合使用<br>一般我们用来跟if…else等判断语句结果使用。如</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">if (a &amp;&amp; b) &#123;</span><br><span class="line">	console.log(&#x27;123&#x27;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>##连接判断条件与结果<br>为了使代码更简洁，我们可以使用逻辑运算符，把判断条件放在其左方，结果放在右方。将上面代码简化为：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(a &amp;&amp; b) &amp;&amp; (console.log(&#x27;123&#x27;));</span><br></pre></td></tr></table></figure>
<p>或</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">a &amp;&amp; b &amp;&amp; (console.log(&#x27;123&#x27;));</span><br></pre></td></tr></table></figure>
<p>注意右方的结果语句需要加上括号，不然会报错。<br>这两个代码的执行结果都是一样的，说明逻辑运算符是从左向右逐个运算的。这点常常在实际中被开发者忽略，须谨记。</p>
<p>##运用在赋值运算中<br>有时候需要给一个变量在不同条件下赋予不同的值，这时也可以运用逻辑运算符来达到目的，且更简洁。<br>一般情况下的处理：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">var a = 1;</span><br><span class="line">if (new Date().getDay() === 1) &#123;</span><br><span class="line">	a = 100;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>运算逻辑运算符：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">var a = new Date().getDay() === 1 &amp;&amp; 100 || 1;</span><br></pre></td></tr></table></figure>
<p>可能有个别开发者会怀疑得到的a值可能是true或者false这些布尔值，但实际去是能够得到100或者1的。这是因为逻辑运算符产生的结果并不全是布尔值，而是最后能到达的那个值。<br>下面我们看看示例，就明白了。打开chrome控制台，输入以下运算，得到答案。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">// 2</span><br><span class="line">true &amp;&amp; 1 &amp;&amp; 2</span><br><span class="line"></span><br><span class="line">// 1</span><br><span class="line">1 || 3</span><br><span class="line"></span><br><span class="line">// 3</span><br><span class="line">false || 3</span><br><span class="line"></span><br><span class="line">// true</span><br><span class="line">true || 2</span><br><span class="line"></span><br><span class="line">// false</span><br><span class="line">false &amp;&amp; 6</span><br></pre></td></tr></table></figure>
</div><hr></div><div class="recent-post-item article-container"><a class="article-title" href="/a/25.html">如何创造奇迹？</a><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2016-02-01</time><span class="article-meta"><span class="article-meta__separator">|</span><i class="fa fa-inbox article-meta__icon" aria-hidden="true"></i><a class="article-meta__categories" href="/categories/life/">life</a></span><span class="article-meta tags"><span class="article-meta__separator">|</span><i class="fa fa-tag article-meta__icon" aria-hidden="true"></i><a class="article-meta__tags" href="/tags/read/">read</a></span><div class="content"><p>济南铁公，挂出大明太祖神牌，让朱棣攻城的大炮屁都不敢放一个，挽救了济南，更是当时的救世英雄。</p>
<h2 id="如何创造奇迹"><a href="#如何创造奇迹" class="headerlink" title="如何创造奇迹"></a>如何创造奇迹</h2><p>当时南军被朱棣军队打得四散溃败，济南城守军更是溃不成军，铁铉此时来守城，面对朱棣的兵强马壮，士气高昂之师，并没有所把握守住城池，打败北军，除非出现奇迹。然而铁铉的决心使得他义无反顾地来济南城，召集残兵败将来抵抗。一介书生，未有打仗经验的他，面对战争残酷的撕杀，是他的不惧身死的勇气支撑着他参与到这一场残酷的争斗中。更使他坚定报国决心的是他的朋友高巍和盛庸，遇到志同道合的人，会让自己更加认同自己走的路，然后与其携手一同走下去。就这样，朱棣军队居然让一个临时组建起来的守城军打跑了，让我不得不惊叹这一奇迹，它将一直被济南人民，被后世的人们传颂下去。<br>这也让我想起了为什么宠物小精灵里的小智总能战胜强大的对手，因为他有敢于向强大敌人挑战、勇往直前的勇气，有实现梦想的决心，有同甘共苦的伙伴，这样才让他每次都创造震撼人心的奇迹。<br>许许多多的故事里的奇迹产生都是按这样的规律来的，无论是虚构的还是现实存在过的奇迹。<br>记住，勇气、决心、朋友，在未来的路上收集它们，创造属于自己的奇迹吧，加油。</p>
</div><hr></div><div class="recent-post-item article-container"><a class="article-title" href="/a/24.html">mongodb结果集默认排序</a><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2016-01-30</time><span class="article-meta"><span class="article-meta__separator">|</span><i class="fa fa-inbox article-meta__icon" aria-hidden="true"></i><a class="article-meta__categories" href="/categories/tech/">tech</a></span><span class="article-meta tags"><span class="article-meta__separator">|</span><i class="fa fa-tag article-meta__icon" aria-hidden="true"></i><a class="article-meta__tags" href="/tags/mongodb/">mongodb</a></span><div class="content"><h2 id="问题描述"><a href="#问题描述" class="headerlink" title="问题描述"></a>问题描述</h2><p>使用mongodb时，我们常会传一个_id数组，然后查询表里_id字段等于该数组某个元素的记录，返回出结果集。如：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.inventory.find( &#123; _id: &#123; $in: [ 15, 5 ] &#125; &#125; )</span><br></pre></td></tr></table></figure>
<p>这个语句表示查询inventory文档里_id为15或5的记录。<br>这本来没有什么好说的。但问题出在了最后的结果集上。我们期望的结果集是：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&#123;_id: 15, data: ...&#125;</span><br><span class="line">&#123;_id: 5, data: ...&#125;</span><br></pre></td></tr></table></figure>
<p>然而现实却不尽人意，真正的结果是：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&#123;_id: 5, data: ...&#125;</span><br><span class="line">&#123;_id: 15, data: ...&#125;</span><br></pre></td></tr></table></figure>

<h2 id="问题分析与解决"><a href="#问题分析与解决" class="headerlink" title="问题分析与解决"></a>问题分析与解决</h2><p>在上述查询代码中，我们并没有指定sort条件，但mongodb返回的结果集却像是按_id排序过的。经过反复试验，在我们没指定sort条件时，mongodb确实会按照自然排序（_id的大小）对结果集进行排序。如果要达到自己预期的结果，我的做法是在返回结果集上，自己用程序再进行一次排序。跟踪<a target="_blank" rel="noopener" href="https://segmentfault.com/q/1010000000095495">segmentfault的这个问答</a>，可能之后会有更好的解决方案。</p>
</div><hr></div><div class="recent-post-item article-container"><a class="article-title" href="/a/23.html">慈爱的大脚马皇后</a><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2016-01-28</time><span class="article-meta"><span class="article-meta__separator">|</span><i class="fa fa-inbox article-meta__icon" aria-hidden="true"></i><a class="article-meta__categories" href="/categories/life/">life</a></span><span class="article-meta tags"><span class="article-meta__separator">|</span><i class="fa fa-tag article-meta__icon" aria-hidden="true"></i><a class="article-meta__tags" href="/tags/read/">read</a></span><div class="content"><p>快看完《明朝那些事儿》的第一部了，最让我感动的是人当属马皇后了。她是明朝开国皇帝朱元璋的第一任夫人，明朝第一贤后。</p>
<p>##患难现真情<br>马皇后跟朱元璋可谓是患难夫妻。朱元璋投军郭子兴时，她作为郭子兴的义女嫁于他，并在朱元璋被郭子兴关禁闭时，冒着危险给朱元璋送饭；即使当朱元璋几乎一无所有（从郭子兴营出走，只剩下部下24人），她还是不离不弃；打仗时，她还为军队做后勤保障，保管军队文书，与夫君共同抗敌。</p>
<p>##富而不奢，贵而不骄<br>即使成为了皇后，生活还是那么简朴；富贵时也清醒地认识到不能忘记民间疾苦，权力大了，还提出了“愿得贤人共理天下”的见解。相比朱元璋的这种权力欲望狂，已经强一个级别了，更另说蓝玉那种给三分颜色就做染坊的狂妄之徒了。</p>
<p>##始终用爱关怀他人<br>跟当时朱元璋的杀人如麻，简直是鲜明的对比。且不说她可能因为顾全大局而挽救了朱文正、李文忠、宋濂等人，就在她重病卧床急需医治时却不让太医为其医治，原因只是怕朱元璋认为太医无能医治不好马皇后而杀害无辜。这是一个始终用爱去关怀他人的高尚灵魂。</p>
<p>马皇后最后留给朱元璋的话是：“愿陛下求贤纳谏，有始有终，愿子孙个个贤能，百姓安居乐业，江山成年不朽”。有妻如此，夫得何求啊！可能直到她死时，朱元璋才知道这个人才是他的一切。</p>
<p>当年没房没车没前途的朱元璋能泡到马皇后这样的贤妻良母，并且患难不离弃、富贵不多求，说实话，心中只有满满的羡慕嫉妒恨。</p>
</div><hr></div><div class="recent-post-item article-container"><a class="article-title" href="/a/21.html">mongodb 数组操作运算符</a><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2016-01-27</time><span class="article-meta"><span class="article-meta__separator">|</span><i class="fa fa-inbox article-meta__icon" aria-hidden="true"></i><a class="article-meta__categories" href="/categories/tech/">tech</a></span><span class="article-meta tags"><span class="article-meta__separator">|</span><i class="fa fa-tag article-meta__icon" aria-hidden="true"></i><a class="article-meta__tags" href="/tags/mongodb/">mongodb</a></span><div class="content"><p>mongodb对于使用node.js开发的人来说应该不陌生，她与node.js的结合，十分的和谐且高效。接下来介绍一下mongodb的数组运算符,它们分别是$(update), $addToSet, $pop, $pullAll, $pull, $pushAll, $push, $each, $slice, $sort 与 $position，让我们来看看它们是怎样来为我们操作mongodb的数组字段的。</p>
<h2 id="update"><a href="#update" class="headerlink" title="$(update)"></a>$(update)</h2><p>简述：可以用来更新数组字段里是某个属性<br>用法：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123; &quot;&lt;array&gt;.$&quot; : value &#125;</span><br></pre></td></tr></table></figure>
<p>示例：<br>students表的原始数据</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123; &quot;_id&quot; : 1, grade: 80, mean: 75, &quot;grades&quot; : [ 80, 85, 90 ]， std： 1 &#125;</span><br></pre></td></tr></table></figure>
<h5 id="1-更新数组中的元素"><a href="#1-更新数组中的元素" class="headerlink" title="1.更新数组中的元素"></a>1.更新数组中的元素</h5><p>具体代码</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">db.students.update(</span><br><span class="line">   &#123; _id: 1, grades: 80 &#125;,</span><br><span class="line">   &#123; $set: &#123; &quot;grades.$&quot; : 82 &#125; &#125;</span><br><span class="line">)</span><br></pre></td></tr></table></figure>
<p>结果</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123; &quot;_id&quot; : 1, grade: 80, mean: 75, &quot;grades&quot; : [ 82, 85, 90 ]， std： 6 &#125;</span><br></pre></td></tr></table></figure>

<h5 id="2-多条件更新"><a href="#2-多条件更新" class="headerlink" title="2.多条件更新"></a>2.多条件更新</h5><p>具体代码</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">db.students.update(</span><br><span class="line">   &#123;</span><br><span class="line">     _id: 4,</span><br><span class="line">     grades: &#123; $elemMatch: &#123; grade: &#123; $lte: 90 &#125;, mean: &#123; $gt: 70 &#125; &#125; &#125;</span><br><span class="line">   &#125;,</span><br><span class="line">   &#123; $set: &#123; &quot;grades.$.std&quot; : 6 &#125; &#125;</span><br><span class="line">)</span><br></pre></td></tr></table></figure>
<p>结果</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123; &quot;_id&quot; : 1, grade: 80, mean: 75, &quot;grades&quot; : [ 80, 85, 90 ]， std： 6 &#125;</span><br></pre></td></tr></table></figure>

<p>小结：可以将$(update)运算符类比为js数组操作里的splice方法，只是不通过索引，而是通过具体的元素值比较。<br>用到的相关运算符： <a target="_blank" rel="noopener" href="https://docs.mongodb.org/manual/reference/operator/update/set/">$set</a>，<a target="_blank" rel="noopener" href="https://docs.mongodb.org/manual/reference/operator/query/elemMatch/">$elemMatch</a></p>
<h2 id="addToSet"><a href="#addToSet" class="headerlink" title="$addToSet"></a>$addToSet</h2><p>简述：将元素添加进数组字段，且不重复。这也正是set这一数据结构的特性。<br>用法：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123; $addToSet: &#123; &lt;field1&gt;: &lt;value1&gt;, ... &#125; &#125;</span><br></pre></td></tr></table></figure>
<p>示例：<br>inventory表的原始数据</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123; _id: 1, item: &quot;polarizing_filter&quot;, tags: [ &quot;electronics&quot;, &quot;camera&quot; ] &#125;</span><br></pre></td></tr></table></figure>
<h5 id="1-添加一个元素"><a href="#1-添加一个元素" class="headerlink" title="1.添加一个元素"></a>1.添加一个元素</h5><p>具体代码</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">db.inventory.update(</span><br><span class="line">   &#123; _id: 1 &#125;,</span><br><span class="line">   &#123; $addToSet: &#123; tags: &quot;accessories&quot; &#125; &#125;</span><br><span class="line">)</span><br></pre></td></tr></table></figure>
<p>结果</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123; _id: 1, item: &quot;polarizing_filter&quot;, tags: [ &quot;electronics&quot;, &quot;camera&quot;, &quot;accessories&quot; ] &#125;</span><br></pre></td></tr></table></figure>

<h5 id="2-添加多个元素"><a href="#2-添加多个元素" class="headerlink" title="2.添加多个元素"></a>2.添加多个元素</h5><p>具体代码</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">db.inventory.update(</span><br><span class="line">   &#123; _id: 1 &#125;,</span><br><span class="line">   &#123; $addToSet: &#123; tags: &#123; $each: [ &quot;camera&quot;, &quot;electronics&quot;, &quot;accessories&quot;, &quot;supplies&quot; ] &#125; &#125; &#125;</span><br><span class="line"> )</span><br></pre></td></tr></table></figure>
<p>结果</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123; _id: 1, item: &quot;polarizing_filter&quot;, tags: [ &quot;electronics&quot;, &quot;camera&quot;, &quot;accessories&quot;, &quot;supplies&quot; ] &#125;</span><br></pre></td></tr></table></figure>

<p>小结：利用$addToSet操作数组，我们可以不用去检测重复，十分方便，结合$each，可以直接传入数组，类似于js数组的concat方法，区别在于结果是个元素唯一的数组。</p>
<h2 id="pop"><a href="#pop" class="headerlink" title="$pop"></a>$pop</h2><p>简述：删除数组字段的第一个或最后一个元素。<br>用法：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123; $pop: &#123; &lt;field&gt;: &lt;-1 | 1&gt;, ... &#125; &#125;</span><br></pre></td></tr></table></figure>
<p>示例：<br>students表的原始数据</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123; _id: 1, scores: [ 8, 9, 10 ] &#125;</span><br></pre></td></tr></table></figure>
<h5 id="1-删除第一个元素"><a href="#1-删除第一个元素" class="headerlink" title="1.删除第一个元素"></a>1.删除第一个元素</h5><p>具体代码</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.students.update( &#123; _id: 1 &#125;, &#123; $pop: &#123; scores: -1 &#125; &#125; )</span><br></pre></td></tr></table></figure>
<p>结果</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123; _id: 1, scores: [ 9, 10 ] &#125;</span><br></pre></td></tr></table></figure>

<h5 id="2-删除最后一个元素"><a href="#2-删除最后一个元素" class="headerlink" title="2.删除最后一个元素"></a>2.删除最后一个元素</h5><p>具体代码</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.students.update( &#123; _id: 1 &#125;, &#123; $pop: &#123; scores: 1 &#125; &#125; )</span><br></pre></td></tr></table></figure>
<p>结果</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123; _id: 1, scores: [ 8, 9 ] &#125;</span><br></pre></td></tr></table></figure>

<p>小结：传入-1参数时，相当于js数组操作的shift方法；传入1参数时，相当于js数组操作的pop方法。</p>
<h2 id="pullAll"><a href="#pullAll" class="headerlink" title="$pullAll"></a>$pullAll</h2><p>简述：删除匹配的列表值的所有数组字段元素。<br>用法：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123; $pullAll: &#123; &lt;field1&gt;: [ &lt;value1&gt;, &lt;value2&gt; ... ], ... &#125; &#125;</span><br></pre></td></tr></table></figure>
<p>示例：<br>survey表的原始数据</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123; _id: 1, scores: [ 0, 2, 5, 5, 1, 0 ] &#125;</span><br></pre></td></tr></table></figure>
<p>具体代码</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.survey.update( &#123; _id: 1 &#125;, &#123; $pullAll: &#123; scores: [ 0, 5 ] &#125; &#125; )</span><br></pre></td></tr></table></figure>
<p>结果</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123; &quot;_id&quot; : 1, &quot;scores&quot; : [ 2, 1 ] &#125;</span><br></pre></td></tr></table></figure>

<p>小结：与$pull不同的是，$pullAll只是通过匹配列表值来删除元素，也就是说可以传入数组参数，然后比较两个数组的交集来进行删除，而前者是通过指定一个查询条件。</p>
<h2 id="pull"><a href="#pull" class="headerlink" title="$pull"></a>$pull</h2><p>简述：通过指定一个查询条件来删除所有符合条件的数组字段元素<br>用法：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123; $pull: &#123; &lt;field1&gt;: &lt;value|condition&gt;, &lt;field2&gt;: &lt;value|condition&gt;, ... &#125; &#125;</span><br></pre></td></tr></table></figure>
<p>示例：</p>
<h4 id="通过指定值删除"><a href="#通过指定值删除" class="headerlink" title="通过指定值删除"></a>通过指定值删除</h4><p>stores表的原始数据</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">   _id: 1,</span><br><span class="line">   fruits: [ &quot;apples&quot;, &quot;pears&quot;, &quot;oranges&quot;, &quot;grapes&quot;, &quot;bananas&quot; ],</span><br><span class="line">   vegetables: [ &quot;carrots&quot;, &quot;celery&quot;, &quot;squash&quot;, &quot;carrots&quot; ]</span><br><span class="line">&#125;</span><br><span class="line">&#123;</span><br><span class="line">   _id: 2,</span><br><span class="line">   fruits: [ &quot;plums&quot;, &quot;kiwis&quot;, &quot;oranges&quot;, &quot;bananas&quot;, &quot;apples&quot; ],</span><br><span class="line">   vegetables: [ &quot;broccoli&quot;, &quot;zucchini&quot;, &quot;carrots&quot;, &quot;onions&quot; ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>具体代码</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">db.stores.update(</span><br><span class="line">    &#123; &#125;,</span><br><span class="line">    &#123; $pull: &#123; fruits: &#123; $in: [ &quot;apples&quot;, &quot;oranges&quot; ] &#125;, vegetables: &quot;carrots&quot; &#125; &#125;,</span><br><span class="line">    &#123; multi: true &#125;</span><br><span class="line">)</span><br></pre></td></tr></table></figure>
<p>结果</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  &quot;_id&quot; : 1,</span><br><span class="line">  &quot;fruits&quot; : [ &quot;pears&quot;, &quot;grapes&quot;, &quot;bananas&quot; ],</span><br><span class="line">  &quot;vegetables&quot; : [ &quot;celery&quot;, &quot;squash&quot; ]</span><br><span class="line">&#125;</span><br><span class="line">&#123;</span><br><span class="line">  &quot;_id&quot; : 2,</span><br><span class="line">  &quot;fruits&quot; : [ &quot;plums&quot;, &quot;kiwis&quot;, &quot;bananas&quot; ],</span><br><span class="line">  &quot;vegetables&quot; : [ &quot;broccoli&quot;, &quot;zucchini&quot;, &quot;onions&quot; ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="通过查询条件删除"><a href="#通过查询条件删除" class="headerlink" title="通过查询条件删除"></a>通过查询条件删除</h5><p>原始数据</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123; _id: 1, votes: [ 3, 5, 6, 7, 7, 8 ] &#125;</span><br></pre></td></tr></table></figure>
<p>具体代码</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.profiles.update( &#123; _id: 1 &#125;, &#123; $pull: &#123; votes: &#123; $gte: 6 &#125; &#125; &#125; )</span><br></pre></td></tr></table></figure>
<p>结果</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123; _id: 1, votes: [  3,  5 ] &#125;</span><br></pre></td></tr></table></figure>

<h5 id="删除数组里的所有子项"><a href="#删除数组里的所有子项" class="headerlink" title="删除数组里的所有子项"></a>删除数组里的所有子项</h5><p>survey表的原始数据</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">   _id: 1,</span><br><span class="line">   results: [</span><br><span class="line">      &#123; item: &quot;A&quot;, score: 5 &#125;,</span><br><span class="line">      &#123; item: &quot;B&quot;, score: 8, comment: &quot;Strongly agree&quot; &#125;</span><br><span class="line">   ]</span><br><span class="line">&#125;</span><br><span class="line">&#123;</span><br><span class="line">   _id: 2,</span><br><span class="line">   results: [</span><br><span class="line">      &#123; item: &quot;C&quot;, score: 8, comment: &quot;Strongly agree&quot; &#125;,</span><br><span class="line">      &#123; item: &quot;B&quot;, score: 4 &#125;</span><br><span class="line">   ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>具体代码</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">db.survey.update(</span><br><span class="line">  &#123; &#125;,</span><br><span class="line">  &#123; $pull: &#123; results: &#123; score: 8 , item: &quot;B&quot; &#125; &#125; &#125;,</span><br><span class="line">  &#123; multi: true &#125;</span><br><span class="line">)</span><br></pre></td></tr></table></figure>
<p>结果</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">   &quot;_id&quot; : 1,</span><br><span class="line">   &quot;results&quot; : [ &#123; &quot;item&quot; : &quot;A&quot;, &quot;score&quot; : 5 &#125; ]</span><br><span class="line">&#125;</span><br><span class="line">&#123;</span><br><span class="line">  &quot;_id&quot; : 2,</span><br><span class="line">  &quot;results&quot; : [</span><br><span class="line">      &#123; &quot;item&quot; : &quot;C&quot;, &quot;score&quot; : 8, &quot;comment&quot; : &quot;Strongly agree&quot; &#125;,</span><br><span class="line">      &#123; &quot;item&quot; : &quot;B&quot;, &quot;score&quot; : 4 &#125;</span><br><span class="line">   ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里需要注意的是在$pull操作中，会将查询条件应用到每个元素，所以不能使用$elemMatch,用了反而匹配不到正确的元素。<br>如：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">db.survey.update(</span><br><span class="line">  &#123; &#125;,</span><br><span class="line">  &#123; $pull: &#123; results: &#123; $elemMatch: &#123; score: 8 , item: &quot;B&quot; &#125; &#125; &#125; &#125;,</span><br><span class="line">  &#123; multi: true &#125;</span><br><span class="line">)</span><br></pre></td></tr></table></figure>
<p>这样去对原始数据的操作是不能达到预期结果的，结果数据将没有变化。</p>
<p>然而，当我们需要匹配的是数组里嵌套的数组元素，且需要多个条件，那就需要$elemMatch的帮忙了。<br>原始数据</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">   _id: 1,</span><br><span class="line">   results: [</span><br><span class="line">      &#123; item: &quot;A&quot;, score: 5, answers: [ &#123; q: 1, a: 4 &#125;, &#123; q: 2, a: 6 &#125; ] &#125;,</span><br><span class="line">      &#123; item: &quot;B&quot;, score: 8, answers: [ &#123; q: 1, a: 8 &#125;, &#123; q: 2, a: 9 &#125; ] &#125;</span><br><span class="line">   ]</span><br><span class="line">&#125;</span><br><span class="line">&#123;</span><br><span class="line">   _id: 2,</span><br><span class="line">   results: [</span><br><span class="line">      &#123; item: &quot;C&quot;, score: 8, answers: [ &#123; q: 1, a: 8 &#125;, &#123; q: 2, a: 7 &#125; ] &#125;,</span><br><span class="line">      &#123; item: &quot;B&quot;, score: 4, answers: [ &#123; q: 1, a: 0 &#125;, &#123; q: 2, a: 8 &#125; ] &#125;</span><br><span class="line">   ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>具体代码</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">db.survey.update(</span><br><span class="line">  &#123; &#125;,</span><br><span class="line">  &#123; $pull: &#123; results: &#123; answers: &#123; $elemMatch: &#123; q: 2, a: &#123; $gte: 8 &#125; &#125; &#125; &#125; &#125; &#125;,</span><br><span class="line">  &#123; multi: true &#125;</span><br><span class="line">)</span><br></pre></td></tr></table></figure>
<p>结果</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">   &quot;_id&quot; : 1,</span><br><span class="line">   &quot;results&quot; : [</span><br><span class="line">      &#123; &quot;item&quot; : &quot;A&quot;, &quot;score&quot; : 5, &quot;answers&quot; : [ &#123; &quot;q&quot; : 1, &quot;a&quot; : 4 &#125;, &#123; &quot;q&quot; : 2, &quot;a&quot; : 6 &#125; ] &#125;</span><br><span class="line">   ]</span><br><span class="line">&#125;</span><br><span class="line">&#123;</span><br><span class="line">   &quot;_id&quot; : 2,</span><br><span class="line">   &quot;results&quot; : [</span><br><span class="line">      &#123; &quot;item&quot; : &quot;C&quot;, &quot;score&quot; : 8, &quot;answers&quot; : [ &#123; &quot;q&quot; : 1, &quot;a&quot; : 8 &#125;, &#123; &quot;q&quot; : 2, &quot;a&quot; : 7 &#125; ] &#125;</span><br><span class="line">   ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>小结：$pull可以通过指定查询条件来删除所有匹配的元素，如果需要像$pullAll的那样能传入数组进行匹配，那需要$in运算符的帮助。$pull的查询条件会应用到每个数组下的“顶级”元素，所以一般不需要使用$elemMatch，但如果需要匹配到数组里的嵌套数组元素，那就需要$elemMatch运算符的帮助了。</p>
<h2 id="pushAll"><a href="#pushAll" class="headerlink" title="$pushAll"></a>$pushAll</h2><p>2.4版本后移除，可使用$push,$each替代。这里将不作介绍</p>
<h2 id="push"><a href="#push" class="headerlink" title="$push"></a>$push</h2><p>简述：添加数组元素。<br>用法：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123; $push: &#123; &lt;field1&gt;: &lt;value1&gt;, ... &#125; &#125;</span><br></pre></td></tr></table></figure>
<p>或</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123; $push: &#123; &lt;field1&gt;: &#123; &lt;modifier1&gt;: &lt;value1&gt;, ... &#125;, ... &#125; &#125;</span><br></pre></td></tr></table></figure>
<p>示例：</p>
<h5 id="1-添加一个元素-1"><a href="#1-添加一个元素-1" class="headerlink" title="1.添加一个元素"></a>1.添加一个元素</h5><p>students表的原始数据</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;_id: 1, scores: [60, 80, 89]&#125;</span><br></pre></td></tr></table></figure>
<p>具体代码</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">db.students.update(</span><br><span class="line">   &#123; _id: 1 &#125;,</span><br><span class="line">   &#123; $push: &#123; scores: 89 &#125; &#125;</span><br><span class="line">)</span><br></pre></td></tr></table></figure>
<p>结果</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;_id: 1, scores: [60, 80, 89, 89]&#125;</span><br></pre></td></tr></table></figure>
<h5 id="2-添加多个元素-1"><a href="#2-添加多个元素-1" class="headerlink" title="2.添加多个元素"></a>2.添加多个元素</h5><p>具体代码</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">db.students.update(</span><br><span class="line">   &#123; name: &quot;joe&quot; &#125;,</span><br><span class="line">   &#123; $push: &#123; scores: &#123; $each: [ 90, 92, 85 ] &#125; &#125; &#125;</span><br><span class="line">)</span><br></pre></td></tr></table></figure>
<p>结果</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;_id: 1, scores: [60, 80, 89, 90, 92, 85]&#125;</span><br></pre></td></tr></table></figure>

<h5 id="使用多个运算符"><a href="#使用多个运算符" class="headerlink" title="使用多个运算符"></a>使用多个运算符</h5><p>students表的原始数据</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">   &quot;_id&quot; : 5,</span><br><span class="line">   &quot;quizzes&quot; : [</span><br><span class="line">      &#123; &quot;wk&quot;: 1, &quot;score&quot; : 10 &#125;,</span><br><span class="line">      &#123; &quot;wk&quot;: 2, &quot;score&quot; : 8 &#125;,</span><br><span class="line">      &#123; &quot;wk&quot;: 3, &quot;score&quot; : 5 &#125;,</span><br><span class="line">      &#123; &quot;wk&quot;: 4, &quot;score&quot; : 6 &#125;</span><br><span class="line">   ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>具体代码</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">db.students.update(</span><br><span class="line">   &#123; _id: 5 &#125;,</span><br><span class="line">   &#123;</span><br><span class="line">     $push: &#123;</span><br><span class="line">       quizzes: &#123;</span><br><span class="line">          $each: [ &#123; wk: 5, score: 8 &#125;, &#123; wk: 6, score: 7 &#125;, &#123; wk: 7, score: 6 &#125; ],</span><br><span class="line">          $sort: &#123; score: -1 &#125;,</span><br><span class="line">          $slice: 3</span><br><span class="line">       &#125;</span><br><span class="line">     &#125;</span><br><span class="line">   &#125;</span><br><span class="line">)</span><br></pre></td></tr></table></figure>
<p>结果</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  &quot;_id&quot; : 5,</span><br><span class="line">  &quot;quizzes&quot; : [</span><br><span class="line">     &#123; &quot;wk&quot; : 1, &quot;score&quot; : 10 &#125;,</span><br><span class="line">     &#123; &quot;wk&quot; : 2, &quot;score&quot; : 8 &#125;,</span><br><span class="line">     &#123; &quot;wk&quot; : 5, &quot;score&quot; : 8 &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>小结：与$addToSet很类似，区别在于$push可能会使数组字段的元素重复，而$addToSet不会。与js的push效果一样。</p>
<h2 id="each"><a href="#each" class="headerlink" title="$each"></a>$each</h2><p>简述：与$push,$addToSet结合，实现向数组字段添加多个元素的效果，类似于js的concat<br>用法与示例请见上方$addToSet与$push。</p>
<h2 id="slice"><a href="#slice" class="headerlink" title="$slice"></a>$slice</h2><p>简述：限制指定数值的数组字段元素。<br>用法：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  $push: &#123;</span><br><span class="line">     &lt;field&gt;: &#123;</span><br><span class="line">       $each: [ &lt;value1&gt;, &lt;value2&gt;, ... ],</span><br><span class="line">       $slice: &lt;num&gt;</span><br><span class="line">     &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>示例</p>
<h5 id="1-从数组末尾开始截取"><a href="#1-从数组末尾开始截取" class="headerlink" title="1.从数组末尾开始截取"></a>1.从数组末尾开始截取</h5><p>原始数据</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123; &quot;_id&quot; : 1, &quot;scores&quot; : [ 40, 50, 60 ] &#125;</span><br></pre></td></tr></table></figure>
<p>具体代码</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">db.students.update(</span><br><span class="line">   &#123; _id: 1 &#125;,</span><br><span class="line">   &#123;</span><br><span class="line">     $push: &#123;</span><br><span class="line">       scores: &#123;</span><br><span class="line">         $each: [ 80, 78, 86 ],</span><br><span class="line">         $slice: -5</span><br><span class="line">       &#125;</span><br><span class="line">     &#125;</span><br><span class="line">   &#125;</span><br><span class="line">)</span><br></pre></td></tr></table></figure>
<p>结果</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123; &quot;_id&quot; : 1, &quot;scores&quot; : [  50,  60,  80,  78,  86 ] &#125;</span><br></pre></td></tr></table></figure>

<h5 id="2-从数组头部开始截取"><a href="#2-从数组头部开始截取" class="headerlink" title="2.从数组头部开始截取"></a>2.从数组头部开始截取</h5><p>原始数据</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123; &quot;_id&quot; : 2, &quot;scores&quot; : [ 89, 90 ] &#125;</span><br></pre></td></tr></table></figure>
<p>具体代码</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">db.students.update(</span><br><span class="line">   &#123; _id: 2 &#125;,</span><br><span class="line">   &#123;</span><br><span class="line">     $push: &#123;</span><br><span class="line">       scores: &#123;</span><br><span class="line">         $each: [ 100, 20 ],</span><br><span class="line">         $slice: 3</span><br><span class="line">       &#125;</span><br><span class="line">     &#125;</span><br><span class="line">   &#125;</span><br><span class="line">)</span><br></pre></td></tr></table></figure>
<p>结果</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123; &quot;_id&quot; : 2, &quot;scores&quot; : [  89,  90,  100 ] &#125;</span><br></pre></td></tr></table></figure>

<h5 id="只使用-slice来更新数组"><a href="#只使用-slice来更新数组" class="headerlink" title="只使用$slice来更新数组"></a>只使用$slice来更新数组</h5><p>原始数据</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123; &quot;_id&quot; : 3, &quot;scores&quot; : [  89,  70,  100,  20 ] &#125;</span><br></pre></td></tr></table></figure>
<p>具体代码</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">db.students.update(</span><br><span class="line">  &#123; _id: 3 &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    $push: &#123;</span><br><span class="line">      scores: &#123;</span><br><span class="line">         $each: [ ],</span><br><span class="line">         $slice: -3</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">)</span><br></pre></td></tr></table></figure>
<p>结果</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123; &quot;_id&quot; : 3, &quot;scores&quot; : [  70,  100,  20 ] &#125;</span><br></pre></td></tr></table></figure>

<h5 id="与-push的相关运算符一起使用"><a href="#与-push的相关运算符一起使用" class="headerlink" title="与$push的相关运算符一起使用"></a>与$push的相关运算符一起使用</h5><p>见$push运算符的讲解。</p>
<p>小结：$slice主要是与$push相结合，来从数组头部或末尾开始截取数组元素的。在后面版本（官方上称2.6开始）将不强制$slice与$each结合使用。</p>
<h2 id="sort"><a href="#sort" class="headerlink" title="$sort"></a>$sort</h2><p>简述：对数组字段的元素进行排序。<br>用法：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  $push: &#123;</span><br><span class="line">     &lt;field&gt;: &#123;</span><br><span class="line">       $each: [ &lt;value1&gt;, &lt;value2&gt;, ... ],</span><br><span class="line">       $sort: &lt;sort specification&gt;</span><br><span class="line">     &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>示例：</p>
<h5 id="1-利用数组元素对数组进行排序"><a href="#1-利用数组元素对数组进行排序" class="headerlink" title="1.利用数组元素对数组进行排序"></a>1.利用数组元素对数组进行排序</h5><p>原始数据</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  &quot;_id&quot;: 1,</span><br><span class="line">  &quot;quizzes&quot;: [</span><br><span class="line">    &#123; &quot;id&quot; : 1, &quot;score&quot; : 6 &#125;,</span><br><span class="line">    &#123; &quot;id&quot; : 2, &quot;score&quot; : 9 &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>具体代码</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">db.students.update(</span><br><span class="line">   &#123; _id: 1 &#125;,</span><br><span class="line">   &#123;</span><br><span class="line">     $push: &#123;</span><br><span class="line">       quizzes: &#123;</span><br><span class="line">         $each: [ &#123; id: 3, score: 8 &#125;, &#123; id: 4, score: 7 &#125;, &#123; id: 5, score: 6 &#125; ],</span><br><span class="line">         $sort: &#123; score: 1 &#125;</span><br><span class="line">       &#125;</span><br><span class="line">     &#125;</span><br><span class="line">   &#125;</span><br><span class="line">)</span><br></pre></td></tr></table></figure>
<p>结果</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  &quot;_id&quot; : 1,</span><br><span class="line">  &quot;quizzes&quot; : [</span><br><span class="line">     &#123; &quot;id&quot; : 1, &quot;score&quot; : 6 &#125;,</span><br><span class="line">     &#123; &quot;id&quot; : 5, &quot;score&quot; : 6 &#125;,</span><br><span class="line">     &#123; &quot;id&quot; : 4, &quot;score&quot; : 7 &#125;,</span><br><span class="line">     &#123; &quot;id&quot; : 3, &quot;score&quot; : 8 &#125;,</span><br><span class="line">     &#123; &quot;id&quot; : 2, &quot;score&quot; : 9 &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="2-直接对数组进行排序"><a href="#2-直接对数组进行排序" class="headerlink" title="2.直接对数组进行排序"></a>2.直接对数组进行排序</h5><p>原始数据</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123; &quot;_id&quot; : 2, &quot;tests&quot; : [  89,  70,  89,  50 ] &#125;</span><br></pre></td></tr></table></figure>
<p>具体代码</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">db.students.update(</span><br><span class="line">   &#123; _id: 2 &#125;,</span><br><span class="line">   &#123; $push: &#123; tests: &#123; $each: [ 40, 60 ], $sort: 1 &#125; &#125; &#125;</span><br><span class="line">)</span><br></pre></td></tr></table></figure>
<p>结果</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123; &quot;_id&quot; : 2, &quot;tests&quot; : [  40,  50,  60,  70,  89,  89 ] &#125;</span><br></pre></td></tr></table></figure>

<h5 id="3-只排序，不更新数组"><a href="#3-只排序，不更新数组" class="headerlink" title="3.只排序，不更新数组"></a>3.只排序，不更新数组</h5><p>原始数据</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123; &quot;_id&quot; : 3, &quot;tests&quot; : [  89,  70,  100,  20 ] &#125;</span><br></pre></td></tr></table></figure>
<p>具体代码</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">db.students.update(</span><br><span class="line">   &#123; _id: 3 &#125;,</span><br><span class="line">   &#123; $push: &#123; tests: &#123; $each: [ ], $sort: -1 &#125; &#125; &#125;</span><br><span class="line">)</span><br></pre></td></tr></table></figure>
<p>结果</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123; &quot;_id&quot; : 3, &quot;tests&quot; : [ 100,  89,  70,  20 ] &#125;</span><br></pre></td></tr></table></figure>

<h5 id="4-与-push的相关运算符一起使用"><a href="#4-与-push的相关运算符一起使用" class="headerlink" title="4.与$push的相关运算符一起使用"></a>4.与$push的相关运算符一起使用</h5><p>见$push运算符的讲解。</p>
<p>小结：$sort为1时，表示按数值的从小到大排序；为-1时，则反过来。在后面版本（官方上称2.6开始）将不强制$slice与$each结合使用，这点与$slice相同。</p>
<h2 id="position"><a href="#position" class="headerlink" title="$position"></a>$position</h2><p>简述：与$push结合使用，表示元素添加的开始位置。<br>用法：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  $push: &#123;</span><br><span class="line">    &lt;field&gt;: &#123;</span><br><span class="line">       $each: [ &lt;value1&gt;, &lt;value2&gt;, ... ],</span><br><span class="line">       $position: &lt;num&gt;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>示例：</p>
<h5 id="1-从数组的起始位置开始添加"><a href="#1-从数组的起始位置开始添加" class="headerlink" title="1.从数组的起始位置开始添加"></a>1.从数组的起始位置开始添加</h5><p>原始数据</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123; &quot;_id&quot; : 1, &quot;scores&quot; : [ 100 ] &#125;</span><br></pre></td></tr></table></figure>
<p>具体代码</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">db.students.update(</span><br><span class="line">   &#123; _id: 1 &#125;,</span><br><span class="line">   &#123;</span><br><span class="line">     $push: &#123;</span><br><span class="line">        scores: &#123;</span><br><span class="line">           $each: [ 50, 60, 70 ],</span><br><span class="line">           $position: 0</span><br><span class="line">        &#125;</span><br><span class="line">     &#125;</span><br><span class="line">   &#125;</span><br><span class="line">)</span><br></pre></td></tr></table></figure>
<p>结果</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123; &quot;_id&quot; : 1, &quot;scores&quot; : [  50,  60,  70,  100 ] &#125;</span><br></pre></td></tr></table></figure>
<h5 id="2-把元素添加到原来的数组元素之间"><a href="#2-把元素添加到原来的数组元素之间" class="headerlink" title="2.把元素添加到原来的数组元素之间"></a>2.把元素添加到原来的数组元素之间</h5><p>原始数据</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123; &quot;_id&quot; : 1, &quot;scores&quot; : [  50,  60,  70,  100 ] &#125;</span><br></pre></td></tr></table></figure>
<p>具体代码</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">db.students.update(</span><br><span class="line">   &#123; _id: 1 &#125;,</span><br><span class="line">   &#123;</span><br><span class="line">     $push: &#123;</span><br><span class="line">        scores: &#123;</span><br><span class="line">           $each: [ 20, 30 ],</span><br><span class="line">           $position: 2</span><br><span class="line">        &#125;</span><br><span class="line">     &#125;</span><br><span class="line">   &#125;</span><br><span class="line">)</span><br></pre></td></tr></table></figure>
<p>结果</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123; &quot;_id&quot; : 1, &quot;scores&quot; : [  50,  60,  20,  30,  70,  100 ] &#125;</span><br></pre></td></tr></table></figure>

<p>小结：本来$push是默认从数组的末尾开始添加的元素的，但$position可以指定元素添加的开始位置。</p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>在mongodb中利用这些数组操作的运算符，将大大提高操作的效率和方便性，让你感觉就是在利用动态语言操作数组一样方便快捷。</p>
<h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><p><a target="_blank" rel="noopener" href="http://docs.mongoing.com/manual/reference/operator/update-array.html">mongodb-v3.2操作手册</a><br><a target="_blank" rel="noopener" href="http://www.w3school.com.cn/jsref/jsref_obj_array.asp">js数组操作</a></p>
</div><hr></div><div class="recent-post-item article-container"><a class="article-title" href="/a/22.html">express返回 413 Payload Too Large</a><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2016-01-27</time><span class="article-meta"><span class="article-meta__separator">|</span><i class="fa fa-inbox article-meta__icon" aria-hidden="true"></i><a class="article-meta__categories" href="/categories/tech/">tech</a></span><span class="article-meta tags"><span class="article-meta__separator">|</span><i class="fa fa-tag article-meta__icon" aria-hidden="true"></i><a class="article-meta__tags" href="/tags/node-js/">node.js</a><span class="article-meta__link">-</span><i class="fa fa-tag article-meta__icon" aria-hidden="true"></i><a class="article-meta__tags" href="/tags/nginx/">nginx</a></span><div class="content"><h2 id="偶遇413"><a href="#偶遇413" class="headerlink" title="偶遇413"></a>偶遇413</h2><p>在某次提交数据时，后台返回了413错误，如图所示：<br><img src="http://img.yangrunwei.com/article-img/20160127/72e8108d-d3c2-4751-8cac-64c5cea3e37e--22-1.png" alt="413-http-error" title="413-http-error"></p>
<h2 id="问题分析"><a href="#问题分析" class="headerlink" title="问题分析"></a>问题分析</h2><p>一开始还以为是nignx，因为百度“ 413 Payload Too Large”时，大部分返回的是关于nginx。所以我也着手修改了nginx的配置：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">client_max_body_size 50M;</span><br></pre></td></tr></table></figure>
<p>限制提交的body大小最大可达50M。然而并没有什么卵用。后台还是照样返回413。<br>再回过头来仔细看了一下后台返回的错误描述（chrome控制台的preview）内容，如图所示：<br><img src="http://img.yangrunwei.com/article-img/20160127/eb1f5e55-0562-4ec4-a1ef-6f926267e027--22-2.png" alt="preview内容" title="preview内容"><br>这个说明是后台程序抛出的错误，因为这里显示捕获错误的位置在node.js的模块中。<br>换了个思路，找到了<a target="_blank" rel="noopener" href="http://stackoverflow.com/questions/19917401/node-js-express-request-entity-too-large">stackoverflow上的有关问答</a><br>原来body-parser这个模块会对提交json默认限制在1mb。</p>
<h2 id="解决方法"><a href="#解决方法" class="headerlink" title="解决方法"></a>解决方法</h2><p>在express启动文件中加入以下代码：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">app.<span class="title function_">use</span>(express.<span class="title function_">json</span>(&#123;<span class="attr">limit</span>: <span class="string">&#x27;50mb&#x27;</span>&#125;));</span><br></pre></td></tr></table></figure>
<p>重启即可。</p>
</div><hr></div><nav id="pagination"><div class="pagination"><a class="extend prev" rel="prev" href="/page/10/"><i class="fa fa-chevron-left"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/10/">10</a><span class="page-number current">11</span><a class="page-number" href="/page/12/">12</a><span class="space">&hellip;</span><a class="page-number" href="/page/14/">14</a><a class="extend next" rel="next" href="/page/12/"><i class="fa fa-chevron-right"></i></a></div></nav></div></div><footer><div class="layout" id="footer"><div class="copyright">&copy;2015 - 2022 By 杨润炜</div><div class="framework-info"><span>Driven - </span><a target="_blank" rel="noopener" href="http://hexo.io"><span>Hexo</span></a><span class="footer-separator">|</span><span>Theme - </span><a target="_blank" rel="noopener" href="https://github.com/Molunerfinn/hexo-theme-melody"><span>Melody</span></a></div><div class="busuanzi"><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><span id="busuanzi_container_site_uv"><i class="fa fa-user"></i><span id="busuanzi_value_site_uv"></span><span></span></span><span class="footer-separator">|</span><span id="busuanzi_container_site_pv"><i class="fa fa-eye"></i><span id="busuanzi_value_site_pv"></span><span></span></span></div></div></footer><i class="fa fa-arrow-up" id="go-up" aria-hidden="true"></i><script src="https://cdn.jsdelivr.net/npm/animejs@latest/anime.min.js"></script><script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-animate@latest/velocity.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-ui-pack@latest/velocity.ui.min.js"></script><script src="/js/utils.js?version=1.9.0"></script><script src="/js/fancybox.js?version=1.9.0"></script><script src="/js/sidebar.js?version=1.9.0"></script><script src="/js/copy.js?version=1.9.0"></script><script src="/js/fireworks.js?version=1.9.0"></script><script src="/js/transition.js?version=1.9.0"></script><script src="/js/scroll.js?version=1.9.0"></script><script src="/js/head.js?version=1.9.0"></script><script>if(/Android|webOS|iPhone|iPod|iPad|BlackBerry/i.test(navigator.userAgent)) {
  $('#nav').addClass('is-mobile')
  $('footer').addClass('is-mobile')
  $('#top-container').addClass('is-mobile')
}</script></body></html>