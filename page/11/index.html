<!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta name="description" content=""><meta name="keywords" content=""><meta name="author" content="杨润炜"><meta name="copyright" content="杨润炜"><title>Cwalker</title><link rel="shortcut icon" href="/melody-favicon.ico"><link rel="stylesheet" href="/css/index.css?version=1.9.1"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@latest/css/font-awesome.min.css?version=1.9.1"><meta name="format-detection" content="telephone=no"><meta http-equiv="x-dns-prefetch-control" content="on"><link rel="dns-prefetch" href="https://cdn.jsdelivr.net"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  copy: {
    success: 'Copy successfully',
    error: 'Copy error',
    noSupport: 'The browser does not support'
  },
  hexoVersion: '6.3.0'
} </script><meta name="generator" content="Hexo 6.3.0"></head><body><i class="fa fa-arrow-right" id="toggle-sidebar" aria-hidden="true"></i><div id="sidebar" data-display="false"><div class="author-info"><div class="author-info__avatar text-center"><img src="/img/avatar.png"></div><div class="author-info__name text-center">杨润炜</div><div class="author-info__description text-center"></div><hr><div class="author-info-articles"><a class="author-info-articles__archives article-meta" href="/archives"><span class="pull-left">Articles</span><span class="pull-right">137</span></a><a class="author-info-articles__tags article-meta" href="/tags"><span class="pull-left">Tags</span><span class="pull-right">30</span></a><a class="author-info-articles__categories article-meta" href="/categories"><span class="pull-left">Categories</span><span class="pull-right">2</span></a></div></div></div><nav class="no-bg" id="nav"><div id="page-header"><span class="pull-left"> <a id="site-name" href="/">Cwalker</a></span><i class="fa fa-bars toggle-menu pull-right" aria-hidden="true"></i><span class="pull-right"></span></div><div id="site-info"><div id="site-title">Cwalker</div><div id="site-sub-title"></div></div></nav><div id="content-outer"><div class="layout" id="content-inner"><div class="recent-post-item article-container"><a class="article-title" href="/a/36.html">.gitignore规则不生效的解决办法</a><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2016-03-02</time><span class="article-meta"><span class="article-meta__separator">|</span><i class="fa fa-inbox article-meta__icon" aria-hidden="true"></i><a class="article-meta__categories" href="/categories/tech/">tech</a></span><span class="article-meta tags"><span class="article-meta__separator">|</span><i class="fa fa-tag article-meta__icon" aria-hidden="true"></i><a class="article-meta__tags" href="/tags/git/">git</a></span><div class="content"><p>.gitignore是配置git的提交和更新规则的文件，比如可以配置提交时排除某些文件。但如果要对之前已经被提交到本地的文件再配置排除，那是行不通的。</p>
<h2 id="解决方法"><a href="#解决方法" class="headerlink" title="解决方法"></a>解决方法</h2><p>首先配置好.gitignore，增加需要的配置项；<br>然后通过清除本地git仓库的缓存来解决，执行命令</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git rm -r --cached .</span><br></pre></td></tr></table></figure>
<p>再执行命令：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git add .</span><br></pre></td></tr></table></figure>

</div><hr></div><div class="recent-post-item article-container"><a class="article-title" href="/a/34.html">重新编译nginx</a><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2016-02-26</time><span class="article-meta"><span class="article-meta__separator">|</span><i class="fa fa-inbox article-meta__icon" aria-hidden="true"></i><a class="article-meta__categories" href="/categories/tech/">tech</a></span><span class="article-meta tags"><span class="article-meta__separator">|</span><i class="fa fa-tag article-meta__icon" aria-hidden="true"></i><a class="article-meta__tags" href="/tags/nginx/">nginx</a></span><div class="content"><h2 id="准备工作"><a href="#准备工作" class="headerlink" title="准备工作"></a>准备工作</h2><h5 id="找到之前nginx的安装包"><a href="#找到之前nginx的安装包" class="headerlink" title="找到之前nginx的安装包"></a>找到之前nginx的安装包</h5><p>如果之前有备份，则用这个备份的包。如果没有，则需要知道自己nginx的版本，然后到<a target="_blank" rel="noopener" href="http://nginx.org/">官网</a>下载此版本的安装包。</p>
<h5 id="更新openssl"><a href="#更新openssl" class="headerlink" title="更新openssl"></a>更新openssl</h5><p>为了防止出现以下错误，最好更新openssl，如图所示<br><img src="https://yrw-blog.oss-cn-shenzhen.aliyuncs.com/article-img/20160226/b04bafc4-54ca-43c9-acc0-6cd568935f0a--34-1.jpg" alt="openssl_error" title="openssl_error"></p>
<p>以ubuntu为例</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-get update</span><br></pre></td></tr></table></figure>

<h5 id="备份目前的nginx"><a href="#备份目前的nginx" class="headerlink" title="备份目前的nginx"></a>备份目前的nginx</h5><p>为了安全起见，最好做个备份。<br>假如nginx放在&#x2F;opt目录下，则执行以下命令</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo cp /opt/nginx/sbin/nginx /opt/nginx/sbin/nginx.bak</span><br></pre></td></tr></table></figure>


<h2 id="重新编译nginx"><a href="#重新编译nginx" class="headerlink" title="重新编译nginx"></a>重新编译nginx</h2><p>假如我们安装包放在家目录下的Soft目录里，版本是1.9.6，则依次执行以下命令</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">cd ~/Soft</span><br><span class="line">tar xvzf nginx-1.9.6.tar.gz</span><br><span class="line">cd nginx-1.9.6</span><br><span class="line">./configure --prefix=/opt/nginx --with-http_ssl_module</span><br><span class="line">make</span><br></pre></td></tr></table></figure>
<p>注：这里需要注意的是，不能用make install代替，因为make install是覆盖安装。</p>
<h2 id="平滑升级"><a href="#平滑升级" class="headerlink" title="平滑升级"></a>平滑升级</h2><p>此时当前目录下的objs里就有一个新的nginx文档，把这个新nginx覆盖掉目前的nginx就可以了。但是现在的nginx正在运行，怎样才能保证平滑升级呢？</p>
<h5 id="覆盖旧的nginx"><a href="#覆盖旧的nginx" class="headerlink" title="覆盖旧的nginx"></a>覆盖旧的nginx</h5><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo cp -rfp objs/nginx /opt/nginx/sbin/nginx</span><br></pre></td></tr></table></figure>

<h5 id="测试新版本nginx是否正常"><a href="#测试新版本nginx是否正常" class="headerlink" title="测试新版本nginx是否正常"></a>测试新版本nginx是否正常</h5><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cd /opt/nginx/sbin</span><br><span class="line">sudo ./nginx -t</span><br></pre></td></tr></table></figure>

<h5 id="平滑升级nginx"><a href="#平滑升级nginx" class="headerlink" title="平滑升级nginx"></a>平滑升级nginx</h5><h6 id="1-启动新nginx版本，新旧共存"><a href="#1-启动新nginx版本，新旧共存" class="headerlink" title="1.启动新nginx版本，新旧共存"></a>1.启动新nginx版本，新旧共存</h6><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo kill -USR2 `cat /opt/nginx/logs/nginx.pid` </span><br></pre></td></tr></table></figure>
<p>注：旧版本Nginx的pid变为oldbin，这是旧版本和新版本的nginx同时运行，过一段时间等就nginx处理完用户请求后，执行下面操作</p>
<h6 id="2-平缓停止worker-process"><a href="#2-平缓停止worker-process" class="headerlink" title="2.平缓停止worker process"></a>2.平缓停止worker process</h6><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kill -s WINCH `cat /opt/nginx/logs/nginx.pid.oldbin`</span><br></pre></td></tr></table></figure>

<h6 id="3-关闭旧版nginx"><a href="#3-关闭旧版nginx" class="headerlink" title="3.关闭旧版nginx"></a>3.关闭旧版nginx</h6><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kill -s QUIT `cat /opt/nginx/logs/nginx.pid.oldbin`</span><br></pre></td></tr></table></figure>

<h5 id="验证nginx是否升级成功"><a href="#验证nginx是否升级成功" class="headerlink" title="验证nginx是否升级成功"></a>验证nginx是否升级成功</h5><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/opt/nginx/sbin/nginx -V</span><br></pre></td></tr></table></figure>
<p>出现如下图结果则表示重新编译成功<br><img src="https://yrw-blog.oss-cn-shenzhen.aliyuncs.com/article-img/20160226/96f9ca7d-37b4-42ca-a3e0-c0634a8830d6--34-2.png" alt="nginw-v" title="nginw-v"></p>
<h2 id="若新版nginx有异常，需要回滚到旧版"><a href="#若新版nginx有异常，需要回滚到旧版" class="headerlink" title="若新版nginx有异常，需要回滚到旧版"></a>若新版nginx有异常，需要回滚到旧版</h2><p>在旧版进程还在的时候，执行如下命令</p>
<h6 id="1、不加载配置启用旧版进程，重新接收请求"><a href="#1、不加载配置启用旧版进程，重新接收请求" class="headerlink" title="1、不加载配置启用旧版进程，重新接收请求"></a>1、不加载配置启用旧版进程，重新接收请求</h6><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kill -s HUP `cat /opt/nginx/logs/nginx.oldbin`</span><br></pre></td></tr></table></figure>
<h6 id="2、关闭新版nginx进程"><a href="#2、关闭新版nginx进程" class="headerlink" title="2、关闭新版nginx进程"></a>2、关闭新版nginx进程</h6><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kill -s QUIT `cat /opt/nginx/logs/nginx.pid`</span><br></pre></td></tr></table></figure>


<h2 id="注意"><a href="#注意" class="headerlink" title="注意"></a>注意</h2><p>如果升级后出现改变nginx配置文件不生效的话，可以尝试停止nginx再启动。请看<a target="_blank" rel="noopener" href="https://www.yangrunwei.com/a/33.html">停止及启动nginx方法</a></p>
</div><hr></div><div class="recent-post-item article-container"><a class="article-title" href="/a/33.html">nginx的启动、重启及停止</a><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2016-02-26</time><span class="article-meta"><span class="article-meta__separator">|</span><i class="fa fa-inbox article-meta__icon" aria-hidden="true"></i><a class="article-meta__categories" href="/categories/tech/">tech</a></span><span class="article-meta tags"><span class="article-meta__separator">|</span><i class="fa fa-tag article-meta__icon" aria-hidden="true"></i><a class="article-meta__tags" href="/tags/nginx/">nginx</a></span><div class="content"><h2 id="启动"><a href="#启动" class="headerlink" title="启动"></a>启动</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./nginx</span><br></pre></td></tr></table></figure>

<h2 id="重启"><a href="#重启" class="headerlink" title="重启"></a>重启</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./nginx -s reload</span><br></pre></td></tr></table></figure>

<h2 id="停止"><a href="#停止" class="headerlink" title="停止"></a>停止</h2><h5 id="方法1："><a href="#方法1：" class="headerlink" title="方法1："></a>方法1：</h5><p>查看nginx主进程号</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ps -ef | grep nginx</span><br></pre></td></tr></table></figure>
<p>master进程则为主进程，它的编号就是主进程号，如图：</p>
<p><img src="https://yrw-blog.oss-cn-shenzhen.aliyuncs.com/article-img/20160226/feeff68c-0ff2-4935-b8dc-38906e39f12b--33-1.png" alt="查看nginx进程" title="查看nginx进程"></p>
<p>然后执行下面命令停止nginx</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kill -QUIT 1215</span><br></pre></td></tr></table></figure>
</div><hr></div><div class="recent-post-item article-container"><a class="article-title" href="/a/32.html">修改git远程仓库地址</a><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2016-02-26</time><span class="article-meta"><span class="article-meta__separator">|</span><i class="fa fa-inbox article-meta__icon" aria-hidden="true"></i><a class="article-meta__categories" href="/categories/tech/">tech</a></span><span class="article-meta tags"><span class="article-meta__separator">|</span><i class="fa fa-tag article-meta__icon" aria-hidden="true"></i><a class="article-meta__tags" href="/tags/git/">git</a></span><div class="content"><p>有时候我们在项目开发中途需要对项目远程仓库地址进行修改，git可以帮我们做到。</p>
<h2 id="修改远程仓库"><a href="#修改远程仓库" class="headerlink" title="修改远程仓库"></a>修改远程仓库</h2><p>方法：</p>
<blockquote>
<p>git remote set-url origin 仓库地址</p>
</blockquote>
<p>示例：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git remote set-url origin git@git.coding.net:glowry/wechat-server.git</span><br></pre></td></tr></table></figure>

<h2 id="查看结果"><a href="#查看结果" class="headerlink" title="查看结果"></a>查看结果</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git remote -v</span><br></pre></td></tr></table></figure>
</div><hr></div><div class="recent-post-item article-container"><a class="article-title" href="/a/35.html">nginx + Let's Encrypt + acme-tiny = https证书</a><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2016-02-26</time><span class="article-meta"><span class="article-meta__separator">|</span><i class="fa fa-inbox article-meta__icon" aria-hidden="true"></i><a class="article-meta__categories" href="/categories/tech/">tech</a></span><span class="article-meta tags"><span class="article-meta__separator">|</span><i class="fa fa-tag article-meta__icon" aria-hidden="true"></i><a class="article-meta__tags" href="/tags/qianlizhixing/">qianlizhixing</a><span class="article-meta__link">-</span><i class="fa fa-tag article-meta__icon" aria-hidden="true"></i><a class="article-meta__tags" href="/tags/nginx/">nginx</a></span><div class="content"><p><a target="_blank" rel="noopener" href="https://letsencrypt.org/">Let’s Encrypt</a> 项目旨在让每个网站都能使用 HTTPS 加密，该项目获得了 Mozilla、思科、Akamai、IdenTrust 和 EFF 等组织的支持， 由 Linux 基金会托管。<br><a target="_blank" rel="noopener" href="https://github.com/diafygi/acme-tiny">acme-tiny</a>可以方便我们创建及定期更新证书的小工具。</p>
<h2 id="准备工作"><a href="#准备工作" class="headerlink" title="准备工作"></a>准备工作</h2><h3 id="nginx支持ssl"><a href="#nginx支持ssl" class="headerlink" title="nginx支持ssl"></a>nginx支持ssl</h3><p>nginx必须有http_ssl_module，可通过nginx -V来查看。如果当初编译nginx时没有加入这个模块，则需要重新编译。可参考<a target="_blank" rel="noopener" href="https://www.yangrunwei.com/a/34.html">重新编译nginx</a>。</p>
<h2 id="生成网站证书"><a href="#生成网站证书" class="headerlink" title="生成网站证书"></a>生成网站证书</h2><p>下面内容主要参考<a target="_blank" rel="noopener" href="https://imququ.com/post/letsencrypt-certificate.html">Jerry Qu的小站文章</a>。本站的https也是主要参考它来做的。</p>
<h5 id="创建帐号"><a href="#创建帐号" class="headerlink" title="创建帐号"></a>创建帐号</h5><p>首先创建一个目录，例如 ssl，用来存放各种临时文件和最后的证书文件。进入这个目录，创建一个 RSA 私钥用于 Let’s Encrypt 识别你的身份：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">openssl genrsa 4096 &gt; account.key</span><br></pre></td></tr></table></figure>
<h5 id="配置验证服务"><a href="#配置验证服务" class="headerlink" title="配置验证服务"></a>配置验证服务</h5><p>我们知道，CA 在签发 DV（Domain Validation）证书时，需要验证域名所有权。传统 CA 的验证方式一般是往 <a href="mailto:&#97;&#100;&#109;&#x69;&#x6e;&#x40;&#x79;&#x6f;&#117;&#114;&#x73;&#105;&#116;&#x65;&#46;&#x63;&#x6f;&#109;">&#97;&#100;&#109;&#x69;&#x6e;&#x40;&#x79;&#x6f;&#117;&#114;&#x73;&#105;&#116;&#x65;&#46;&#x63;&#x6f;&#109;</a> 发验证邮件，而 Let’s Encrypt 是在你的服务器上生成一个随机验证文件，再通过创建 CSR 时指定的域名访问，如果可以访问则表明你对这个域名有控制权。<br>首先创建用于存放验证文件的目录，例如：<br>mkdir ~&#x2F;www&#x2F;challenges&#x2F;<br>在nginx上为上面指定的域名配置 HTTP 服务，以static.yangrunwei.com为例：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">server &#123;</span><br><span class="line">	listen 80;</span><br><span class="line">    server_name static.yangrunwei.com;</span><br><span class="line"></span><br><span class="line">    location ^~ /.well-known/acme-challenge/ &#123;</span><br><span class="line">        alias /home/xxx/www/challenges/;</span><br><span class="line">        try_files $uri =404;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    location / &#123;</span><br><span class="line">        rewrite ^/(.*)$ https://static.yangrunwei.com/$1 permanent;</span><br><span class="line">    &#125;</span><br><span class="line">	</span><br><span class="line">	...the rest of your config</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>以上配置优先查找 ~&#x2F;www&#x2F;challenges&#x2F; 目录下的文件，如果找不到就重定向到 HTTPS 地址。这个验证服务以后更新证书还要用到，需要一直保留。<br>重启nginx使配置生效（如果不知道怎样重启，可参考<a target="_blank" rel="noopener" href="https://www.yangrunwei.com/a/33.html">本文</a>）。</p>
<h5 id="创建-CSR-文件"><a href="#创建-CSR-文件" class="headerlink" title="创建 CSR 文件"></a>创建 CSR 文件</h5><p>接着就可以生成 CSR（Certificate Signing Request，证书签名请求）文件了。<br>首先，在之前的目录下再创建一个域名私钥（一定不要使用上面的账户私钥）：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">openssl genrsa 4096 &gt; domain.key</span><br></pre></td></tr></table></figure>
<p>如果要签发 ECC 证书，请使用以下任一命令生成 domain.key（我做的时候是没有生成ECC证书的）：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">#secp256r1</span><br><span class="line">openssl ecparam -genkey -name secp256r1 | openssl ec -out domain.key</span><br><span class="line"></span><br><span class="line">#secp384r1</span><br><span class="line">openssl ecparam -genkey -name secp384r1 | openssl ec -out domain.key</span><br></pre></td></tr></table></figure>

<p>然后就可以生成 CSR 文件了。推荐至少把域名带 www 和不带 www 的两种情况都加进去，其它子域可以根据需要添加（目前一张证书最多可以包含 100 个域名）：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">openssl req -new -sha256 -key domain.key -subj &quot;/&quot; -reqexts SAN -config &lt;(cat /etc/ssl/openssl.cnf &lt;(printf &quot;[SAN]\nsubjectAltName=DNS:yangrunwei.com,DNS:www.yangrunwei.com,DNS:static.yangrunwei.com,DNS:img.yangrunwei.com&quot;)) &gt; domain.csr</span><br></pre></td></tr></table></figure>
<p>执行这一步时，如果提示找不到 &#x2F;etc&#x2F;ssl&#x2F;openssl.cnf 文件，应该是没有安装 openssl 库。</p>
<p>执行的效果图如下：<br><img src="https://yrw-blog.oss-cn-shenzhen.aliyuncs.com/article-img/20160227/3200eac7-8873-4d22-9dc1-f6da6220acec--35-1.png" alt="配置验证服务效果图" title="效果图"></p>
<h5 id="获取网站证书"><a href="#获取网站证书" class="headerlink" title="获取网站证书"></a>获取网站证书</h5><p>下载 acme-tiny 脚本保存到之前的 ssl 目录：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wget https://raw.githubusercontent.com/diafygi/acme-tiny/master/acme_tiny.py</span><br></pre></td></tr></table></figure>
<p>指定账户私钥、CSR 以及验证目录，执行脚本：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python acme_tiny.py --account-key ./account.key --csr ./domain.csr --acme-dir ~/www/challenges/ &gt; ./signed.crt</span><br></pre></td></tr></table></figure>
<p>如果一切正常，当前目录下就会生成一个 signed.crt，这就是申请好的证书文件。<br>如果出现如下问题，则表示需要更换DNS，最好是国外的。</p>
<blockquote>
<p>ValueError: Wrote file to &#x2F;home&#x2F;xxx&#x2F;www&#x2F;challenges&#x2F;oJbvpIhkwkBGBAQUklWJXyC8VbWAdQqlgpwUJkgC1Vg, but couldn’t download <a target="_blank" rel="noopener" href="http://www.yoursite.com/.well-known/acme-challenge/oJbvpIhkwkBGBAQUklWJXyC8VbWAdQqlgpwUJkgC1Vg">http://www.yoursite.com/.well-known/acme-challenge/oJbvpIhkwkBGBAQUklWJXyC8VbWAdQqlgpwUJkgC1Vg</a></p>
</blockquote>
<p>本站用的是阿里云的服务器及其DNS解析，没有出现上述问题。</p>
<p>搞定网站证书后，还要下载 Let’s Encrypt 的中间证书。配置 HTTPS 证书时既不要漏掉中间证书，也不要包含根证书。在 Nginx 配置中，需要把中间证书和网站证书合在一起：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">wget -O - https://letsencrypt.org/certs/lets-encrypt-x1-cross-signed.pem &gt; intermediate.pem</span><br><span class="line">cat signed.crt intermediate.pem &gt; chained.pem</span><br></pre></td></tr></table></figure>
<p>最终，修改 Nginx 中有关证书的配置并重启服务即可。最终配置，以static.yangrunwei.com为例，如下</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">server &#123;</span><br><span class="line">    listen 443;</span><br><span class="line">    server_name static.yangrunwei.com;</span><br><span class="line">	</span><br><span class="line">    ssl on;</span><br><span class="line">    ssl_certificate /home/xxx/www/ssl/chained.pem;</span><br><span class="line">    ssl_certificate_key /home/xxx/www/ssl/domain.key;</span><br><span class="line">	</span><br><span class="line">	...the rest of your config</span><br><span class="line">&#125;</span><br><span class="line">server &#123;</span><br><span class="line">	listen 80;</span><br><span class="line">    server_name static.yangrunwei.com;</span><br><span class="line"></span><br><span class="line">    location ^~ /.well-known/acme-challenge/ &#123;</span><br><span class="line">        alias /home/xxx/www/challenges/;</span><br><span class="line">        try_files $uri =404;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    location / &#123;</span><br><span class="line">        rewrite ^/(.*)$ https://static.yangrunwei.com/$1 permanent;</span><br><span class="line">    &#125;</span><br><span class="line">	</span><br><span class="line">	...the rest of your config</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="配置阿里云OSS存储https"><a href="#配置阿里云OSS存储https" class="headerlink" title="配置阿里云OSS存储https"></a>配置阿里云OSS存储https</h2><p>因为本站图片资源放在阿里云的OSS存储上，所以img.yangrunwei.com CNAME到了阿里云的内容服务器上。由于阿里云OSS存储暂时不支持上传https证书，所以我只能通过nginx反向代理来做img.yangrunwei.com的https证书了。</p>
<h5 id="配置域名解析"><a href="#配置域名解析" class="headerlink" title="配置域名解析"></a>配置域名解析</h5><p>首先得配置img.yangrunwei.com A记录到自己的nginx服务器上。可以在DNS解析上修改，并且这个解析很快就可以生效（一般几分钟）。</p>
<h5 id="配置nginx反向代理"><a href="#配置nginx反向代理" class="headerlink" title="配置nginx反向代理"></a>配置nginx反向代理</h5><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">server &#123;</span><br><span class="line">    listen 443;</span><br><span class="line">    server_name img.yangrunwei.com;</span><br><span class="line"></span><br><span class="line">    ssl on;</span><br><span class="line">    ssl_certificate /home/xxx/www/ssl/chained.pem;</span><br><span class="line">    ssl_certificate_key /home/xxx/www/ssl/domain.key;</span><br><span class="line"></span><br><span class="line">    location ~ ^/ &#123;</span><br><span class="line">        proxy_set_header  Referer 防盗链域名;</span><br><span class="line">        proxy_pass OSS外网或内网域名;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">server &#123;</span><br><span class="line">    listen 80;</span><br><span class="line">    server_name img.yangrunwei.com;</span><br><span class="line"></span><br><span class="line">    location ^~ /.well-known/acme-challenge/ &#123;</span><br><span class="line">        alias /home/xxx/www/challenges/;</span><br><span class="line">        try_files $uri =404;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>注：如果你在OSS存储上设置了防盗链，必须在代理时加上referer，不然请求会403；代理的域名可选择OSS外网或内网域名，如果选择内网，则必须nginx服务器与OSS存储的服务在同一区域；这样做有一个很大的缺陷，就会nginx服务器压力会增大，因为原来的图片请求都要通过它来转发，而且无法做图片CDN（如果你有CDN，可以在CDN上传证书来解决）。</p>
<h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><p><a target="_blank" rel="noopener" href="https://imququ.com/post/letsencrypt-certificate.html">Let’s Encrypt，免费好用的 HTTPS 证书</a><br><a target="_blank" rel="noopener" href="https://github.com/diafygi/acme-tiny">acme-tiny</a><br><a target="_blank" rel="noopener" href="https://help.aliyun.com/knowledge_detail/6936834.html?pos=1">oss通过反向代理配置自己域名的https</a></p>
</div><hr></div><div class="recent-post-item article-container"><a class="article-title" href="/a/29.html">nginx block agent or ip</a><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2016-02-23</time><span class="article-meta"><span class="article-meta__separator">|</span><i class="fa fa-inbox article-meta__icon" aria-hidden="true"></i><a class="article-meta__categories" href="/categories/tech/">tech</a></span><span class="article-meta tags"><span class="article-meta__separator">|</span><i class="fa fa-tag article-meta__icon" aria-hidden="true"></i><a class="article-meta__tags" href="/tags/nginx/">nginx</a></span><div class="content"><p>我们网站上线后，往往会有不少爬虫及应用来抓取内容，有些是出于收录的好意，比如百度、谷歌，但也有的是恶意的爬虫，它们有时会影响网站性能，妨碍正常的用户访问。这时我们可以使用nginx的block配置来达到阻塞某些访问的目的。</p>
<h2 id="Block-Agent"><a href="#Block-Agent" class="headerlink" title="Block Agent"></a>Block Agent</h2><p>新建blockagent.conf，内容如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">#block http agent</span><br><span class="line"></span><br><span class="line">if ($http_user_agent ~* (HTMLParser|Scrapy))&#123;</span><br><span class="line">   return 403;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在你的nginx路由配置里引入些blockagent.conf</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">include blockagent.conf;</span><br></pre></td></tr></table></figure>

<p>重启nginx，生效配置</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo nginx -s reload</span><br></pre></td></tr></table></figure>

<p>之后如果nginx发现访问的agent是TMLParser或Scrapy的话，就会返回403状态，使我们后面的应用不响应此请求，从而不影响正常的用户访问。</p>
<h2 id="Block-Ip"><a href="#Block-Ip" class="headerlink" title="Block Ip"></a>Block Ip</h2><p>新建blockip.conf，内容如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">#block ips</span><br><span class="line"></span><br><span class="line">deny 183.3.152.18;</span><br><span class="line">deny 111.5.74.12;</span><br></pre></td></tr></table></figure>

<p>在你的nginx路由配置里引入些blockip.conf</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">include blockip.conf;</span><br></pre></td></tr></table></figure>

<p>重启nginx，生效配置</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo nginx -s reload</span><br></pre></td></tr></table></figure>

<p>之后如果nginx发现访问的ip是183.3.152.18或111.5.74.12的话，就会返回403状态，使我们后面的应用不响应此请求，从而不影响正常的用户访问。</p>
</div><hr></div><div class="recent-post-item article-container"><a class="article-title" href="/a/31.html">nginx实现页面缓存</a><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2016-02-23</time><span class="article-meta"><span class="article-meta__separator">|</span><i class="fa fa-inbox article-meta__icon" aria-hidden="true"></i><a class="article-meta__categories" href="/categories/tech/">tech</a></span><span class="article-meta tags"><span class="article-meta__separator">|</span><i class="fa fa-tag article-meta__icon" aria-hidden="true"></i><a class="article-meta__tags" href="/tags/nginx/">nginx</a></span><div class="content"><p>网站的首页往往是该网站访问量最大的页面，如果首页的业务比较复杂，后台对些页面需要使用较多的系统资源，包括CPU和内存，这就要求我们能够采用一些手段来减轻服务器的资源压力了。</p>
<h2 id="nginx实现页面缓存"><a href="#nginx实现页面缓存" class="headerlink" title="nginx实现页面缓存"></a>nginx实现页面缓存</h2><p>nginx下的conf目录里修改nginx.conf文件如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">http &#123;</span><br><span class="line">...</span><br><span class="line">proxy_cache_path  /tmp/cache  keys_zone=tmpcache:200m;</span><br><span class="line">...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在应用的路由配置文件里修改如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">server &#123;</span><br><span class="line">	...</span><br><span class="line">	location = / &#123;</span><br><span class="line">        limit_req zone=allips burst=4;</span><br><span class="line">        proxy_set_header  Host $host;</span><br><span class="line">        proxy_set_header X-Real-IP $remote_addr;</span><br><span class="line">        proxy_headers_hash_max_size 1024;</span><br><span class="line">        proxy_headers_hash_bucket_size 128;</span><br><span class="line">        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;</span><br><span class="line">        proxy_set_header Accept-Encoding &quot;&quot;;</span><br><span class="line">        proxy_cache tmpcache;</span><br><span class="line">        proxy_cache_key $host$uri$is_args$args;</span><br><span class="line">        proxy_cache_valid 200 304 1m;  #首页返回200或304时，缓存1分钟</span><br><span class="line">        add_header cached $upstream_cache_status;</span><br><span class="line">        proxy_pass http://127.0.0.1:3100;</span><br><span class="line">		proxy_http_version 1.1;</span><br><span class="line">        proxy_set_header Connection &quot;&quot;;</span><br><span class="line">    &#125;</span><br><span class="line">	...</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>打开<a target="_blank" rel="noopener" href="http://www.yangrunwei.com/">行之足首页</a>，在控制台查看结果，如图：<br><img src="https://yrw-blog.oss-cn-shenzhen.aliyuncs.com/article-img/20160223/f4c7fe6b-9665-451f-8e97-59b73f6495e9--31-1.png" alt="缓存结果" title="缓存结果"></p>
<p>HIT 表示命中缓存<br>EXPIRED 表示缓存过期<br>MISS 表示没有找到缓存</p>
</div><hr></div><div class="recent-post-item article-container"><a class="article-title" href="/a/30.html">nginx 预防单点故障</a><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2016-02-23</time><span class="article-meta"><span class="article-meta__separator">|</span><i class="fa fa-inbox article-meta__icon" aria-hidden="true"></i><a class="article-meta__categories" href="/categories/tech/">tech</a></span><span class="article-meta tags"><span class="article-meta__separator">|</span><i class="fa fa-tag article-meta__icon" aria-hidden="true"></i><a class="article-meta__tags" href="/tags/nginx/">nginx</a></span><div class="content"><p>通常情况我们需要密切关注网站服务的可持续访问，并且会采取一些宕机提醒及预防措施。下面我们通过配置nginx来实现预防网站服务单点故障的方法。</p>
<h2 id="预防单点故障"><a href="#预防单点故障" class="headerlink" title="预防单点故障"></a>预防单点故障</h2><p>我们的web服务通常运行在一台主服务器，由它来为用户的日常访问提供服务。如果这台web服务器宕机了，那么我们的所有业务服务将停止，这将对我们的利益带来很大的损失。如果在宕机时，有一个程序能把用户的访问转发到另外一台应急服务器上，那我们的服务将持续下去，而且在我们维护主服务器时能够不间断地提供服务。nginx就可以做到。下面我们来看看如何配置。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">upstream serverUpstream&#123;</span><br><span class="line">    server 10.252.131.148:3100;</span><br><span class="line">    server 10.173.163.241:3100 backup;</span><br><span class="line">    keepalive 8;</span><br><span class="line">&#125;</span><br><span class="line">server &#123;</span><br><span class="line">	...</span><br><span class="line">	location ~ ^/ &#123;</span><br><span class="line">        limit_req zone=allips burst=4;</span><br><span class="line">        proxy_set_header  Host $host;</span><br><span class="line">        proxy_set_header X-Real-IP $remote_addr;</span><br><span class="line">        proxy_headers_hash_max_size 1024;</span><br><span class="line">        proxy_headers_hash_bucket_size 128;</span><br><span class="line">        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;</span><br><span class="line">        proxy_set_header Accept-Encoding &quot;&quot;;</span><br><span class="line">        proxy_pass http://serverUpstream;</span><br><span class="line">        proxy_http_version 1.1;</span><br><span class="line">        proxy_set_header Connection &quot;&quot;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>serverUpstream中包含了两个ip地址，第一个是主服务器的地址，第二个是应急服务器的地址，并带上backup标记，表示主服务器无法工作时，就用backup服务器。</p>
<p>这样，nginx就帮我们做好单点故障的预防咯。还有需要注意的就是主服务器和应急服务器的代码同步，发布新版本时需要发布到这两个机器上去。再者，如果我们在服务器宕机时做个提醒，然后工程师们进行及时维修，nginx同时解决单点故障，这样项目就不会因为宕机而受到太大的影响。</p>
</div><hr></div><div class="recent-post-item article-container"><a class="article-title" href="/a/28.html">nginx location 优先级</a><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2016-02-18</time><span class="article-meta"><span class="article-meta__separator">|</span><i class="fa fa-inbox article-meta__icon" aria-hidden="true"></i><a class="article-meta__categories" href="/categories/tech/">tech</a></span><span class="article-meta tags"><span class="article-meta__separator">|</span><i class="fa fa-tag article-meta__icon" aria-hidden="true"></i><a class="article-meta__tags" href="/tags/nginx/">nginx</a></span><div class="content"><p>##location匹配命令概述</p>
<blockquote>
<p>A location can either be defined by a prefix string, or by a regular expression.</p>
</blockquote>
<p>location匹配命令包括前缀和正则表达式两种。具体有如下几种匹配命令：</p>
<h4 id=""><a href="#" class="headerlink" title="~"></a>~</h4><p>波浪线表示执行一个正则匹配，区分大小写</p>
<h4 id="-1"><a href="#-1" class="headerlink" title="~*"></a>~*</h4><p>表示执行一个正则匹配，不区分大小写</p>
<h4 id="-2"><a href="#-2" class="headerlink" title="^~"></a>^~</h4><p>匹配路径的前缀，如果找到，停止搜索。<br>表示普通字符匹配，如果该选项匹配，只匹配该选项，不匹配别的选项，一般用来匹配目录</p>
<h4 id="x3D"><a href="#x3D" class="headerlink" title="&#x3D;"></a>&#x3D;</h4><p>进行普通字符精确匹配</p>
<h4 id="-3"><a href="#-3" class="headerlink" title="@"></a>@</h4><p>“@” 定义一个命名的 location，使用在内部定向时，例如 error_page, try_files</p>
<p>##location优先级<br>&#x3D;(精确匹配) &gt; ^~(特殊路径前缀匹配) &gt; ~*(正则匹配) &#x3D; ~(正则匹配) &gt; 普通路径前缀匹配</p>
<p>####示例1<br>&#x3D;(精确匹配) &gt; ^~(特殊路径前缀匹配)</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">loaction ^~ /admin &#123;</span><br><span class="line">	[ configuration A ]</span><br><span class="line">&#125;</span><br><span class="line">loaction = /admin &#123;</span><br><span class="line">	[ configuration B ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>结果：&#x2F;admin匹配进 [ configuration B ]</p>
<p>####示例2<br>^~(路径的前缀匹配) &gt; ~*(正则匹配) &#x3D; ~(正则匹配)</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">loaction ~* ^/admin &#123;</span><br><span class="line">	[ configuration A ]</span><br><span class="line">&#125;</span><br><span class="line">loaction ~ ^/admin &#123;</span><br><span class="line">	[ configuration B ]</span><br><span class="line">&#125;</span><br><span class="line">loaction ^~ /admin &#123;</span><br><span class="line">	[ configuration C ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>结果：&#x2F;admin匹配进 [ configuration C ]</p>
<p>####示例3<br>按特殊路径前缀匹配匹配时，前缀越具体（越长）则优先匹配。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">loaction ^~ /admin &#123;</span><br><span class="line">	[ configuration A ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>结果：&#x2F;admin&#x2F;a匹配进 [ configuration A ]</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">loaction ^~ /admin &#123;</span><br><span class="line">	[ configuration A ]</span><br><span class="line">&#125;</span><br><span class="line">loaction ^~ /admin/a &#123;</span><br><span class="line">	[ configuration B ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>结果：&#x2F;admin&#x2F;a匹配进 [ configuration B ]</p>
<p>####示例4<br>正则匹配是按照配置时定义的顺序来匹配的，先匹配到的就停止。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">loaction ~* ^/admin &#123;</span><br><span class="line">	[ configuration A ]</span><br><span class="line">&#125;</span><br><span class="line">loaction ~ ^/admin &#123;</span><br><span class="line">	[ configuration B ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>结果：&#x2F;admin匹配进 [ configuration A ]</p>
<p>####示例5<br>按普通路径前缀匹配时，也是前缀越具体（越长）则优先匹配</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">loaction /admin &#123;</span><br><span class="line">	[ configuration A ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>结果：&#x2F;admin&#x2F;a匹配进 [ configuration A ]</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">loaction /admin &#123;</span><br><span class="line">	[ configuration A ]</span><br><span class="line">&#125;</span><br><span class="line">loaction /admin/a &#123;</span><br><span class="line">	[ configuration B ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>结果：&#x2F;admin&#x2F;a匹配进 [ configuration B ]</p>
<p>####官方文档示例</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">location = / &#123;</span><br><span class="line">    [ configuration A ]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">location / &#123;</span><br><span class="line">    [ configuration B ]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">location /documents/ &#123;</span><br><span class="line">    [ configuration C ]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">location ^~ /images/ &#123;</span><br><span class="line">    [ configuration D ]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">location ~* \.(gif|jpg|jpeg)$ &#123;</span><br><span class="line">    [ configuration E ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>结果1： &#x2F;匹配进[ configuration A ]<br>结果2： &#x2F;index.html匹配进[ configuration B ]<br>结果3： &#x2F;documents&#x2F;document.html匹配进[ configuration C ]<br>结果4： &#x2F;images&#x2F;1.gif匹配进[ configuration D ]<br>结果5： &#x2F;documents&#x2F;1.jpg匹配进[ configuration E ]</p>
<p>#####分析<br>结果1说明&#x3D;（精确匹配优先级最高）；<br>结果2及结果3说明前缀匹配时，前缀越具体（越长）则优先匹配；<br>结果4及结果5说明^~(路径的前缀匹配)优先级高于 ~*(正则匹配)。</p>
<h4 id="规则总结"><a href="#规则总结" class="headerlink" title="规则总结"></a>规则总结</h4><ol>
<li>&#x3D;(精确匹配) &gt; ^~(特殊路径前缀匹配) &gt; ~*(正则匹配) &#x3D; ~(正则匹配) &gt; 普通路径前缀匹配</li>
<li>正则匹配按配置顺序匹配</li>
<li>前缀匹配越具体（越长）则优先匹配</li>
</ol>
<p>##参考<br><a target="_blank" rel="noopener" href="http://nginx.org/en/docs/http/ngx_http_core_module.html#location">nginx-location文档</a></p>
</div><hr></div><div class="recent-post-item article-container"><a class="article-title" href="/a/26.html">mongodb控制台修改数据</a><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2016-02-15</time><span class="article-meta"><span class="article-meta__separator">|</span><i class="fa fa-inbox article-meta__icon" aria-hidden="true"></i><a class="article-meta__categories" href="/categories/tech/">tech</a></span><span class="article-meta tags"><span class="article-meta__separator">|</span><i class="fa fa-tag article-meta__icon" aria-hidden="true"></i><a class="article-meta__tags" href="/tags/mongodb/">mongodb</a></span><div class="content"><p>在某些特殊情况下，我们需要手动对mongodb的数据进行修改。这时我们可以写个程序跑一下，也可以在mongodb提供的命令行接口来实现这个需求。</p>
<p>##update方法</p>
<blockquote>
<p>db.table.update(query, obj, upsert, multi)</p>
</blockquote>
<p>####解释<br>table:要更新的数据表；<br>query：查询条件，类似于update语句内where后面的内容;<br>obj：update的对象和一些更新的操作符(如$、$inc等)，也可以理解为关系型数据库update语句内set后面的内容;<br>upsert：如果不存在update的纪录，是否插入obj这个新的document。true为插入，默认是false，不插入;<br>multi：默认是false,只更新找到的第一条纪录，如果为true,按条件查出来的多条纪录全部更新。</p>
<p>####示例</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.user.update(&#123;name:&quot;pauky&quot;&#125;,&#123;$set:&#123;age:15&#125;&#125;,false,false)</span><br></pre></td></tr></table></figure>
</div><hr></div><nav id="pagination"><div class="pagination"><a class="extend prev" rel="prev" href="/page/10/"><i class="fa fa-chevron-left"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/10/">10</a><span class="page-number current">11</span><a class="page-number" href="/page/12/">12</a><span class="space">&hellip;</span><a class="page-number" href="/page/14/">14</a><a class="extend next" rel="next" href="/page/12/"><i class="fa fa-chevron-right"></i></a></div></nav></div></div><footer><div class="layout" id="footer"><div class="copyright">&copy;2015 - 2023 By 杨润炜</div><div class="framework-info"><span>Driven - </span><a target="_blank" rel="noopener" href="http://hexo.io"><span>Hexo</span></a><span class="footer-separator">|</span><span>Theme - </span><a target="_blank" rel="noopener" href="https://github.com/Molunerfinn/hexo-theme-melody"><span>Melody</span></a></div><div class="busuanzi"><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><span id="busuanzi_container_site_uv"><i class="fa fa-user"></i><span id="busuanzi_value_site_uv"></span><span></span></span><span class="footer-separator">|</span><span id="busuanzi_container_site_pv"><i class="fa fa-eye"></i><span id="busuanzi_value_site_pv"></span><span></span></span></div></div></footer><i class="fa fa-arrow-up" id="go-up" aria-hidden="true"></i><script src="https://cdn.jsdelivr.net/npm/animejs@latest/anime.min.js"></script><script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-animate@latest/velocity.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-ui-pack@latest/velocity.ui.min.js"></script><script src="/js/utils.js?version=1.9.1"></script><script src="/js/fancybox.js?version=1.9.1"></script><script src="/js/sidebar.js?version=1.9.1"></script><script src="/js/copy.js?version=1.9.1"></script><script src="/js/fireworks.js?version=1.9.1"></script><script src="/js/transition.js?version=1.9.1"></script><script src="/js/scroll.js?version=1.9.1"></script><script src="/js/head.js?version=1.9.1"></script><script>if(/Android|webOS|iPhone|iPod|iPad|BlackBerry/i.test(navigator.userAgent)) {
  $('#nav').addClass('is-mobile')
  $('footer').addClass('is-mobile')
  $('#top-container').addClass('is-mobile')
}</script></body></html>