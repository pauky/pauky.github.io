<!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta name="description" content=""><meta name="keywords" content=""><meta name="author" content="杨润炜"><meta name="copyright" content="杨润炜"><title>Cwalker</title><link rel="shortcut icon" href="/melody-favicon.ico"><link rel="stylesheet" href="/css/index.css?version=1.9.0"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@latest/css/font-awesome.min.css?version=1.9.0"><meta name="format-detection" content="telephone=no"><meta http-equiv="x-dns-prefetch-control" content="on"><link rel="dns-prefetch" href="https://cdn.jsdelivr.net"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  copy: {
    success: 'Copy successfully',
    error: 'Copy error',
    noSupport: 'The browser does not support'
  },
  hexoVersion: '6.2.0'
} </script><meta name="generator" content="Hexo 6.2.0"></head><body><i class="fa fa-arrow-right" id="toggle-sidebar" aria-hidden="true"></i><div id="sidebar" data-display="false"><div class="author-info"><div class="author-info__avatar text-center"><img src="/img/avatar.png"></div><div class="author-info__name text-center">杨润炜</div><div class="author-info__description text-center"></div><hr><div class="author-info-articles"><a class="author-info-articles__archives article-meta" href="/archives"><span class="pull-left">Articles</span><span class="pull-right">132</span></a><a class="author-info-articles__tags article-meta" href="/tags"><span class="pull-left">Tags</span><span class="pull-right">29</span></a><a class="author-info-articles__categories article-meta" href="/categories"><span class="pull-left">Categories</span><span class="pull-right">2</span></a></div></div></div><nav class="no-bg" id="nav"><div id="page-header"><span class="pull-left"> <a id="site-name" href="/">Cwalker</a></span><i class="fa fa-bars toggle-menu pull-right" aria-hidden="true"></i><span class="pull-right"></span></div><div id="site-info"><div id="site-title">Cwalker</div><div id="site-sub-title"></div></div></nav><div id="content-outer"><div class="layout" id="content-inner"><div class="recent-post-item article-container"><a class="article-title" href="/a/42.html">介绍mongodb数据查询运算符</a><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2016-03-14</time><span class="article-meta"><span class="article-meta__separator">|</span><i class="fa fa-inbox article-meta__icon" aria-hidden="true"></i><a class="article-meta__categories" href="/categories/tech/">tech</a></span><span class="article-meta tags"><span class="article-meta__separator">|</span><i class="fa fa-tag article-meta__icon" aria-hidden="true"></i><a class="article-meta__tags" href="/tags/mongodb/">mongodb</a></span><div class="content"><p>今天来介绍下mongodb数据查询的几个运算符，它们都相对好理解。</p>
<h2 id="eq"><a href="#eq" class="headerlink" title="$eq"></a>$eq</h2><p>简述：匹配字段某值或者匹配数组字段内某子项的值来查询<br>记忆： equal<br>用法：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123; &lt;field&gt;: &#123; $eq: &lt;value&gt; &#125; &#125;</span><br></pre></td></tr></table></figure>
<p>示例：<br>inventory表的原始数据</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&#123; _id: 1, item: &#123; name: &quot;ab&quot;, code: &quot;123&quot; &#125;, qty: 15, tags: [ &quot;A&quot;, &quot;B&quot;, &quot;C&quot; ] &#125;</span><br><span class="line">&#123; _id: 2, item: &#123; name: &quot;cd&quot;, code: &quot;123&quot; &#125;, qty: 20, tags: [ &quot;B&quot; ] &#125;</span><br><span class="line">&#123; _id: 3, item: &#123; name: &quot;ij&quot;, code: &quot;456&quot; &#125;, qty: 25, tags: [ &quot;A&quot;, &quot;B&quot; ] &#125;</span><br><span class="line">&#123; _id: 4, item: &#123; name: &quot;xy&quot;, code: &quot;456&quot; &#125;, qty: 30, tags: [ &quot;B&quot;, &quot;A&quot; ] &#125;</span><br><span class="line">&#123; _id: 5, item: &#123; name: &quot;mn&quot;, code: &quot;000&quot; &#125;, qty: 20, tags: [ [ &quot;A&quot;, &quot;B&quot; ], &quot;C&quot; ] &#125;</span><br></pre></td></tr></table></figure>
<h5 id="1-匹配值"><a href="#1-匹配值" class="headerlink" title="1.匹配值"></a>1.匹配值</h5><p>具体代码</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.inventory.find( &#123; qty: &#123; $eq: 20 &#125; &#125; )</span><br></pre></td></tr></table></figure>
<p>等价于</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.inventory.find( &#123; qty: 20 &#125; )</span><br></pre></td></tr></table></figure>
<p>结果</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&#123; _id: 2, item: &#123; name: &quot;cd&quot;, code: &quot;123&quot; &#125;, qty: 20, tags: [ &quot;B&quot; ] &#125;</span><br><span class="line">&#123; _id: 5, item: &#123; name: &quot;mn&quot;, code: &quot;000&quot; &#125;, qty: 20, tags: [ [ &quot;A&quot;, &quot;B&quot; ], &quot;C&quot; ] &#125;</span><br></pre></td></tr></table></figure>

<h5 id="2-匹配数组字段子项的值"><a href="#2-匹配数组字段子项的值" class="headerlink" title="2.匹配数组字段子项的值"></a>2.匹配数组字段子项的值</h5><p>具体代码</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.inventory.find( &#123; tags: &#123; $eq: &quot;B&quot; &#125; &#125; )</span><br></pre></td></tr></table></figure>
<p>结果</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&#123; _id: 1, item: &#123; name: &quot;ab&quot;, code: &quot;123&quot; &#125;, qty: 15, tags: [ &quot;A&quot;, &quot;B&quot;, &quot;C&quot; ] &#125;</span><br><span class="line">&#123; _id: 2, item: &#123; name: &quot;cd&quot;, code: &quot;123&quot; &#125;, qty: 20, tags: [ &quot;B&quot; ] &#125;</span><br><span class="line">&#123; _id: 3, item: &#123; name: &quot;ij&quot;, code: &quot;456&quot; &#125;, qty: 25, tags: [ &quot;A&quot;, &quot;B&quot; ] &#125;</span><br><span class="line">&#123; _id: 4, item: &#123; name: &quot;xy&quot;, code: &quot;456&quot; &#125;, qty: 30, tags: [ &quot;B&quot;, &quot;A&quot; ] &#125;</span><br></pre></td></tr></table></figure>

<p>小结：$eq匹配值等价于直接匹配值，其主要使用点还是在于匹配数组字段子项的值。</p>
<h2 id="gt-gte-lt-lte"><a href="#gt-gte-lt-lte" class="headerlink" title="$gt, $gte, $lt, $lte"></a>$gt, $gte, $lt, $lte</h2><p>这四个运算符的用法很相似，只要知道一个，其它都可以依此类推，只要知道：<br>$gt表示匹配字段某值大于指定值;<br>$gte表示匹配字段某值大于等于指定值;<br>$lt表示匹配字段某值小于指定值;<br>$lte表示匹配字段某值小于等于指定值;</p>
<p>下面用$gt来进行详细说明。<br>简述：匹配字段某值大于指定值<br>用法：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;field: &#123;$gt: value&#125; &#125;</span><br></pre></td></tr></table></figure>
<p>示例：<br>inventory表的原始数据<br>同$eq的inventory数据。</p>
<p>具体代码</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.inventory.find( &#123; qty: &#123; $gt: 20 &#125; &#125; )</span><br></pre></td></tr></table></figure>

<p>结果</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&#123; _id: 3, item: &#123; name: &quot;ij&quot;, code: &quot;456&quot; &#125;, qty: 25, tags: [ &quot;A&quot;, &quot;B&quot; ] &#125;</span><br><span class="line">&#123; _id: 4, item: &#123; name: &quot;xy&quot;, code: &quot;456&quot; &#125;, qty: 30, tags: [ &quot;B&quot;, &quot;A&quot; ] &#125;</span><br></pre></td></tr></table></figure>

<p>注：在这几个运算符中，可对js的date类型值进行直接比较。</p>
<h2 id="ne"><a href="#ne" class="headerlink" title="$ne"></a>$ne</h2><p>简述：匹配字段某值不为指定值<br>记忆： not equal<br>用法：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;field: &#123;$ne: value&#125; &#125;</span><br></pre></td></tr></table></figure>
<p>示例：<br>inventory表的原始数据</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&#123; _id: 1, item: &#123; name: &quot;ab&quot;, code: &quot;123&quot; &#125;, qty: 15, tags: [ &quot;A&quot;, &quot;B&quot;, &quot;C&quot; ] &#125;</span><br><span class="line">&#123; _id: 2, item: &#123; name: &quot;cd&quot; &#125;, qty: 20, tags: [ &quot;B&quot; ] &#125;</span><br><span class="line">&#123; _id: 3, item: &#123; name: &quot;ij&quot; &#125;, qty: 25, tags: [ &quot;A&quot;, &quot;B&quot; ] &#125;</span><br><span class="line">&#123; _id: 4, item: &#123; name: &quot;xy&quot;, code: &quot;456&quot; &#125;, qty: 30, tags: [ &quot;B&quot;, &quot;A&quot; ] &#125;</span><br><span class="line">&#123; _id: 5, item: &#123; name: &quot;mn&quot;, code: &quot;000&quot; &#125;, qty: 20, tags: [ [ &quot;A&quot;, &quot;B&quot; ], &quot;C&quot; ] &#125;</span><br></pre></td></tr></table></figure>
<h5 id="1-不等于具体值"><a href="#1-不等于具体值" class="headerlink" title="1. 不等于具体值"></a>1. 不等于具体值</h5><p>具体代码</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.inventory.find( &#123; qty: &#123; $ne: 20 &#125; &#125; )</span><br></pre></td></tr></table></figure>
<p>结果</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&#123; _id: 1, item: &#123; name: &quot;ab&quot;, code: &quot;123&quot; &#125;, qty: 15, tags: [ &quot;A&quot;, &quot;B&quot;, &quot;C&quot; ] &#125;</span><br><span class="line">&#123; _id: 3, item: &#123; name: &quot;ij&quot; &#125;, qty: 25, tags: [ &quot;A&quot;, &quot;B&quot; ] &#125;</span><br><span class="line">&#123; _id: 4, item: &#123; name: &quot;xy&quot;, code: &quot;456&quot; &#125;, qty: 30, tags: [ &quot;B&quot;, &quot;A&quot; ] &#125;</span><br></pre></td></tr></table></figure>

<h4 id="2-没有某字段"><a href="#2-没有某字段" class="headerlink" title="2.没有某字段"></a>2.没有某字段</h4><p>具体代码</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.inventory.find( &#123; &quot;item.code&quot;: &#123; $ne: null &#125; &#125; )</span><br></pre></td></tr></table></figure>
<p>结果</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&#123; _id: 1, item: &#123; name: &quot;ab&quot;, code: &quot;123&quot; &#125;, qty: 15, tags: [ &quot;A&quot;, &quot;B&quot;, &quot;C&quot; ] &#125;</span><br><span class="line">&#123; _id: 4, item: &#123; name: &quot;xy&quot;, code: &quot;456&quot; &#125;, qty: 30, tags: [ &quot;B&quot;, &quot;A&quot; ] &#125;</span><br><span class="line">&#123; _id: 5, item: &#123; name: &quot;mn&quot;, code: &quot;000&quot; &#125;, qty: 20, tags: [ [ &quot;A&quot;, &quot;B&quot; ], &quot;C&quot; ] &#125;</span><br></pre></td></tr></table></figure>

<h2 id="in-nin"><a href="#in-nin" class="headerlink" title="$in, $nin"></a>$in, $nin</h2><p>简述：与$eq,$ne相似，区别在于指定值是数组，即一些数值，可以为把要比较的字段数值与1个以上的数据进行比较。<br>下面用$in来举例<br>用法：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123; field: &#123; $in: [&lt;value1&gt;, &lt;value2&gt;, ... &lt;valueN&gt; ] &#125; &#125;</span><br></pre></td></tr></table></figure>
<p>示例：<br>inventory表的原始数据</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&#123; _id: 1, item: &#123; name: &quot;ab&quot;, code: &quot;123&quot; &#125;, qty: 15, tags: [ &quot;ab&quot;, &quot;abc&quot;, &quot;123&quot; ] &#125;</span><br><span class="line">&#123; _id: 4, item: &#123; name: &quot;xy&quot;, code: &quot;456&quot; &#125;, qty: 30, tags: [ &quot;B&quot;, &quot;abc&quot; ] &#125;</span><br><span class="line">&#123; _id: 5, item: &#123; name: &quot;mn&quot;, code: &quot;000&quot; &#125;, qty: 20, tags: [ [ &quot;A&quot;, &quot;B&quot; ], &quot;C&quot; ] &#125;</span><br></pre></td></tr></table></figure>
<h5 id="1-1个以上常规值匹配"><a href="#1-1个以上常规值匹配" class="headerlink" title="1. 1个以上常规值匹配"></a>1. 1个以上常规值匹配</h5><p>具体代码</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.inventory.find( &#123; tags: &#123; $in: [&#x27;abc&#x27;, &#x27;123&#x27;] &#125; &#125; )</span><br></pre></td></tr></table></figure>
<p>结果</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&#123; _id: 1, item: &#123; name: &quot;ab&quot;, code: &quot;123&quot; &#125;, qty: 15, tags: [ &quot;ab&quot;, &quot;abc&quot;, &quot;123&quot; ] &#125;</span><br><span class="line">&#123; _id: 4, item: &#123; name: &quot;xy&quot;, code: &quot;456&quot; &#125;, qty: 30, tags: [ &quot;B&quot;, &quot;abc&quot; ] &#125;</span><br></pre></td></tr></table></figure>

<h4 id="2-正规表达式匹配"><a href="#2-正规表达式匹配" class="headerlink" title="2.正规表达式匹配"></a>2.正规表达式匹配</h4><p>具体代码</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.inventory.find( &#123; tags: &#123; $in: [/^ab/, /^12/] &#125; &#125; )</span><br></pre></td></tr></table></figure>
<p>结果</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&#123; _id: 1, item: &#123; name: &quot;ab&quot;, code: &quot;123&quot; &#125;, qty: 15, tags: [ &quot;ab&quot;, &quot;abc&quot;, &quot;123&quot; ] &#125;</span><br><span class="line">&#123; _id: 4, item: &#123; name: &quot;xy&quot;, code: &quot;456&quot; &#125;, qty: 30, tags: [ &quot;B&quot;, &quot;abc&quot; ] &#125;</span><br></pre></td></tr></table></figure>
</div><hr></div><div class="recent-post-item article-container"><a class="article-title" href="/a/41.html">开启HTTP/2</a><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2016-03-09</time><span class="article-meta"><span class="article-meta__separator">|</span><i class="fa fa-inbox article-meta__icon" aria-hidden="true"></i><a class="article-meta__categories" href="/categories/tech/">tech</a></span><span class="article-meta tags"><span class="article-meta__separator">|</span><i class="fa fa-tag article-meta__icon" aria-hidden="true"></i><a class="article-meta__tags" href="/tags/qianlizhixing/">qianlizhixing</a><span class="article-meta__link">-</span><i class="fa fa-tag article-meta__icon" aria-hidden="true"></i><a class="article-meta__tags" href="/tags/nginx/">nginx</a></span><div class="content"><p>好久前就听说Http2.0，听说它比1版本有性能上的提升并且还有主动把请求推送到客户端的功能。因为开启http2.0需要先实现https，并且nginx版本需要在1.9以上，刚好本站满足这样的要求。今天终于压制不住好奇，搞了一下本站对http2.0的支持。</p>
<h2 id="关于HTTP-x2F-2及其优点"><a href="#关于HTTP-x2F-2及其优点" class="headerlink" title="关于HTTP&#x2F;2及其优点"></a>关于HTTP&#x2F;2及其优点</h2><h5 id="HTTP-x2F-2"><a href="#HTTP-x2F-2" class="headerlink" title="HTTP&#x2F;2"></a>HTTP&#x2F;2</h5><p>HTTP&#x2F;2（超文本传输协议第2版，最初命名为HTTP 2.0），是HTTP协议的的第二个主要版本，使用于万维网。HTTP&#x2F;2是HTTP协议自1999年HTTP 1.1发布后的首个更新，主要基于SPDY协议。</p>
<h5 id="优点"><a href="#优点" class="headerlink" title="优点"></a>优点</h5><p>1、采用二进制格式传输数据，而非文本格式，二进制格式在协议的解析和优化扩展上带来更多的优势和可能；<br>2、对消息头进行压缩传输，能够节省消息头占用的网络的流量，而 http1.1 每次请求，都会携带大量冗余头信息，浪费了很多带宽资源，头压缩能够很好的解决该问题；<br>3、多路复用，就是多个请求都是通过一个 TCP 连接并发完成，http1.1 虽然通过pipeline也能并发请求，但是多个请求之间的响应会被阻塞的，所以 pipeline 至今也没有被普及应用，而 http2.0做到了真正的并发请求，同时，流还支持优先级和流量控制；<br>4、服务器推送，服务端能够更快的把资源推送给客户端，例如服务端可以主动把 JS 和 CSS 文件推送给客户端，而不需要客户端解析 HTML 再发送这些请求，当客户端需要的时候，它已经在客户端了</p>
<h2 id="HTTP-x2F-2站点的优势"><a href="#HTTP-x2F-2站点的优势" class="headerlink" title="HTTP&#x2F;2站点的优势"></a>HTTP&#x2F;2站点的优势</h2><p>1，提升网站访问速度；<br>2，降低服务器压力;<br>3，部分替代异步加载的使用；<br>4，保护网站安全。</p>
<h2 id="如何开启HTTP-x2F-2"><a href="#如何开启HTTP-x2F-2" class="headerlink" title="如何开启HTTP&#x2F;2"></a>如何开启HTTP&#x2F;2</h2><p>哇，看到HTTP&#x2F;2有这么多优点，真想马上就换上。下面为大家讲述下本站是如何利用nginx开启HTTP&#x2F;2的。</p>
<h5 id="nginx加入http-v2-module模块"><a href="#nginx加入http-v2-module模块" class="headerlink" title="nginx加入http_v2_module模块"></a>nginx加入http_v2_module模块</h5><p>nginx版本需要在1.9以上，并且需要有http_v2_module模块，如果没有，请重新编译。本站有<a target="_blank" rel="noopener" href="https://www.yangrunwei.com/a/34.html">重新编译nginx</a>的文章。<br>具体实现的话，只需要把相应代码修改成以下即可：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./configure --prefix=/opt/nginx --with-http_ssl_module --with-http_v2_module</span><br></pre></td></tr></table></figure>
<h5 id="修改nginx配置"><a href="#修改nginx配置" class="headerlink" title="修改nginx配置"></a>修改nginx配置</h5><p>需要修改的配置很简单，代码如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">server &#123;</span><br><span class="line">    listen 443 ssl http2;</span><br><span class="line">	...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>只需要在之前的ssl后加上http2，重新启动nginx即可。</p>
<h5 id="验证是否开启"><a href="#验证是否开启" class="headerlink" title="验证是否开启"></a>验证是否开启</h5><p>在nginx日志中输出$request变量，tail -f 的形式看下nginx的日志，然后访问站点，如果输出有HTTP&#x2F;2.0即表示开启成功。</p>
<h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><p><a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/HTTP/2">HTTP&#x2F;2</a><br><a target="_blank" rel="noopener" href="http://picasso250.github.io/2015/12/03/nignx-http2-cipher.html">Nginx HTTP 2 的编译和配置</a><br><a target="_blank" rel="noopener" href="http://www.szfangwei.cn/news/2886.html">HTTP2.0来了，看看哪些优点值得你更换</a><br><a target="_blank" rel="noopener" href="http://nginx.org/en/docs/http/ngx_http_v2_module.html">Module ngx_http_v2_module</a></p>
</div><hr></div><div class="recent-post-item article-container"><a class="article-title" href="/a/40.html">mongodb获取相邻数据</a><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2016-03-08</time><span class="article-meta"><span class="article-meta__separator">|</span><i class="fa fa-inbox article-meta__icon" aria-hidden="true"></i><a class="article-meta__categories" href="/categories/tech/">tech</a></span><span class="article-meta tags"><span class="article-meta__separator">|</span><i class="fa fa-tag article-meta__icon" aria-hidden="true"></i><a class="article-meta__tags" href="/tags/qianlizhixing/">qianlizhixing</a><span class="article-meta__link">-</span><i class="fa fa-tag article-meta__icon" aria-hidden="true"></i><a class="article-meta__tags" href="/tags/mongodb/">mongodb</a></span><div class="content"><p>今天给本站文章页面增加了文章的上一篇与下一篇的链接。原理相对简单，主要是利用文章的分页来实现的。下面通过代码与讲解来简单分析下。</p>
<h2 id="获取上一篇"><a href="#获取上一篇" class="headerlink" title="获取上一篇"></a>获取上一篇</h2><p>取出文章表中创建时间小于当前数据的创建时间的，注意要按发布时间的倒序排列，然后取第一个，便是所要的当前文章的上一篇。具体代码实现如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">article.find(&#123;createTime: &#123;$lt: currentArticle.createTime&#125;&#125;, &#x27;_id&#x27;, &#123;skip: 0, limit: 1, sort: &#123;createTime: &#x27;desc&#x27;&#125;&#125;);</span><br></pre></td></tr></table></figure>

<h2 id="获取下一篇"><a href="#获取下一篇" class="headerlink" title="获取下一篇"></a>获取下一篇</h2><p>如果理解了上一篇的取法，那下一篇也自然懂得了。<br>取出文章表中创建时间大于当前数据的创建时间的，注意要按发布时间的正序排列，然后取第一个，便是所要的当前文章的下一篇。具体代码实现如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">article.find(&#123;createTime: &#123;$gt: currentArticle.createTime&#125;&#125;, &#x27;_id&#x27;, &#123;skip: 0, limit: 1, sort: &#123;createTime: &#x27;asc&#x27;&#125;&#125;);</span><br></pre></td></tr></table></figure>
</div><hr></div><div class="recent-post-item article-container"><a class="article-title" href="/a/39.html">PC及移动端网页中嵌入视频</a><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2016-03-08</time><span class="article-meta"><span class="article-meta__separator">|</span><i class="fa fa-inbox article-meta__icon" aria-hidden="true"></i><a class="article-meta__categories" href="/categories/tech/">tech</a></span><span class="article-meta tags"><span class="article-meta__separator">|</span><i class="fa fa-tag article-meta__icon" aria-hidden="true"></i><a class="article-meta__tags" href="/tags/webFE/">webFE</a></span><div class="content"><p>UEditor编辑器提供了嵌入视频的功能，实际上是往html里嵌入embed元素。这是H5新标签，目前有兼容问题。目前最兼容的方案还是使用iframe来实现。然而允许用户或者运营者提交iframe，是十分不安全的。所以，我们折衷地在输出内容时，将embed用iframe代替，这样在未来浏览器都升级后可以直接使用embed，也可以保证现在可以正常运行。</p>
<h2 id="拿腾讯视频举栗子"><a href="#拿腾讯视频举栗子" class="headerlink" title="拿腾讯视频举栗子"></a>拿腾讯视频举栗子</h2><h5 id="1-首先获取到视频源，我们取embed里的src值，如图："><a href="#1-首先获取到视频源，我们取embed里的src值，如图：" class="headerlink" title="1.首先获取到视频源，我们取embed里的src值，如图："></a>1.首先获取到视频源，我们取embed里的src值，如图：</h5><p><img src="https://img.yangrunwei.com/article-img/20160308/cbb72b84-2f0c-44d3-b4fd-87c38faa9a34--39-1.png" alt="获取腾讯视频源" title="获取腾讯视频源"></p>
<h5 id="2-将值填入UEditor编辑器的视频上传组件中，如图："><a href="#2-将值填入UEditor编辑器的视频上传组件中，如图：" class="headerlink" title="2.将值填入UEditor编辑器的视频上传组件中，如图："></a>2.将值填入UEditor编辑器的视频上传组件中，如图：</h5><p><img src="https://img.yangrunwei.com/article-img/20160308/2da9216a-a622-4a5b-bebc-f1fa4b86d68c--39-2.png" alt="UEditor上传视频" title="UEditor上传视频"></p>
<h5 id="3-输出时将ebmed替换成iframe"><a href="#3-输出时将ebmed替换成iframe" class="headerlink" title="3.输出时将ebmed替换成iframe"></a>3.输出时将ebmed替换成iframe</h5><p>网站用jade模块，读者也可以在前端进行替换，代码如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">content = content.replace(/&lt;embed(.*?) src=&quot;http:\/\/static\.video\.qq\.com\/(.*?)\.swf(.*?)&quot;&gt;/gmi, &#x27;&lt;iframe frameborder=&quot;0&quot; width=&quot;100%&quot; height=&quot;200&quot; src=&quot;http://v.qq.com/iframe/player.html?$3&amp;tiny=0&quot; allowfullscreen&gt;&lt;/iframe&gt;&#x27;)</span><br></pre></td></tr></table></figure>
<p>之所以能够将embed替换成iframe，是因为腾讯视频的swf源和iframe源基本只有根域名的差别，知道一个可以推导成另一个，如<br>swf源为：</p>
<blockquote>
<p><a target="_blank" rel="noopener" href="http://static.video.qq.com/TPout.swf?vid=x00193363qx&amp;auto=0">http://static.video.qq.com/TPout.swf?vid=x00193363qx&amp;auto=0</a></p>
</blockquote>
<p>那iframe源则为：</p>
<blockquote>
<p><a target="_blank" rel="noopener" href="http://v.qq.com/iframe/player.html?vid=x00193363qx&amp;tiny=0&amp;auto=0">http://v.qq.com/iframe/player.html?vid=x00193363qx&amp;tiny=0&amp;auto=0</a></p>
</blockquote>
</div><hr></div><div class="recent-post-item article-container"><a class="article-title" href="/a/37.html">谈谈自己平时使用的页面布局方法</a><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2016-03-03</time><span class="article-meta"><span class="article-meta__separator">|</span><i class="fa fa-inbox article-meta__icon" aria-hidden="true"></i><a class="article-meta__categories" href="/categories/tech/">tech</a></span><span class="article-meta tags"><span class="article-meta__separator">|</span><i class="fa fa-tag article-meta__icon" aria-hidden="true"></i><a class="article-meta__tags" href="/tags/webFE/">webFE</a></span><div class="content"><h2 id="position相对布局"><a href="#position相对布局" class="headerlink" title="position相对布局"></a>position相对布局</h2><p>这种布局一般使用在一个元素相对于父元素的定位，如右下角，中间等。首先把父元素，即布局元素要参考的元素设置position为relative，然后自身设置absolute，这样就可以达到相对布局的效果了。这里会有一种特殊情况，即需要定位在中间，即元素是垂直且水平居中，首先设置定位元素top: 50%; right: 50%; 这时元素并不是被定位在参考元素的中间，这时要把需要定位的元素设置宽高，然后margin-left: 宽度一半;margin-top:高度一半;这样就能达到定位在中间的效果了。具体看下面代码：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">&lt;!DOCTYPE html&gt;</span><br><span class="line">&lt;html&gt;</span><br><span class="line">&lt;head&gt;</span><br><span class="line">  &lt;meta charset=&quot;UTF-8&quot;&gt;</span><br><span class="line">  &lt;title&gt;&lt;/title&gt;</span><br><span class="line">  &lt;style&gt;</span><br><span class="line">    .wrap &#123;</span><br><span class="line">      border: 1px solid #aaaaaa;</span><br><span class="line">      background-color: #eeeeee;</span><br><span class="line">      width: 300px;</span><br><span class="line">      height: 300px;</span><br><span class="line">      position: relative;</span><br><span class="line">    &#125;</span><br><span class="line">    .k1 &#123;</span><br><span class="line">      position: absolute;</span><br><span class="line">      bottom: 0;</span><br><span class="line">      right: 0;</span><br><span class="line">    &#125;</span><br><span class="line">    .k2 &#123;</span><br><span class="line">      position: absolute;</span><br><span class="line">      width: 20px;</span><br><span class="line">      height: 20px;</span><br><span class="line">      left: 50%;</span><br><span class="line">      top: 50%;</span><br><span class="line">      margin-left: -10px;</span><br><span class="line">      margin-top: -10px;</span><br><span class="line">    &#125;</span><br><span class="line">  &lt;/style&gt;</span><br><span class="line">&lt;/head&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">  &lt;div class=&quot;wrap&quot;&gt;</span><br><span class="line">    &lt;div class=&quot;k1&quot;&gt;1&lt;/div&gt;</span><br><span class="line">    &lt;div class=&quot;k2&quot;&gt;2&lt;/div&gt;</span><br><span class="line">  &lt;/div&gt;</span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure>

<h2 id="inline-block大法"><a href="#inline-block大法" class="headerlink" title="inline-block大法"></a>inline-block大法</h2><p>inline-block可以使行内元素，如a，span，i等，可以设置宽高，也可以使div在同一行排列起来。缺点是元素间会有间隔，可以在父元素上设置</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">font-size: 0;</span><br><span class="line">-webkit-text-size-adjust:none;</span><br></pre></td></tr></table></figure>
<p>来消除这个间隔。</p>
<h2 id="vertical-align-middle"><a href="#vertical-align-middle" class="headerlink" title="vertical-align: middle"></a>vertical-align: middle</h2><p>这个样式我主要是使用在把图片与文字居中显示。如果我们要把img与span里的文字居中显示。只需要把img与span设置</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">display: inline-block;</span><br><span class="line">vertical-align: middle;</span><br></pre></td></tr></table></figure>
<p>checkbox与文字居中也可以用这种方式来实现。</p>
<h2 id="兼容到ie8及以上的页面布局"><a href="#兼容到ie8及以上的页面布局" class="headerlink" title="兼容到ie8及以上的页面布局"></a>兼容到ie8及以上的页面布局</h2><p>最近需要做兼容到ie8及以上的页面，而且没有使用UI框架，全是需要自己用css来构建。通过参考一些大的门户网站（因为这些网站面向所有群体，所以兼容肯定做得不赖，虽然有些比较丑），发现了以下的布局方法。<br>接下来通过代码来演示</p>
<h5 id="具体实现代码如下："><a href="#具体实现代码如下：" class="headerlink" title="具体实现代码如下："></a>具体实现代码如下：</h5><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">&lt;!DOCTYPE html&gt;</span><br><span class="line">&lt;html&gt;</span><br><span class="line">&lt;head&gt;</span><br><span class="line">  &lt;meta charset=&quot;UTF-8&quot;&gt;</span><br><span class="line">  &lt;title&gt;&lt;/title&gt;</span><br><span class="line">  &lt;style&gt;</span><br><span class="line">    .wrap &#123;</span><br><span class="line">      width: 610px;</span><br><span class="line">    &#125;</span><br><span class="line">    .clearfix:after &#123;</span><br><span class="line">      content: &quot;.&quot;;</span><br><span class="line">      display: block;</span><br><span class="line">      height: 0;</span><br><span class="line">      clear: both;</span><br><span class="line">      visibility: hidden;</span><br><span class="line">    &#125;</span><br><span class="line">    .f-l &#123;</span><br><span class="line">      float: left;</span><br><span class="line">    &#125;</span><br><span class="line">    .item &#123;</span><br><span class="line">      border: 1px solid #aaaaaa;</span><br><span class="line">      background-color: #eeeeee;</span><br><span class="line">      width: 200px;</span><br><span class="line">      height: 200px;</span><br><span class="line">      line-height: 200px;</span><br><span class="line">      text-align: center;</span><br><span class="line">    &#125;</span><br><span class="line">  &lt;/style&gt;</span><br><span class="line">&lt;/head&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">  &lt;div class=&quot;clearfix wrap&quot;&gt;</span><br><span class="line">    &lt;div class=&quot;item f-l&quot;&gt;块1&lt;/div&gt;</span><br><span class="line">    &lt;div class=&quot;item f-l&quot;&gt;块2&lt;/div&gt;</span><br><span class="line">    &lt;div class=&quot;item f-l&quot; style=&quot;height: 300px&quot;&gt;块3&lt;/div&gt;</span><br><span class="line">    &lt;div class=&quot;item f-l&quot;  style=&quot;height: 300px&quot;&gt;块4&lt;/div&gt;</span><br><span class="line">    &lt;div class=&quot;item f-l&quot;&gt;块5&lt;/div&gt;</span><br><span class="line">  &lt;/div&gt;</span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure>
<p>效果图如下：<br><img src="https://img.yangrunwei.com/article-img/20160303/dff605d5-dc9c-400e-8be5-0963dce23554--37-1.png" alt="布局效果图" title="布局效果图"></p>
<h2 id="表格布局"><a href="#表格布局" class="headerlink" title="表格布局"></a>表格布局</h2><p>模拟表格的方式来对元素进行布局排列。因为表格的样式更符合布局的习惯，或者说更符合一些设计的需求。但因为表格元素有特定的语义，所以不建议直接使用表格元素布局，但display可以让我们满足表格形式的布局。具体看代码：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">&lt;!DOCTYPE html&gt;</span><br><span class="line">&lt;html&gt;</span><br><span class="line">&lt;head&gt;</span><br><span class="line">  &lt;meta charset=&quot;UTF-8&quot;&gt;</span><br><span class="line">  &lt;title&gt;&lt;/title&gt;</span><br><span class="line">  &lt;style&gt;</span><br><span class="line">    .wrap &#123;</span><br><span class="line">      width: 610px;</span><br><span class="line">      display: table;</span><br><span class="line">    &#125;</span><br><span class="line">    .row &#123;</span><br><span class="line">      display: table-row;</span><br><span class="line">    &#125;</span><br><span class="line">    .item &#123;</span><br><span class="line">      border: 1px solid #aaaaaa;</span><br><span class="line">      background-color: #eeeeee;</span><br><span class="line">      width: 200px;</span><br><span class="line">      height: 200px;</span><br><span class="line">      line-height: 200px;</span><br><span class="line">      text-align: center;</span><br><span class="line">      display: table-cell;</span><br><span class="line">    &#125;</span><br><span class="line">  &lt;/style&gt;</span><br><span class="line">&lt;/head&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">  &lt;div class=&quot;wrap&quot;&gt;</span><br><span class="line">    &lt;div class=&quot;row&quot;&gt;</span><br><span class="line">      &lt;div class=&quot;item f-l&quot;&gt;块1&lt;/div&gt;</span><br><span class="line">      &lt;div class=&quot;item f-l&quot;&gt;块2&lt;/div&gt;</span><br><span class="line">      &lt;div class=&quot;item f-l&quot;&gt;块3&lt;/div&gt;</span><br><span class="line">    &lt;/div&gt;</span><br><span class="line">  &lt;/div&gt;</span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure>
<p>注：这种布局的特点时，在设置元素宽高的时候，可以不包括border。这也使得有时候更方便计算。</p>
<h2 id="页面布局资源"><a href="#页面布局资源" class="headerlink" title="页面布局资源"></a>页面布局资源</h2><p><a target="_blank" rel="noopener" href="http://www.w3cplus.com/css/centering-css-complete-guide.html">CSS居中完整指南</a><br><a target="_blank" rel="noopener" href="http://www.w3cplus.com/css/elements-horizontally-center-with-css.html">六种实现元素水平居中</a><br><a target="_blank" rel="noopener" href="http://www.zhangxinxu.com/wordpress/2012/04/inline-block-space-remove-%E5%8E%BB%E9%99%A4%E9%97%B4%E8%B7%9D/">去除inline-block元素间间距的N种方法</a><br><a target="_blank" rel="noopener" href="http://www.divcss5.com/css-texiao/texiao571.shtml">CSS3圆角圆边 支持IE6-IE8浏览器</a></p>
</div><hr></div><div class="recent-post-item article-container"><a class="article-title" href="/a/36.html">.gitignore规则不生效的解决办法</a><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2016-03-02</time><span class="article-meta"><span class="article-meta__separator">|</span><i class="fa fa-inbox article-meta__icon" aria-hidden="true"></i><a class="article-meta__categories" href="/categories/tech/">tech</a></span><span class="article-meta tags"><span class="article-meta__separator">|</span><i class="fa fa-tag article-meta__icon" aria-hidden="true"></i><a class="article-meta__tags" href="/tags/git/">git</a></span><div class="content"><p>.gitignore是配置git的提交和更新规则的文件，比如可以配置提交时排除某些文件。但如果要对之前已经被提交到本地的文件再配置排除，那是行不通的。</p>
<h2 id="解决方法"><a href="#解决方法" class="headerlink" title="解决方法"></a>解决方法</h2><p>首先配置好.gitignore，增加需要的配置项；<br>然后通过清除本地git仓库的缓存来解决，执行命令</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git rm -r --cached .</span><br></pre></td></tr></table></figure>
<p>再执行命令：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git add .</span><br></pre></td></tr></table></figure>

</div><hr></div><div class="recent-post-item article-container"><a class="article-title" href="/a/34.html">重新编译nginx</a><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2016-02-26</time><span class="article-meta"><span class="article-meta__separator">|</span><i class="fa fa-inbox article-meta__icon" aria-hidden="true"></i><a class="article-meta__categories" href="/categories/tech/">tech</a></span><span class="article-meta tags"><span class="article-meta__separator">|</span><i class="fa fa-tag article-meta__icon" aria-hidden="true"></i><a class="article-meta__tags" href="/tags/nginx/">nginx</a></span><div class="content"><h2 id="准备工作"><a href="#准备工作" class="headerlink" title="准备工作"></a>准备工作</h2><h5 id="找到之前nginx的安装包"><a href="#找到之前nginx的安装包" class="headerlink" title="找到之前nginx的安装包"></a>找到之前nginx的安装包</h5><p>如果之前有备份，则用这个备份的包。如果没有，则需要知道自己nginx的版本，然后到<a target="_blank" rel="noopener" href="http://nginx.org/">官网</a>下载此版本的安装包。</p>
<h5 id="更新openssl"><a href="#更新openssl" class="headerlink" title="更新openssl"></a>更新openssl</h5><p>为了防止出现以下错误，最好更新openssl，如图所示<br><img src="https://img.yangrunwei.com/article-img/20160226/b04bafc4-54ca-43c9-acc0-6cd568935f0a--34-1.jpg" alt="openssl_error" title="openssl_error"></p>
<p>以ubuntu为例</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-get update</span><br></pre></td></tr></table></figure>

<h5 id="备份目前的nginx"><a href="#备份目前的nginx" class="headerlink" title="备份目前的nginx"></a>备份目前的nginx</h5><p>为了安全起见，最好做个备份。<br>假如nginx放在&#x2F;opt目录下，则执行以下命令</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo cp /opt/nginx/sbin/nginx /opt/nginx/sbin/nginx.bak</span><br></pre></td></tr></table></figure>


<h2 id="重新编译nginx"><a href="#重新编译nginx" class="headerlink" title="重新编译nginx"></a>重新编译nginx</h2><p>假如我们安装包放在家目录下的Soft目录里，版本是1.9.6，则依次执行以下命令</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">cd ~/Soft</span><br><span class="line">tar xvzf nginx-1.9.6.tar.gz</span><br><span class="line">cd nginx-1.9.6</span><br><span class="line">./configure --prefix=/opt/nginx --with-http_ssl_module</span><br><span class="line">make</span><br></pre></td></tr></table></figure>
<p>注：这里需要注意的是，不能用make install代替，因为make install是覆盖安装。</p>
<h2 id="平滑升级"><a href="#平滑升级" class="headerlink" title="平滑升级"></a>平滑升级</h2><p>此时当前目录下的objs里就有一个新的nginx文档，把这个新nginx覆盖掉目前的nginx就可以了。但是现在的nginx正在运行，怎样才能保证平滑升级呢？</p>
<h5 id="覆盖旧的nginx"><a href="#覆盖旧的nginx" class="headerlink" title="覆盖旧的nginx"></a>覆盖旧的nginx</h5><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo cp -rfp objs/nginx /opt/nginx/sbin/nginx</span><br></pre></td></tr></table></figure>

<h5 id="测试新版本nginx是否正常"><a href="#测试新版本nginx是否正常" class="headerlink" title="测试新版本nginx是否正常"></a>测试新版本nginx是否正常</h5><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cd /opt/nginx/sbin</span><br><span class="line">sudo ./nginx -t</span><br></pre></td></tr></table></figure>

<h5 id="平滑升级nginx"><a href="#平滑升级nginx" class="headerlink" title="平滑升级nginx"></a>平滑升级nginx</h5><h6 id="1-启动新nginx版本，新旧共存"><a href="#1-启动新nginx版本，新旧共存" class="headerlink" title="1.启动新nginx版本，新旧共存"></a>1.启动新nginx版本，新旧共存</h6><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo kill -USR2 `cat /opt/nginx/logs/nginx.pid` </span><br></pre></td></tr></table></figure>
<p>注：旧版本Nginx的pid变为oldbin，这是旧版本和新版本的nginx同时运行，过一段时间等就nginx处理完用户请求后，执行下面操作</p>
<h6 id="2-平缓停止worker-process"><a href="#2-平缓停止worker-process" class="headerlink" title="2.平缓停止worker process"></a>2.平缓停止worker process</h6><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kill -s WINCH `cat /opt/nginx/logs/nginx.pid.oldbin`</span><br></pre></td></tr></table></figure>

<h6 id="3-关闭旧版nginx"><a href="#3-关闭旧版nginx" class="headerlink" title="3.关闭旧版nginx"></a>3.关闭旧版nginx</h6><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kill -s QUIT `cat /opt/nginx/logs/nginx.pid.oldbin`</span><br></pre></td></tr></table></figure>

<h5 id="验证nginx是否升级成功"><a href="#验证nginx是否升级成功" class="headerlink" title="验证nginx是否升级成功"></a>验证nginx是否升级成功</h5><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/opt/nginx/sbin/nginx -V</span><br></pre></td></tr></table></figure>
<p>出现如下图结果则表示重新编译成功<br><img src="https://img.yangrunwei.com/article-img/20160226/96f9ca7d-37b4-42ca-a3e0-c0634a8830d6--34-2.png" alt="nginw-v" title="nginw-v"></p>
<h2 id="若新版nginx有异常，需要回滚到旧版"><a href="#若新版nginx有异常，需要回滚到旧版" class="headerlink" title="若新版nginx有异常，需要回滚到旧版"></a>若新版nginx有异常，需要回滚到旧版</h2><p>在旧版进程还在的时候，执行如下命令</p>
<h6 id="1、不加载配置启用旧版进程，重新接收请求"><a href="#1、不加载配置启用旧版进程，重新接收请求" class="headerlink" title="1、不加载配置启用旧版进程，重新接收请求"></a>1、不加载配置启用旧版进程，重新接收请求</h6><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kill -s HUP `cat /opt/nginx/logs/nginx.oldbin`</span><br></pre></td></tr></table></figure>
<h6 id="2、关闭新版nginx进程"><a href="#2、关闭新版nginx进程" class="headerlink" title="2、关闭新版nginx进程"></a>2、关闭新版nginx进程</h6><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kill -s QUIT `cat /opt/nginx/logs/nginx.pid`</span><br></pre></td></tr></table></figure>


<h2 id="注意"><a href="#注意" class="headerlink" title="注意"></a>注意</h2><p>如果升级后出现改变nginx配置文件不生效的话，可以尝试停止nginx再启动。请看<a target="_blank" rel="noopener" href="https://www.yangrunwei.com/a/33.html">停止及启动nginx方法</a></p>
</div><hr></div><div class="recent-post-item article-container"><a class="article-title" href="/a/33.html">nginx的启动、重启及停止</a><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2016-02-26</time><span class="article-meta"><span class="article-meta__separator">|</span><i class="fa fa-inbox article-meta__icon" aria-hidden="true"></i><a class="article-meta__categories" href="/categories/tech/">tech</a></span><span class="article-meta tags"><span class="article-meta__separator">|</span><i class="fa fa-tag article-meta__icon" aria-hidden="true"></i><a class="article-meta__tags" href="/tags/nginx/">nginx</a></span><div class="content"><h2 id="启动"><a href="#启动" class="headerlink" title="启动"></a>启动</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./nginx</span><br></pre></td></tr></table></figure>

<h2 id="重启"><a href="#重启" class="headerlink" title="重启"></a>重启</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./nginx -s reload</span><br></pre></td></tr></table></figure>

<h2 id="停止"><a href="#停止" class="headerlink" title="停止"></a>停止</h2><h5 id="方法1："><a href="#方法1：" class="headerlink" title="方法1："></a>方法1：</h5><p>查看nginx主进程号</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ps -ef | grep nginx</span><br></pre></td></tr></table></figure>
<p>master进程则为主进程，它的编号就是主进程号，如图：</p>
<p><img src="https://img.yangrunwei.com/article-img/20160226/feeff68c-0ff2-4935-b8dc-38906e39f12b--33-1.png" alt="查看nginx进程" title="查看nginx进程"></p>
<p>然后执行下面命令停止nginx</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kill -QUIT 1215</span><br></pre></td></tr></table></figure>
</div><hr></div><div class="recent-post-item article-container"><a class="article-title" href="/a/32.html">修改git远程仓库地址</a><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2016-02-26</time><span class="article-meta"><span class="article-meta__separator">|</span><i class="fa fa-inbox article-meta__icon" aria-hidden="true"></i><a class="article-meta__categories" href="/categories/tech/">tech</a></span><span class="article-meta tags"><span class="article-meta__separator">|</span><i class="fa fa-tag article-meta__icon" aria-hidden="true"></i><a class="article-meta__tags" href="/tags/git/">git</a></span><div class="content"><p>有时候我们在项目开发中途需要对项目远程仓库地址进行修改，git可以帮我们做到。</p>
<h2 id="修改远程仓库"><a href="#修改远程仓库" class="headerlink" title="修改远程仓库"></a>修改远程仓库</h2><p>方法：</p>
<blockquote>
<p>git remote set-url origin 仓库地址</p>
</blockquote>
<p>示例：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git remote set-url origin git@git.coding.net:glowry/wechat-server.git</span><br></pre></td></tr></table></figure>

<h2 id="查看结果"><a href="#查看结果" class="headerlink" title="查看结果"></a>查看结果</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git remote -v</span><br></pre></td></tr></table></figure>
</div><hr></div><div class="recent-post-item article-container"><a class="article-title" href="/a/35.html">nginx + Let's Encrypt + acme-tiny = https证书</a><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2016-02-26</time><span class="article-meta"><span class="article-meta__separator">|</span><i class="fa fa-inbox article-meta__icon" aria-hidden="true"></i><a class="article-meta__categories" href="/categories/tech/">tech</a></span><span class="article-meta tags"><span class="article-meta__separator">|</span><i class="fa fa-tag article-meta__icon" aria-hidden="true"></i><a class="article-meta__tags" href="/tags/qianlizhixing/">qianlizhixing</a><span class="article-meta__link">-</span><i class="fa fa-tag article-meta__icon" aria-hidden="true"></i><a class="article-meta__tags" href="/tags/nginx/">nginx</a></span><div class="content"><p><a target="_blank" rel="noopener" href="https://letsencrypt.org/">Let’s Encrypt</a> 项目旨在让每个网站都能使用 HTTPS 加密，该项目获得了 Mozilla、思科、Akamai、IdenTrust 和 EFF 等组织的支持， 由 Linux 基金会托管。<br><a target="_blank" rel="noopener" href="https://github.com/diafygi/acme-tiny">acme-tiny</a>可以方便我们创建及定期更新证书的小工具。</p>
<h2 id="准备工作"><a href="#准备工作" class="headerlink" title="准备工作"></a>准备工作</h2><h3 id="nginx支持ssl"><a href="#nginx支持ssl" class="headerlink" title="nginx支持ssl"></a>nginx支持ssl</h3><p>nginx必须有http_ssl_module，可通过nginx -V来查看。如果当初编译nginx时没有加入这个模块，则需要重新编译。可参考<a target="_blank" rel="noopener" href="https://www.yangrunwei.com/a/34.html">重新编译nginx</a>。</p>
<h2 id="生成网站证书"><a href="#生成网站证书" class="headerlink" title="生成网站证书"></a>生成网站证书</h2><p>下面内容主要参考<a target="_blank" rel="noopener" href="https://imququ.com/post/letsencrypt-certificate.html">Jerry Qu的小站文章</a>。本站的https也是主要参考它来做的。</p>
<h5 id="创建帐号"><a href="#创建帐号" class="headerlink" title="创建帐号"></a>创建帐号</h5><p>首先创建一个目录，例如 ssl，用来存放各种临时文件和最后的证书文件。进入这个目录，创建一个 RSA 私钥用于 Let’s Encrypt 识别你的身份：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">openssl genrsa 4096 &gt; account.key</span><br></pre></td></tr></table></figure>
<h5 id="配置验证服务"><a href="#配置验证服务" class="headerlink" title="配置验证服务"></a>配置验证服务</h5><p>我们知道，CA 在签发 DV（Domain Validation）证书时，需要验证域名所有权。传统 CA 的验证方式一般是往 <a href="mailto:&#97;&#100;&#109;&#x69;&#110;&#64;&#x79;&#x6f;&#117;&#114;&#x73;&#105;&#x74;&#x65;&#46;&#x63;&#x6f;&#x6d;">&#97;&#100;&#109;&#x69;&#110;&#64;&#x79;&#x6f;&#117;&#114;&#x73;&#105;&#x74;&#x65;&#46;&#x63;&#x6f;&#x6d;</a> 发验证邮件，而 Let’s Encrypt 是在你的服务器上生成一个随机验证文件，再通过创建 CSR 时指定的域名访问，如果可以访问则表明你对这个域名有控制权。<br>首先创建用于存放验证文件的目录，例如：<br>mkdir ~&#x2F;www&#x2F;challenges&#x2F;<br>在nginx上为上面指定的域名配置 HTTP 服务，以static.yangrunwei.com为例：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">server &#123;</span><br><span class="line">	listen 80;</span><br><span class="line">    server_name static.yangrunwei.com;</span><br><span class="line"></span><br><span class="line">    location ^~ /.well-known/acme-challenge/ &#123;</span><br><span class="line">        alias /home/xxx/www/challenges/;</span><br><span class="line">        try_files $uri =404;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    location / &#123;</span><br><span class="line">        rewrite ^/(.*)$ https://static.yangrunwei.com/$1 permanent;</span><br><span class="line">    &#125;</span><br><span class="line">	</span><br><span class="line">	...the rest of your config</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>以上配置优先查找 ~&#x2F;www&#x2F;challenges&#x2F; 目录下的文件，如果找不到就重定向到 HTTPS 地址。这个验证服务以后更新证书还要用到，需要一直保留。<br>重启nginx使配置生效（如果不知道怎样重启，可参考<a target="_blank" rel="noopener" href="https://www.yangrunwei.com/a/33.html">本文</a>）。</p>
<h5 id="创建-CSR-文件"><a href="#创建-CSR-文件" class="headerlink" title="创建 CSR 文件"></a>创建 CSR 文件</h5><p>接着就可以生成 CSR（Certificate Signing Request，证书签名请求）文件了。<br>首先，在之前的目录下再创建一个域名私钥（一定不要使用上面的账户私钥）：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">openssl genrsa 4096 &gt; domain.key</span><br></pre></td></tr></table></figure>
<p>如果要签发 ECC 证书，请使用以下任一命令生成 domain.key（我做的时候是没有生成ECC证书的）：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">#secp256r1</span><br><span class="line">openssl ecparam -genkey -name secp256r1 | openssl ec -out domain.key</span><br><span class="line"></span><br><span class="line">#secp384r1</span><br><span class="line">openssl ecparam -genkey -name secp384r1 | openssl ec -out domain.key</span><br></pre></td></tr></table></figure>

<p>然后就可以生成 CSR 文件了。推荐至少把域名带 www 和不带 www 的两种情况都加进去，其它子域可以根据需要添加（目前一张证书最多可以包含 100 个域名）：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">openssl req -new -sha256 -key domain.key -subj &quot;/&quot; -reqexts SAN -config &lt;(cat /etc/ssl/openssl.cnf &lt;(printf &quot;[SAN]\nsubjectAltName=DNS:yangrunwei.com,DNS:www.yangrunwei.com,DNS:static.yangrunwei.com,DNS:img.yangrunwei.com&quot;)) &gt; domain.csr</span><br></pre></td></tr></table></figure>
<p>执行这一步时，如果提示找不到 &#x2F;etc&#x2F;ssl&#x2F;openssl.cnf 文件，应该是没有安装 openssl 库。</p>
<p>执行的效果图如下：<br><img src="https://img.yangrunwei.com/article-img/20160227/3200eac7-8873-4d22-9dc1-f6da6220acec--35-1.png" alt="配置验证服务效果图" title="效果图"></p>
<h5 id="获取网站证书"><a href="#获取网站证书" class="headerlink" title="获取网站证书"></a>获取网站证书</h5><p>下载 acme-tiny 脚本保存到之前的 ssl 目录：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wget https://raw.githubusercontent.com/diafygi/acme-tiny/master/acme_tiny.py</span><br></pre></td></tr></table></figure>
<p>指定账户私钥、CSR 以及验证目录，执行脚本：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python acme_tiny.py --account-key ./account.key --csr ./domain.csr --acme-dir ~/www/challenges/ &gt; ./signed.crt</span><br></pre></td></tr></table></figure>
<p>如果一切正常，当前目录下就会生成一个 signed.crt，这就是申请好的证书文件。<br>如果出现如下问题，则表示需要更换DNS，最好是国外的。</p>
<blockquote>
<p>ValueError: Wrote file to &#x2F;home&#x2F;xxx&#x2F;www&#x2F;challenges&#x2F;oJbvpIhkwkBGBAQUklWJXyC8VbWAdQqlgpwUJkgC1Vg, but couldn’t download <a target="_blank" rel="noopener" href="http://www.yoursite.com/.well-known/acme-challenge/oJbvpIhkwkBGBAQUklWJXyC8VbWAdQqlgpwUJkgC1Vg">http://www.yoursite.com/.well-known/acme-challenge/oJbvpIhkwkBGBAQUklWJXyC8VbWAdQqlgpwUJkgC1Vg</a></p>
</blockquote>
<p>本站用的是阿里云的服务器及其DNS解析，没有出现上述问题。</p>
<p>搞定网站证书后，还要下载 Let’s Encrypt 的中间证书。配置 HTTPS 证书时既不要漏掉中间证书，也不要包含根证书。在 Nginx 配置中，需要把中间证书和网站证书合在一起：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">wget -O - https://letsencrypt.org/certs/lets-encrypt-x1-cross-signed.pem &gt; intermediate.pem</span><br><span class="line">cat signed.crt intermediate.pem &gt; chained.pem</span><br></pre></td></tr></table></figure>
<p>最终，修改 Nginx 中有关证书的配置并重启服务即可。最终配置，以static.yangrunwei.com为例，如下</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">server &#123;</span><br><span class="line">    listen 443;</span><br><span class="line">    server_name static.yangrunwei.com;</span><br><span class="line">	</span><br><span class="line">    ssl on;</span><br><span class="line">    ssl_certificate /home/xxx/www/ssl/chained.pem;</span><br><span class="line">    ssl_certificate_key /home/xxx/www/ssl/domain.key;</span><br><span class="line">	</span><br><span class="line">	...the rest of your config</span><br><span class="line">&#125;</span><br><span class="line">server &#123;</span><br><span class="line">	listen 80;</span><br><span class="line">    server_name static.yangrunwei.com;</span><br><span class="line"></span><br><span class="line">    location ^~ /.well-known/acme-challenge/ &#123;</span><br><span class="line">        alias /home/xxx/www/challenges/;</span><br><span class="line">        try_files $uri =404;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    location / &#123;</span><br><span class="line">        rewrite ^/(.*)$ https://static.yangrunwei.com/$1 permanent;</span><br><span class="line">    &#125;</span><br><span class="line">	</span><br><span class="line">	...the rest of your config</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="配置阿里云OSS存储https"><a href="#配置阿里云OSS存储https" class="headerlink" title="配置阿里云OSS存储https"></a>配置阿里云OSS存储https</h2><p>因为本站图片资源放在阿里云的OSS存储上，所以img.yangrunwei.com CNAME到了阿里云的内容服务器上。由于阿里云OSS存储暂时不支持上传https证书，所以我只能通过nginx反向代理来做img.yangrunwei.com的https证书了。</p>
<h5 id="配置域名解析"><a href="#配置域名解析" class="headerlink" title="配置域名解析"></a>配置域名解析</h5><p>首先得配置img.yangrunwei.com A记录到自己的nginx服务器上。可以在DNS解析上修改，并且这个解析很快就可以生效（一般几分钟）。</p>
<h5 id="配置nginx反向代理"><a href="#配置nginx反向代理" class="headerlink" title="配置nginx反向代理"></a>配置nginx反向代理</h5><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">server &#123;</span><br><span class="line">    listen 443;</span><br><span class="line">    server_name img.yangrunwei.com;</span><br><span class="line"></span><br><span class="line">    ssl on;</span><br><span class="line">    ssl_certificate /home/xxx/www/ssl/chained.pem;</span><br><span class="line">    ssl_certificate_key /home/xxx/www/ssl/domain.key;</span><br><span class="line"></span><br><span class="line">    location ~ ^/ &#123;</span><br><span class="line">        proxy_set_header  Referer 防盗链域名;</span><br><span class="line">        proxy_pass OSS外网或内网域名;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">server &#123;</span><br><span class="line">    listen 80;</span><br><span class="line">    server_name img.yangrunwei.com;</span><br><span class="line"></span><br><span class="line">    location ^~ /.well-known/acme-challenge/ &#123;</span><br><span class="line">        alias /home/xxx/www/challenges/;</span><br><span class="line">        try_files $uri =404;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>注：如果你在OSS存储上设置了防盗链，必须在代理时加上referer，不然请求会403；代理的域名可选择OSS外网或内网域名，如果选择内网，则必须nginx服务器与OSS存储的服务在同一区域；这样做有一个很大的缺陷，就会nginx服务器压力会增大，因为原来的图片请求都要通过它来转发，而且无法做图片CDN（如果你有CDN，可以在CDN上传证书来解决）。</p>
<h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><p><a target="_blank" rel="noopener" href="https://imququ.com/post/letsencrypt-certificate.html">Let’s Encrypt，免费好用的 HTTPS 证书</a><br><a target="_blank" rel="noopener" href="https://github.com/diafygi/acme-tiny">acme-tiny</a><br><a target="_blank" rel="noopener" href="https://help.aliyun.com/knowledge_detail/6936834.html?pos=1">oss通过反向代理配置自己域名的https</a></p>
</div><hr></div><nav id="pagination"><div class="pagination"><a class="extend prev" rel="prev" href="/page/9/"><i class="fa fa-chevron-left"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/9/">9</a><span class="page-number current">10</span><a class="page-number" href="/page/11/">11</a><span class="space">&hellip;</span><a class="page-number" href="/page/14/">14</a><a class="extend next" rel="next" href="/page/11/"><i class="fa fa-chevron-right"></i></a></div></nav></div></div><footer><div class="layout" id="footer"><div class="copyright">&copy;2015 - 2022 By 杨润炜</div><div class="framework-info"><span>Driven - </span><a target="_blank" rel="noopener" href="http://hexo.io"><span>Hexo</span></a><span class="footer-separator">|</span><span>Theme - </span><a target="_blank" rel="noopener" href="https://github.com/Molunerfinn/hexo-theme-melody"><span>Melody</span></a></div><div class="busuanzi"><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><span id="busuanzi_container_site_uv"><i class="fa fa-user"></i><span id="busuanzi_value_site_uv"></span><span></span></span><span class="footer-separator">|</span><span id="busuanzi_container_site_pv"><i class="fa fa-eye"></i><span id="busuanzi_value_site_pv"></span><span></span></span></div></div></footer><i class="fa fa-arrow-up" id="go-up" aria-hidden="true"></i><script src="https://cdn.jsdelivr.net/npm/animejs@latest/anime.min.js"></script><script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-animate@latest/velocity.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-ui-pack@latest/velocity.ui.min.js"></script><script src="/js/utils.js?version=1.9.0"></script><script src="/js/fancybox.js?version=1.9.0"></script><script src="/js/sidebar.js?version=1.9.0"></script><script src="/js/copy.js?version=1.9.0"></script><script src="/js/fireworks.js?version=1.9.0"></script><script src="/js/transition.js?version=1.9.0"></script><script src="/js/scroll.js?version=1.9.0"></script><script src="/js/head.js?version=1.9.0"></script><script>if(/Android|webOS|iPhone|iPod|iPad|BlackBerry/i.test(navigator.userAgent)) {
  $('#nav').addClass('is-mobile')
  $('footer').addClass('is-mobile')
  $('#top-container').addClass('is-mobile')
}</script></body></html>